// (c) 2013,2014 Elmyra UG
function to_list(e){return _.isArray(e)&&e||[e]}function indicate_activity(e){e?($("#idler").hide(),$("#spinner").show()):($("#spinner").hide(),$("#idler").show())}function basket_add(e){var t=$("#basket").val();_.string.include(t,e)||""==t||_.string.endsWith(t,"\n")||(t+="\n"),t+=e+"\n",$("#basket").val(t),basket_update_ui_entry(e)}function basket_remove(e){var t=$("#basket").val();_.string.include(t,e)&&(t=t.replace(e+"\n","")),$("#basket").val(t),basket_update_ui_entry(e)}function basket_update_ui_entry(e){var t=$("#basket").val(),n=$("#chk-patent-number-"+e),i=$("#add-patent-number-"+e),a=$("#remove-patent-number-"+e);_.string.include(t,e)?(n&&n.prop("checked",!0),i&&i.hide(),a&&a.show()):(n&&n.prop("checked",!1),i&&i.show(),a&&a.hide())}function pdf_display(e,t,n){var i=new PDFObject({url:t+"?page="+n,id:"myPDF",pdfOpenParams:{navpanes:0,toolbar:0,statusbar:0,view:"FitB"}});i.embed(e)}function pdf_set_headline(e,t){var n=e+" Page "+t;$(".modal-header #ops-pdf-modal-label").empty().append(n)}function listview_bind_actions(){$(".chk-patent-number").click(function(){var e=this.value;this.checked&&basket_add(e),this.checked||basket_remove(e)}),$(".add-patent-number").click(function(){var e=$(this).data("patent-number");basket_add(e)}),$(".remove-patent-number").click(function(){var e=$(this).data("patent-number");basket_remove(e)}),$(".abstract").shorten({showChars:2e3,moreText:"more",lessText:"less"}),$(".add-patent-number").popover(),$(".remove-patent-number").popover(),$(".btn-popover").popover(),$(".inid-tooltip").tooltip(),$(".pdf-open").click(function(){var e=$(this).data("patent-number"),t=$(this).data("pdf-url"),n=1;pdf_set_headline(e,n),pdf_display("pdf",t,n),$("#pdf-previous").unbind(),$("#pdf-previous").click(function(){1!=n&&(n-=1,pdf_set_headline(e,n),pdf_display("pdf",t,n))}),$("#pdf-next").unbind(),$("#pdf-next").click(function(){n+=1,pdf_set_headline(e,n),pdf_display("pdf",t,n)})}),$(".query-link").click(function(e){e.preventDefault();var t=$(this).data("query-attribute"),n=$(this).data("query-value"),i=t+"="+n;opsChooserApp.send_query(i)}),$(".drawings-carousel").carousel({interval:null}),$(".drawings-carousel").bind("slid",function(){var e=$(this).closest(".ops-collection-entry"),t=$(this).data("carousel").getActiveIndex()+1;e.find(".drawing-number").text(t);var n=e.find(".drawings-carousel"),i=n.data("totalcount");i&&e.find(".drawing-totalcount").text("/"+i)});var e=$(".drawings-carousel .carousel-control.right");e.click(function(){var e=$(this).closest(".ops-collection-entry").find(".drawings-carousel"),t=e.find(".carousel-inner"),n=t.find("div.active").index()+1,i=t.find("div").length;if(n==i){var a=e.data("totalcount");if(!a){a=1;var r=e.closest(".ops-collection-entry").data("document-number");if(!r)return void console.warn("document-number could not be found, won't proceed loading items into carousel");var o=_.template("/api/ops/<%= patent %>/image/info")({patent:r});$.ajax({url:o,async:!1}).success(function(e){a=e.META["drawing-total-count"]}).error(function(e){console.warn("Error while fetching drawing count: "+e)}),e.data("totalcount",a)}if(a&&!(i>=a)){var c=$(t).children(":first").clone(),l=$(t).height();$(c).removeClass("active");var s=$(c).children("img"),d=s.attr("src").replace(/\?page=.*/,"");d+="?page="+(n+1),s.attr("src",d),$(c).attr("min-height",l),$(c).height(l),$(t).append(c)}}});var t=$(".drawings-carousel").find("img");t.error(function(){$(this).hide();var e='<br/><blockquote class="text-center" style="min-height: 300px"><br/><br/><br/><br/><br/><br/>No image</blockquote>';$(this).closest(".carousel").hide().parent().find(".drawing-info").html(e)}),$(".embed-item").each(function(e,t){var n=$(t).data("embed-url"),i=$(t).data("document-number");if(n){var a=_.template(n,null,{interpolate:/\{\{(.+?)\}\}/g}),r=a({publication_number:i}),o='<iframe src="'+r+'" class="container-fluid well" seamless="seamless" height2="200" width2="100%" style="min-height: 50%; min-width: 80%"/>';$(this).append(o)}})}function cql_field_chooser_text(e,t,n){var i=_.template($("#cql-field-chooser-entry").html());t=t.map(function(e){return e+"="});var a=i({label:e,fields:t,more:n});return a}OpsChooserApp=Backbone.Marionette.Application.extend({perform_search:function(e){var t=$("#query").val();_.isEmpty(t)||(e&&e.range?opsChooserApp.search.perform(this.documents,this.metadata,t,e.range):opsChooserApp.search.perform(this.documents,this.metadata,t))},send_query:function(e,t){e&&($("#query").val(e),opsChooserApp.perform_search(t),$(window).scrollTop(0))}}),opsChooserApp=new OpsChooserApp,opsChooserApp.addRegions({listRegion:"#ops-collection-region",paginationRegionTop:"#ops-pagination-region-top",paginationRegionBottom:"#ops-pagination-region-bottom"}),OpsPublishedDataSearch=Backbone.Model.extend({url:"/api/ops/published-data/search",perform:function(e,t,n,i){e.reset(),$(".pager-area").hide(),indicate_activity(!0);this.fetch({data:$.param({query:n,range:i}),success:function(n){indicate_activity(!1),$("#alert-area").empty(),$(".pager-area").show(),console.log("payload data:"),console.log(n.attributes);var i,a=n.attributes["ops:world-patent-data"]["ops:biblio-search"]["ops:search-result"];if(a){var r=to_list(a["exchange-documents"]);i=_.map(r,function(e){return new OpsExchangeDocument(e["exchange-document"])})}e.reset(i);var o=n.attributes["ops:world-patent-data"]["ops:biblio-search"],c=o["@total-result-count"],l=o["ops:range"],s=l["@begin"]+"-"+l["@end"],d=o["ops:query"].$;t.set({result_count:c,result_range:s,query_real:d}),listview_bind_actions()},error:function(t,n){indicate_activity(!1),$("#alert-area").empty(),e.reset(),response=jQuery.parseJSON(n.responseText),"error"==response.status&&(_.each(response.errors,function(e){var t=_.template($("#backend-error-template").html()),n=t(e);$("#alert-area").append(n)}),$(".very-short").shorten({showChars:0,moreText:"more",lessText:"less"}))}})}}),OpsExchangeMetadata=Backbone.Model.extend({defaults:{result_count:null,result_range:null,query_real:null}}),OpsExchangeDocument=Backbone.Model.extend({defaults:{selected:!1,get_patent_number:function(){return this["@country"]+this["@doc-number"]+this["@kind"]},get_application_number:function(e){var t=this["bibliographic-data"]["application-reference"]["document-id"];for(i in t){var n=t[i];if("docdb"==e&&"docdb"==n["@document-id-type"])return n.country.$+n["doc-number"].$;if("original"==e&&"original"==n["@document-id-type"])return n["doc-number"].$}},get_applicants:function(e){try{var t=this["bibliographic-data"].parties.applicants}catch(n){return[]}t=t||[];var i=t.applicant,a=this.parties_to_list(i,"applicant-name");return e&&(a=this.enrich_links(a,"applicant")),a},get_inventors:function(e){try{var t=this["bibliographic-data"].parties.inventors}catch(n){return[]}t=t||[];var i=t.inventor,a=this.parties_to_list(i,"inventor-name");return e&&(a=this.enrich_links(a,"inventor")),a},parties_to_list:function(e,t){var n="0",i={};_.each(e,function(e){var a=e["@data-format"],r=e["@sequence"],o=_.string.trim(e[t].name.$,", ");i[a]=i[a]||{},i[a][r]=o,r>n&&(n=r)});var a=[];return _.each(_.range(1,parseInt(n)+1),function(e){e=e.toString();var t=(i.epodoc[e],i.original[e]);a.push(t)}),a},get_ipc_list:function(e){var t=[],n=this["bibliographic-data"]["classifications-ipcr"];if(n){var i=to_list(n["classification-ipcr"]);t=_.map(i,function(e){return e.text.$})}return e&&(t=this.enrich_links(t,"ipc",function(e){return e.substring(0,15).replace(/ /g,"")})),t},enrich_links:function(e,t,n){var i=this;return _.map(e,function(e){return i.enrich_link(e,t,e,n)})},enrich_link:function(e,t,n,i){var a="external",r="_blank",o=null;n||(n=e),i&&(n=i(n)),_.string.include(n," ")&&(n='"'+n+'"');var c;if("internal"==a?c=_.template('<a class="query-link" href="" data-query-attribute="<%= attribute %>" data-query-value="<%= value %>"><%= label %></a>'):"external"==a&&(o=encodeURIComponent(t+"="+n),c=_.template('<a href="?query=<%= query %>" target="<%= target %>" class="incognito"><%= label %></a>')),c){var l=c({label:e,attribute:t,value:n,target:r,query:o});return l}},_find_document_number:function(e,t){for(i in e){var n=e[i];if(n["@document-id-type"]==t){var a=(n.country?n.country.$:"")+(n["doc-number"]?n["doc-number"].$:"")+(n.kind?n.kind.$:"");return a}}},get_patent_citation_list:function(e){var t=this,n=[],i=this["bibliographic-data"]["references-cited"];if(i){var a=to_list(i.citation);n=a.filter(function(e){return e.patcit}).map(function(e){return t._find_document_number(e.patcit["document-id"],"docdb")})}return e&&(n=this.enrich_links(n,"pn")),n},_expand_links:function(e){var t=/(http|ftp|https):\/\/[\w-]+(\.[\w-]+)+([\w.,@?^=%&amp;:\/~+#-]*[\w@?^=%&amp;\/~+#-])?/g;return _(e.match(t)).each(function(t){e=e.replace(t,'<a href="'+t+'" target="_blank">'+t+"</a>")}),e},get_npl_citation_list:function(){var e=this,t=[],n=this["bibliographic-data"]["references-cited"];if(n){var i=to_list(n.citation);t=i.filter(function(e){return e.nplcit}).map(function(e){return e.nplcit.text.$}).map(e._expand_links)}return t},get_drawing_url:function(){var e=_.template("/api/ops/<%= patent_number %>/image/drawing"),t=e({patent_number:this.get_patent_number()});return t},get_fullimage_url:function(){var e=_.template("/api/ops/<%= patent_number %>/image/full"),t=e({patent_number:this.get_patent_number()});return t},get_espacenet_pdf_url:function(){var e=_.template("http://worldwide.espacenet.com/espacenetDocument.pdf?flavour=trueFull&FT=D&CC=<%= country %>&NR=<%= docnumber %><%= kind %>&KC=<%= kind %>"),t=e({country:this["@country"],docnumber:this["@doc-number"],kind:this["@kind"]});return t},get_ops_pdf_url:function(){var e=_.template("/api/ops/<%= country %><%= docnumber %><%= kind %>/pdf/all"),t=e({country:this["@country"],docnumber:this["@doc-number"],kind:this["@kind"]});return t},get_epo_register_url:function(){var e=_.template("https://register.epo.org/application?number=<%= application_number %>"),t=e({application_number:this.get_application_number("docdb")});return t},get_inpadoc_legal_url:function(){var e=_.template("http://worldwide.espacenet.com/publicationDetails/inpadoc?FT=D&CC=<%= country %>&NR=<%= docnumber %><%= kind %>&KC=<%= kind %>"),t=e({country:this["@country"],docnumber:this["@doc-number"],kind:this["@kind"]});return t},get_dpma_register_url:function(){var e=_.template("/jump/dpma/register?pn=<%= application_number %>"),t=e({application_number:this.get_application_number("docdb")});return t},get_uspto_pair_url:function(){var e=_.template("http://portal.uspto.gov/pair/PublicPair"),t=e({country:this["@country"],docnumber:this["@doc-number"],kind:this["@kind"]});return t},get_inpadoc_family_url:function(){var e=_.template("http://worldwide.espacenet.com/publicationDetails/inpadocPatentFamily?FT=D&CC=<%= country %>&NR=<%= docnumber %><%= kind %>&KC=<%= kind %>"),t=e({country:this["@country"],docnumber:this["@doc-number"],kind:this["@kind"]});return t},get_ops_family_url:function(){var e=_.template("http://ops.epo.org/3.0/rest-services/family/publication/docdb/<%= country %>.<%= docnumber %>.<%= kind %>/biblio,legal"),t=e({country:this["@country"],docnumber:this["@doc-number"],kind:this["@kind"]});return t}},select:function(){this.set("selected",!0)},unselect:function(){this.set("selected",!1)}}),OpsExchangeDocumentCollection=Backbone.Collection.extend({model:OpsExchangeDocument,initialize:function(){}}),OpsExchangeDocumentView=Backbone.Marionette.ItemView.extend({template:_.template($("#ops-entry-template").html(),this.model,{variable:"data"}),tagName:"div",className:"row-fluid",events:{"click .rank_up img":"rankUp","click .rank_down img":"rankDown","click a.disqualify":"disqualify"},onDomRefresh:function(){var e=this.model.attributes.get_patent_number();basket_update_ui_entry(e)}}),OpsExchangeDocumentCollectionView=Backbone.Marionette.CompositeView.extend({tagName:"div",id:"opsexchangedocumentcollection",className:"container",template:"#ops-collection-template",itemView:OpsExchangeDocumentView,appendHtml:function(e,t){$(e.el).append(t.el)}}),PaginationView=Backbone.Marionette.ItemView.extend({tagName:"div",template:"#ops-pagination-template",initialize:function(){this.listenTo(this.model,"change",this.render)},onDomRefresh:function(){$(this.el).find("div.pagination a").click(function(){var e=($(this).attr("action"),$(this).attr("range"));return opsChooserApp.perform_search({range:e}),!1})}}),opsChooserApp.addInitializer(function(){this.search=new OpsPublishedDataSearch,this.metadata=new OpsExchangeMetadata,this.documents=new OpsExchangeDocumentCollection}),opsChooserApp.addInitializer(function(){var e=new OpsExchangeDocumentCollectionView({collection:this.documents}),t=new PaginationView({model:this.metadata}),n=new PaginationView({model:this.metadata});opsChooserApp.listRegion.show(e),opsChooserApp.paginationRegionTop.show(t),opsChooserApp.paginationRegionBottom.show(n)}),opsChooserApp.addInitializer(function(){this.perform_search()}),$(document).ready(function(){console.log("OpsChooserApp starting"),opsChooserApp.start(),$(".pager-area").hide(),$(".btn-query-perform").click(function(){opsChooserApp.perform_search()}),$("#basket-review-button").click(function(){var e=$("#basket").val(),t=e.split("\n").filter(function(e){return e}).map(function(e){return"pn="+e}).join(" OR ");t&&($("#query").val(t),opsChooserApp.perform_search())}),$(".btn-popover").popover(),$(".very-short").shorten({showChars:5,moreText:"more",lessText:"less"}),$("#query").caret($("#query").val().length),$("#query").on("keydown",null,"meta+return",function(){opsChooserApp.perform_search()}),$("#query").on("paste",function(e){if(!$(this).val()){e.preventDefault();var t=(e.originalEvent||e).clipboardData.getData("text");$("#clipboard-modifier-chooser").modal("show"),$(".btn-clipboard-modifier").click(function(){var e=$(this).data("modifier"),n=$("#clipboard-modifier-operator").find(".btn.active").data("value")||"OR";$("#clipboard-modifier-chooser").modal("hide");var i=_(t.split("\n")).map(function(t){return e+"="+t}).join(" "+n+" ");$("#query").val(i),$("#query").focus()})}}),$("#btn-query-clear").click(function(){$("#query").val("").focus()}),$(".btn-cql-boolean").button(),$("#cql-quick-operator").find(".btn-cql-boolean").click(function(){$("#query").focus()}),$(".btn-cql-field").click(function(){var e,t=$("#query").val(),n=$("#cql-quick-operator").find(".btn-cql-boolean.active").data("value"),i=$(this).data("value"),a=$("#query").caret(),r=!1,o=!0;if(0!=a){r=!0,e=t.substring(a-1,a),"="==e&&(r=!1,o=!1);var c=t.substring(a-5,a).toLowerCase();(_.string.include(c,"and")||_.string.include(c,"or"))&&(r=!1)}var l=e&&" "!=e?" ":"";r&&$("#query").caret(l+n),o&&$("#query").caret((r?" ":l)+i),$("#query").focus()}),$("#cql-field-chooser").select2({data:{results:OPS_CQL_FIELDS},dropdownCssClass:"bigdrop",escapeMarkup:function(e){return e}}),$("#cql-field-chooser").on("change",function(){var e=$(this).val();if(e){var t=$("#query").val(),n=$("#query").caret(),i=t.substring(n-1,n);"="!=i&&(" "!=i&&0!=n&&(e=" "+e),$("#query").caret(e+"="),$(this).data("select2").clear())}})});var OPS_CQL_FIELDS=[{text:"<h4>Popular</h4>",children:[{id:"num",text:cql_field_chooser_text("Publication-, application- or<br/>priority number",["num"],"(10, 11, 21, 31)")},{id:"txt",text:cql_field_chooser_text("Title, abstract, inventor-, or applicant name",["txt"],"(54, 57, 72, 71, 73)")},{id:"cl",text:cql_field_chooser_text("CPC or IPC8 class",["cl"],"")}]},{text:"<h4>Publication</h4>",children:[{id:"pn",text:cql_field_chooser_text("Publication number",["pn","publicationnumber"],"(10, 11)")},{id:"pd",text:cql_field_chooser_text("Publication date",["pd","publicationdate"],"")},{id:"pa",text:cql_field_chooser_text("Applicant",["pa","applicant"],"(71, 73)")},{id:"in",text:cql_field_chooser_text("Inventor",["in","inventor"],"(72)")},{id:"ia",text:cql_field_chooser_text("Inventor or applicant",["ia","inventorandapplicant"],"(72, 71, 73)")},{id:"spn",text:cql_field_chooser_text("Publication number<br/><small>in epodoc format</small>",["spn"],"")}]},{text:"<h4>Text</h4>",children:[{id:"ti",text:cql_field_chooser_text("Title",["ti","title"],"(54)")},{id:"ab",text:cql_field_chooser_text("Abstract",["ab","abstract"],"(57)")},{id:"ta",text:cql_field_chooser_text("Title or abstract",["ta","titleandabstract"],"(54, 57)")},{id:"txt",text:cql_field_chooser_text("Title, abstract, inventor-, or applicant name",["txt"],"(54, 57, 72, 71, 73)")}]},{text:"<h4>Application, priority and family</h4>",children:[{id:"ap",text:cql_field_chooser_text("Application number",["ap","applicantnumber"],"(21)")},{id:"sap",text:cql_field_chooser_text("Application number<br/><small>in epodoc format</small>",["sap"],"")},{id:"pr",text:cql_field_chooser_text("Priority number",["pr","prioritynumber"],"(31)")},{id:"spr",text:cql_field_chooser_text("Priority number<br/><small>in epodoc format</small>",["spr"],"")},{id:"famn",text:cql_field_chooser_text("Family identifier (simple)",["famn"],"")}]},{text:"<h4>Classification</h4>",children:[{id:"cpc",text:cql_field_chooser_text("CPC classification<br/><small>(invention and additional)</small>",["cpc","cpci","cpca"],"")},{id:"ipc",text:cql_field_chooser_text("IPC8 class",["ipc","ic"],"")},{id:"ci",text:cql_field_chooser_text("IPC8 core invention class",["ci"],"")},{id:"cn",text:cql_field_chooser_text("IPC8 core additional class<br/><small>(non-invention)</small>",["cn"],"")},{id:"ai",text:cql_field_chooser_text("IPC8 advanced invention class",["ai"],"")},{id:"an",text:cql_field_chooser_text("IPC8 advanced additional class<br/><small>(non-invention)</small>",["an"],"")},{id:"a",text:cql_field_chooser_text("IPC8 advanced class",["a"],"")},{id:"c",text:cql_field_chooser_text("IPC8 core class",["c"],"")},{id:"cl",text:cql_field_chooser_text("CPC or IPC8 class",["cl"],"")}]},{text:"<h4>Citations</h4>",children:[{id:"ct",text:cql_field_chooser_text("Cited document number",["ct","citation"],"(56)")},{id:"ex",text:cql_field_chooser_text("Cited document number<br/><small>during examination</small>",["ex"],"")},{id:"op",text:cql_field_chooser_text("Cited document number<br/><small>during opposition</small>",["op"],"")},{id:"rf",text:cql_field_chooser_text("Cited document number<br/><small>provided by applicant</small>",["rf"],"")},{id:"oc",text:cql_field_chooser_text("Another cited document number",["oc"],"")}]}];
//# sourceMappingURL=/static/js/lib/ipsuite-search.min.map