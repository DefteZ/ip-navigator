// (c) 2013,2014 Elmyra UG - All rights reserved
function getconfig(e,t){t=t||{};var i=opsChooserApp.config.get(e);return i&&(t.before&&(i=t.before+i),t.after&&(i+=t.after)),i}function propagate_opaque_errors(){var e=opsChooserApp.config.get("opaque.meta.status");if("error"==e){var t=opsChooserApp.config.get("opaque.meta.errors");_.each(t,function(e){"JSON Web Token"==e.location&&"expired"==e.description&&(e.description="We are sorry, it looks like the validity time of this link has expired at "+e.jwt_expiry_iso+'.<br/><br/>Please contact us at <a href="mailto:support@elmyra.de">support@elmyra.de</a> for any commercial plans.'),"JSON Web Signature"==e.location&&(e.description="It looks like the token used to encode this request is invalid. ("+e.description+")");var t=_.template($("#cornice-error-template").html()),i=t(e);$("#alert-area").append(i)})}}function boot_application(){console.log("boot_application"),$("#query").val(opsChooserApp.config.get("query")),$("#ui-title").html(getconfig("setting.ui.page.title")),$("#ui-subtitle").html(getconfig("setting.ui.page.subtitle")),$("#ui-statusline").html(getconfig("setting.ui.page.statusline")),$("#ui-productname").html(getconfig("setting.ui.productname")),$("#ui-footer").html(getconfig("setting.ui.page.footer",{after:"<br/>"})),$("#ui-footer-version").html(getconfig("setting.ui.version",{after:"<br/>"}));var e=opsChooserApp.config.get("datasource");e&&opsChooserApp.set_datasource(e),opsChooserApp.listRegion.show(opsChooserApp.collectionView),opsChooserApp.ui.reset_content(),propagate_opaque_errors(),opsChooserApp.trigger("application:ready"),opsChooserApp.ui.do_element_visibility()}function cql_field_chooser_text(e,t,i){var o=_.template($("#cql-field-chooser-entry").html());t=t.map(function(e){return e+"="});var n=o({label:e,fields:t,more:i});return n}function to_list(e){return _.isArray(e)&&e||[e]}function now_iso(){return moment().format()}function now_iso_human(){return moment().format("YYYY-MM-DD HH:mm:ss")}function now_iso_filename(){return moment().format("YYYY-MM-DD_HH:mm:ss")}function today_iso(){return moment().format("YYYY-MM-DD")}function changeTooltipColorTo(e){$(".tooltip-inner").css("background-color",e),$(".tooltip.top .tooltip-arrow").css("border-top-color",e),$(".tooltip.right .tooltip-arrow").css("border-right-color",e),$(".tooltip.left .tooltip-arrow").css("border-left-color",e),$(".tooltip.bottom .tooltip-arrow").css("border-bottom-color",e)}function quotate(e){return'"'+e+'"'}function asbool(e){switch("string"==typeof e&&(e=e.trim().toLowerCase()),e){case!0:case"true":case 1:case"1":case"on":case"yes":return!0;default:return!1}}function dotresolve(e,t){for(t=t.split(".");e&&t[0];)e=e[t.shift()]||void 0;return e}function deferreds_bundle(e){var t=$.Deferred();return $.when.apply($,e).then(function(){t.resolve()}),t.promise()}function htmlentities(e,t,i,o){var n=this.get_html_translation_table("HTML_ENTITIES",t),r="";if(e=null==e?"":e+"",!n)return!1;if(t&&"ENT_QUOTES"===t&&(n["'"]="&#039;"),o||null==o)for(r in n)n.hasOwnProperty(r)&&(e=e.split(r).join(n[r]));else e=e.replace(/([\s\S]*?)(&(?:#\d+|#x[\da-f]+|[a-zA-Z][\da-z]*);|$)/g,function(e,t,i){for(r in n)n.hasOwnProperty(r)&&(t=t.split(r).join(n[r]));return t+i});return e}function get_html_translation_table(e,t){var i,o={},n={},r={},a={},s={},c={};if(r[0]="HTML_SPECIALCHARS",r[1]="HTML_ENTITIES",a[0]="ENT_NOQUOTES",a[2]="ENT_COMPAT",a[3]="ENT_QUOTES",s=isNaN(e)?e?e.toUpperCase():"HTML_SPECIALCHARS":r[e],c=isNaN(t)?t?t.toUpperCase():"ENT_COMPAT":a[t],"HTML_SPECIALCHARS"!==s&&"HTML_ENTITIES"!==s)throw new Error("Table: "+s+" not supported");o[38]="&amp;","HTML_ENTITIES"===s&&(o[160]="&nbsp;",o[161]="&iexcl;",o[162]="&cent;",o[163]="&pound;",o[164]="&curren;",o[165]="&yen;",o[166]="&brvbar;",o[167]="&sect;",o[168]="&uml;",o[169]="&copy;",o[170]="&ordf;",o[171]="&laquo;",o[172]="&not;",o[173]="&shy;",o[174]="&reg;",o[175]="&macr;",o[176]="&deg;",o[177]="&plusmn;",o[178]="&sup2;",o[179]="&sup3;",o[180]="&acute;",o[181]="&micro;",o[182]="&para;",o[183]="&middot;",o[184]="&cedil;",o[185]="&sup1;",o[186]="&ordm;",o[187]="&raquo;",o[188]="&frac14;",o[189]="&frac12;",o[190]="&frac34;",o[191]="&iquest;",o[192]="&Agrave;",o[193]="&Aacute;",o[194]="&Acirc;",o[195]="&Atilde;",o[196]="&Auml;",o[197]="&Aring;",o[198]="&AElig;",o[199]="&Ccedil;",o[200]="&Egrave;",o[201]="&Eacute;",o[202]="&Ecirc;",o[203]="&Euml;",o[204]="&Igrave;",o[205]="&Iacute;",o[206]="&Icirc;",o[207]="&Iuml;",o[208]="&ETH;",o[209]="&Ntilde;",o[210]="&Ograve;",o[211]="&Oacute;",o[212]="&Ocirc;",o[213]="&Otilde;",o[214]="&Ouml;",o[215]="&times;",o[216]="&Oslash;",o[217]="&Ugrave;",o[218]="&Uacute;",o[219]="&Ucirc;",o[220]="&Uuml;",o[221]="&Yacute;",o[222]="&THORN;",o[223]="&szlig;",o[224]="&agrave;",o[225]="&aacute;",o[226]="&acirc;",o[227]="&atilde;",o[228]="&auml;",o[229]="&aring;",o[230]="&aelig;",o[231]="&ccedil;",o[232]="&egrave;",o[233]="&eacute;",o[234]="&ecirc;",o[235]="&euml;",o[236]="&igrave;",o[237]="&iacute;",o[238]="&icirc;",o[239]="&iuml;",o[240]="&eth;",o[241]="&ntilde;",o[242]="&ograve;",o[243]="&oacute;",o[244]="&ocirc;",o[245]="&otilde;",o[246]="&ouml;",o[247]="&divide;",o[248]="&oslash;",o[249]="&ugrave;",o[250]="&uacute;",o[251]="&ucirc;",o[252]="&uuml;",o[253]="&yacute;",o[254]="&thorn;",o[255]="&yuml;"),"ENT_NOQUOTES"!==c&&(o[34]="&quot;"),"ENT_QUOTES"===c&&(o[39]="&#39;"),o[60]="&lt;",o[62]="&gt;";for(i in o)o.hasOwnProperty(i)&&(n[String.fromCharCode(i)]=o[i]);return n}function sortCollectionByField(e,t,i){e=e.clone();var o=e,n=function(e,t){return e=e.get(o.sort_key),t=t.get(o.sort_key),e>t?1:t>e?-1:0},r=function(e,t){return n(t,e)};return e.comparator=n,_.str.startsWith(i,"d")&&(e.comparator=r),e.sort_key=t,e.sort(),e}function opaquetoken(e){var t=$.Deferred();return $.ajax({method:"post",url:"/api/opaquelinks/token",async:!1,sync:!0,data:JSON.stringify(e),contentType:"application/json; charset=utf-8"}).success(function(e){e&&t.resolve(e)}).error(function(e){console.warn("Error while signing opaque parameters",e),t.reject(e)}),t.promise()}function opaquetoken_query(e){var t=$.Deferred();return opaquetoken(e).then(function(e){var i="op="+e;t.resolve(i)}),t.promise()}function opaque_param(e){return e=e||{},e.op?$.Deferred().resolve("op="+e.op):opaquetoken_query(e)}function make_modal_view(e,t,i){i=i||{};var o=new ModalRegion({el:"#modal-area"}),n={model:t};$.extend(n,i);var r=new e(n);o.show(r)}OpsChooserApp=Backbone.Marionette.Application.extend({get_datasource:function(){var e=$("#datasource > .btn.active").data("value");return e},set_datasource:function(e){$("#datasource .btn[data-value='"+e+"']").button("toggle"),this.queryBuilderView.cql_field_chooser_setup(),this.queryBuilderView.setup_comfort_form()},get_query:function(){return $("#query").val()},disable_reviewmode:function(){this.metadata.set("reviewmode",!1)},perform_search:function(e){e=e||{},e.datasource=i;var t=this.get_query(),i=this.get_datasource();this.metadata.set("datasource",i),this.metadata.resetSomeDefaults(e),e&&null!=e.reviewmode&&this.metadata.set("reviewmode",e.reviewmode);var o=this.metadata.get("reviewmode");if(1==o)return void this.basketModel.review(e);if(!_.isEmpty(t)){console.log("App.perform_search: datasource="+i,"query="+t,"options=",e),e.keywords=$("#keywords").val();var n={datasource:i,query:t};e.flavor&&(n.flavor=e.flavor),e.query_data&&(n.query_data=e.query_data);var r=this;if("ops"==i){var a=this.compute_range(e);this.trigger("search:before",_(n).extend({range:a})),opsChooserApp.search.perform(this.documents,this.metadata,t,a).done(function(){var e=r.metadata.get("result_count");e>r.metadata.get("maximum_results").ops&&r.ui.user_alert("Total hits: "+e+".    The first 2000 hits are accessible from OPS.  You can narrow your search by adding more search criteria.","warning"),r.metadata.set("keywords",opsChooserApp.search.keywords),r.trigger("results:ready")})}else if("depatisnet"==i){this.trigger("search:before",n),this.metadata.set("query_origin",t);var s=new DepatisnetSearch;s.perform(t,e).done(function(i){r.propagate_datasource_message(i),r.metadata.set("keywords",s.keywords),console.log("depatisnet response:",i);var o=i.numbers,n=i.hits;r.perform_listsearch(e,t,o,n,"pn","OR").done(function(){r.propagate_datasource_message(i)})})}else if("google"==i){this.trigger("search:before",n),this.metadata.set("query_origin",t);var c=new GooglePatentSearch;c.perform(t,e).done(function(i){e=e||{},r.propagate_datasource_message(i),r.metadata.set("keywords",c.keywords),console.log("google response:",i),console.log("google keywords:",c.keywords);var o=i.numbers,n=i.hits;o&&(e.remote_limit=100,r.perform_listsearch(e,t,o,n,"pn","OR").done(function(){r.propagate_datasource_message(i),null==n&&r.ui.user_alert("Result count unknown. At Google Patents, sometimes result counts are not displayed. Let's assume 1000 to make the paging work.","warning"),n>r.metadata.get("maximum_results").google&&r.ui.user_alert("Total results "+n+". From Google Patents, the first 1000 results are accessible. You might want to narrow your search by adding more search criteria.","warning")}))})}else if("ftpro"==i){this.trigger("search:before",n),this.metadata.set("query_origin",t);var l=new FulltextProSearch;l.perform(t,e).done(function(i){e=e||{},console.log("ftpro response:",i),r.propagate_datasource_message(i),r.metadata.set("keywords",l.keywords);var o=i.details,n=i.meta.MemCount;e.remote_limit=i.meta.Limit,r.perform_listsearch(e,t,o,n,"pn","OR").done(function(){r.propagate_datasource_message(i)})})}else this.ui.notify('Search provider "'+i+'" not implemented.',{type:"error",icon2:"icon-copy"})}},send_query:function(e,t){e&&($("#query").val(e),opsChooserApp.perform_search(t),$(window).scrollTop(0))},perform_listsearch:function(e,t,i,o,n,r){this.ui.indicate_activity(!1),this.ui.reset_content();var a=e&&e.range?e.range:"1-10",s=a.split("-"),c=parseInt(s[0])-1,l=parseInt(s[1]);if(e&&e.remote_limit&&(log("slice options.remote_limit:",e.remote_limit),c%=e.remote_limit,l%=e.remote_limit,0==l&&(l=e.remote_limit-1)),console.log("local slices:",c,l),i&&(0==i.length||c>i.length)){var u=$.Deferred();if(u.resolve(),_.isEmpty(t)&&_.isEmpty(i))return this.ui.reset_content({keep_pager:!1,documents:!0}),this.ui.user_alert("No results.","info"),u.promise()}var p=i.slice(c,l);if(!_.isEmpty(p)&&_.isObject(p[0]))try{this.results.reset(p)}catch(d){console.error("Problem propagating data to results collection",d)}else this.results.reset();var h=_(_.map(p,function(e){var t;return _.isObject(e)?t=e.publication_number:_.isEmpty(e)||(t=e),t?n+'="'+_.string.trim(t,'"')+'"':void 0})),m=h.join(" "+r+" ");console.log("OPS CQL query:",m),t||(t=m),this.metadata.set("page_size",10),this.metadata.set("searchmode","subsearch");var f=this;return this.search.perform(this.documents,this.metadata,m,"1-10").done(function(){f.metadata.set("query_origin",t),f.metadata.set("result_count",o),f.metadata.set("result_range",a),f.metadata.set("pagination_entry_count",17),$(".pagination").removeClass("span10"),$(".pagination").addClass("span12"),f.results.set_reference_document_numbers(f.documents.get_document_numbers()),f.trigger("results:ready")})},parse_numberlist:function(e){if(!_.isEmpty(e)){var t,i=e.split(/=/);1==i.length?(t="pn",e=i[0]):2==i.length&&(t=i[0],e=i[1]);var o=_(e.split(/[,\n]/)).map(function(e){return e.trim()}).filter(function(e){return!(_.isEmpty(e)||_.string.startsWith(e,"//")||_.string.startsWith(e,"#"))});return{data:o,fieldname:t}}},perform_numberlistsearch:function(e){var t=this.parse_numberlist($("#numberlist").val());if(t){var i=t.data,o=i.length;this.perform_listsearch(e,void 0,i,o,t.fieldname,"OR")}else this.ui.notify("An empty numberlist can't be requested, please add some publication numbers.",{type:"warning",icon:"icon-align-justify"})},compute_range:function(e){var t=this.metadata.get("page_size"),i="1-"+t,o=e&&e.range?e.range:i;return o},propagate_datasource_message:function(e){log("propagate_datasource_message"),this.ui.user_alert(e.message,"warning")},project_activate:function(e){var t=this;if(!e)return void console.error("project is null, will not activate");var i=e.get("name");console.log("App.project_activate:",i),this.project&&(this.stopListening(this.project),delete this.project),this.project=e,this.stopListening(this,"search:before"),this.listenTo(this,"search:before",function(t){e.record_query(t)}),$(window).off("focus",this.project_reload),$(window).on("focus",this.project_reload),this.projectChooserView&&this.projectChooserView.stopListening(),this.projectChooserView=new ProjectChooserView({el:$("#project-chooser-area"),model:e,collection:e.collection}),this.projectChooserView.render(),this.storage.setup_ui(),this.permalink.setup_ui(),$("#ui-project-name").html('Review for project "'+e.get("name")+'".'),$("#ui-project-dates").html("Created "+moment(e.get("created")).fromNow()+", modified "+moment(e.get("modified")).fromNow()+"."),$("#ui-opaquelink-expiry").html("Link expires "+moment(this.config.get("link_expires")).fromNow()+"."),this.config.set("project",e.get("name"));var o=e.get("basket");o.fetch({success:function(){$.when(o.fetch_entries()).then(function(){t.basket_activate(o)})},error:function(){t.basket_deactivate()}})},project_deactivate:function(){$(window).off("focus",this.project_reload)},project_reload:function(){var e=opsChooserApp.project.get("name");opsChooserApp.trigger("project:load",e)},basket_deactivate:function(){this.basketModel&&(this.stopListening(this.basketModel),delete this.basketModel),this.basketView&&(this.basketView.close(),this.stopListening(this.basketView),delete this.basketView)},basket_activate:function(e){return console.log("App.basket_activate"),e?(this.basket_deactivate(),this.basketModel=e,this.basketView=new BasketView({model:e}),this.basketRegion.show(this.basketView),this.stopListening(null,"change:add"),this.stopListening(null,"change:remove"),this.listenTo(e,"change:add",this.basketController.link_document),this.listenTo(e,"change:remove",this.basketController.link_document),this.listenTo(e,"change:rate",this.basketController.link_document),this.stopListening(null,"change"),this.listenTo(e,"change",function(){this.project.save()}),this.listenTo(e,"change:add",function(e,t){this.basketView.textarea_scroll_text(t)}),this.basketView.render(),this.basket_bind_actions(),void this.trigger("basket:activated",e)):void console.error("basket is null, will not activate")},basket_bind_actions:function(){var e=this;$(".add-patent-number").unbind("click"),$(".add-patent-number").click(function(){var t=$(this).data("patent-number");e.basketModel.add(t)}),$(".remove-patent-number").unbind("click"),$(".remove-patent-number").click(function(){var t=$(this).data("patent-number");e.basketModel.remove(t)}),$("#basket-add-all-documents").unbind("click"),$("#basket-add-all-documents").click(function(){e.documents.each(function(t){var i=t.attributes.get_patent_number();e.basketModel.add(i)})}),console.log("setup rating widget"),$(".rating-widget").raty({number:3,hints:["slightly relevant","relevant","important"],cancel:!0,cancelHint:"not relevant",dismissible:!0,path:"/static/widget/raty/img",action:function(t){var i=t.score,o=t.dismiss,n=$(this).data("document-number");e.document_rate(n,i,o)}}),this.documents.each(function(t){var i=t.attributes.get_patent_number();if(e.basketModel){var o=e.basketModel.get_entry_by_number(i);e.basketController.link_document(o,i)}else e.basketController.link_document(void 0,i)})},document_rate:function(e,t,i){var o=this;e&&this.basketModel.add(e).then(function(n){n.save({score:t,dismiss:i},{success:function(){o.basketModel.trigger("change:rate",n,e),o.basketView.textarea_scroll_text(e)},error:function(){console.error("rating save error",e,n)}})})},shutdown_gui:function(){this.basketModel&&this.basketModel.destroy(),this.basket_bind_actions(),this.basketView&&this.basketView.render(),this.comments.store.set(),this.projects.reset(),this.projectChooserView.clear()},user_has_module:function(e){var t=_(this.config.get("user.modules")).contains(e),i="localhost"==this.config.get("request.host_name");return t||i}}),opsChooserApp=new OpsChooserApp({config:ipsuiteNavigatorConfig}),opsChooserApp.addRegions({queryBuilderRegion:"#querybuilder-region",basketRegion:"#basket-region",metadataRegion:"#ops-metadata-region",listRegion:"#ops-collection-region",paginationRegionTop:"#ops-pagination-region-top",paginationRegionBottom:"#ops-pagination-region-bottom"}),opsChooserApp.addInitializer(function(){this.storage=new StoragePlugin,this.listenTo(this,"application:ready",function(){this.storage.setup_ui()}),this.listenTo(this,"results:ready",function(){this.storage.setup_ui()})}),opsChooserApp.addInitializer(function(){localforage.setDriver("localStorageWrapper"),localforage.config({name:this.config.get("context")});var e=this.config.get("database");e&&("viewer"==this.config.get("context")&&this.storage.dbreset(),this.LOAD_IN_PROGRESS=!0,this.storage.dbimport(e))}),opsChooserApp.addInitializer(function(){this.search=new OpsPublishedDataSearch,this.metadata=new OpsExchangeMetadata,this.documents=new OpsExchangeDocumentCollection,this.results=new ResultCollection}),opsChooserApp.addInitializer(function(){this.metadataView=new MetadataView({model:this.metadata}),this.collectionView=new OpsExchangeDocumentCollectionView({collection:this.documents}),this.resultView=new ResultCollectionView({collection:this.results}),this.paginationViewTop=new PaginationView({model:this.metadata}),this.paginationViewBottom=new PaginationView({model:this.metadata,bottom_pager:!0}),this.metadataRegion.show(this.metadataView),this.paginationRegionTop.show(this.paginationViewTop),this.paginationRegionBottom.show(this.paginationViewBottom)}),opsChooserApp.addInitializer(function(){}),opsChooserApp.addInitializer(function(){this.listenTo(this,"results:ready",function(){this.metadata.trigger("commit"),this.listRegion.currentView!==this.collectionView&&this.listRegion.show(this.collectionView)}),this.listenTo(this,"project:ready",this.project_activate),this.listenToOnce(this,"project:ready",function(){this.perform_search()})}),$(document).ready(function(){console.log("document.ready"),opsChooserApp.start(),boot_application()});var OPS_CQL_FIELDS=[{text:"<h4>Popular</h4>",children:[{id:"num",text:cql_field_chooser_text("Publication-, application- or<br/>priority number",["num"],"(10, 11, 21, 31)")},{id:"txt",text:cql_field_chooser_text("Title, abstract, inventor-, or applicant name",["txt"],"(54, 57, 72, 71, 73)")},{id:"cl",text:cql_field_chooser_text("CPC or IPC8 class",["cl"],"")}]},{text:"<h4>Publication</h4>",children:[{id:"pn",text:cql_field_chooser_text("Publication number",["pn","publicationnumber"],"(10, 11)")},{id:"pd",text:cql_field_chooser_text("Publication date",["pd","publicationdate"],"")},{id:"pa",text:cql_field_chooser_text("Applicant",["pa","applicant"],"(71, 73)")},{id:"in",text:cql_field_chooser_text("Inventor",["in","inventor"],"(72)")},{id:"ia",text:cql_field_chooser_text("Inventor or applicant",["ia","inventorandapplicant"],"(72, 71, 73)")},{id:"spn",text:cql_field_chooser_text("Publication number<br/><small>in epodoc format</small>",["spn"],"")}]},{text:"<h4>Text</h4>",children:[{id:"ti",text:cql_field_chooser_text("Title",["ti","title"],"(54)")},{id:"ab",text:cql_field_chooser_text("Abstract",["ab","abstract"],"(57)")},{id:"ta",text:cql_field_chooser_text("Title or abstract",["ta","titleandabstract"],"(54, 57)")},{id:"txt",text:cql_field_chooser_text("Title, abstract, inventor-, or applicant name",["txt"],"(54, 57, 72, 71, 73)")}]},{text:"<h4>Application, priority and family</h4>",children:[{id:"ap",text:cql_field_chooser_text("Application number",["ap","applicantnumber"],"(21)")},{id:"sap",text:cql_field_chooser_text("Application number<br/><small>in epodoc format</small>",["sap"],"")},{id:"pr",text:cql_field_chooser_text("Priority number",["pr","prioritynumber"],"(31)")},{id:"spr",text:cql_field_chooser_text("Priority number<br/><small>in epodoc format</small>",["spr"],"")},{id:"famn",text:cql_field_chooser_text("Family identifier (simple)",["famn"],"")}]},{text:"<h4>Classification</h4>",children:[{id:"cpc",text:cql_field_chooser_text("CPC classification<br/><small>(invention and additional)</small>",["cpc","cpci","cpca"],"")},{id:"ipc",text:cql_field_chooser_text("IPC8 class",["ipc","ic"],"")},{id:"ci",text:cql_field_chooser_text("IPC8 core invention class",["ci"],"")},{id:"cn",text:cql_field_chooser_text("IPC8 core additional class<br/><small>(non-invention)</small>",["cn"],"")},{id:"ai",text:cql_field_chooser_text("IPC8 advanced invention class",["ai"],"")},{id:"an",text:cql_field_chooser_text("IPC8 advanced additional class<br/><small>(non-invention)</small>",["an"],"")},{id:"a",text:cql_field_chooser_text("IPC8 advanced class",["a"],"")},{id:"c",text:cql_field_chooser_text("IPC8 core class",["c"],"")},{id:"cl",text:cql_field_chooser_text("CPC or IPC8 class",["cl"],"")}]},{text:"<h4>Citations</h4>",children:[{id:"ct",text:cql_field_chooser_text("Cited document number",["ct","citation"],"(56)")},{id:"ex",text:cql_field_chooser_text("Cited document number<br/><small>during examination</small>",["ex"],"")},{id:"op",text:cql_field_chooser_text("Cited document number<br/><small>during opposition</small>",["op"],"")},{id:"rf",text:cql_field_chooser_text("Cited document number<br/><small>provided by applicant</small>",["rf"],"")},{id:"oc",text:cql_field_chooser_text("Another cited document number",["oc"],"")}]}],DEPATISNET_CQL_FIELDS=[{text:"<h4>Publication</h4>",children:[{id:"pn",text:cql_field_chooser_text("Publication number",["pn"],"(10, 11)")},{id:"pc",text:cql_field_chooser_text("Country of publication",["pc"],"(19)")},{id:"pub",text:cql_field_chooser_text("Publication date",["pub"],"")},{id:"py",text:cql_field_chooser_text("Publication year",["py"],"")},{id:"pa",text:cql_field_chooser_text("Applicant/Owner",["pa"],"(71, 73)")},{id:"in",text:cql_field_chooser_text("Inventor",["in"],"(72)")},{id:"pcod",text:cql_field_chooser_text("Kind code",["pcod"],"(12)")}]},{text:"<h4>Text</h4>",children:[{id:"ti",text:cql_field_chooser_text("Title",["ti"],"(54)")},{id:"ab",text:cql_field_chooser_text("Abstract",["ab"],"(57)")},{id:"de",text:cql_field_chooser_text("Description",["de"],"")},{id:"cl",text:cql_field_chooser_text("Claims",["cl"],"(57)")},{id:"bi",text:cql_field_chooser_text("Full text data",["bi"])}]},{text:"<h4>Application</h4>",children:[{id:"an",text:cql_field_chooser_text("Application number",["ap"],"(21)")},{id:"ac",text:cql_field_chooser_text("Country of application",["ac"],"")},{id:"ad",text:cql_field_chooser_text("Application date",["ad"],"(22, 96)")},{id:"ay",text:cql_field_chooser_text("Application year",["ay"],"")}]},{text:"<h4>Priority</h4>",children:[{id:"prn",text:cql_field_chooser_text("Priority number",["prn"],"(31)")},{id:"prc",text:cql_field_chooser_text("Country of priority",["prc"],"(33)")},{id:"prd",text:cql_field_chooser_text("Priority date",["prd"],"(32)")},{id:"pry",text:cql_field_chooser_text("Priority year",["pry"],"")}]},{text:"<h4>Citations</h4>",children:[{id:"ct",text:cql_field_chooser_text("Cited documents",["ct"],"(56)")},{id:"ctnp",text:cql_field_chooser_text("Cited non-patent literature",["ctnp"],"(56)")}]},{text:"<h4>All IPC</h4>",children:[{id:"ic",text:cql_field_chooser_text("All IPC fields",["ic"],"")}]},{text:"<h4>Bibliographic IPC</h4>",children:[{id:"icb",text:cql_field_chooser_text("Bibliographic IPC",["icb"],"")},{id:"icm",text:cql_field_chooser_text("IPC main class",["icm"],"(51)")},{id:"ics",text:cql_field_chooser_text("IPC secondary class",["ics"],"(51)")},{id:"ica",text:cql_field_chooser_text("IPC additional class",["ica"],"")},{id:"ici",text:cql_field_chooser_text("IPC index classes",["ici"],"")},{id:"icmv",text:cql_field_chooser_text("IPC main class version",["icmv"],"")},{id:"icsv",text:cql_field_chooser_text("IPC secondary class version",["icsv"],"")},{id:"icav",text:cql_field_chooser_text("IPC additional class version",["icav"],"")},{id:"icml",text:cql_field_chooser_text("IPC main class level",["icml"],"")},{id:"icsl",text:cql_field_chooser_text("IPC secondary class level",["icsl"],"")},{id:"ical",text:cql_field_chooser_text("IPC additional class level",["ical"],"")}]},{text:"<h4>Reclassified IPC</h4>",children:[{id:"mcd",text:cql_field_chooser_text("Reclassified IPC",["mcd"],"")},{id:"mcm",text:cql_field_chooser_text("MCD main class",["mcm"],"")},{id:"mcs",text:cql_field_chooser_text("MCD secondary class",["mcs"],"")},{id:"mca",text:cql_field_chooser_text("MCD additional class",["mca"],"")},{id:"mcml",text:cql_field_chooser_text("MCD main class level",["mcml"],"")},{id:"mcsl",text:cql_field_chooser_text("MCD secondary class level",["mcsl"],"")},{id:"mcal",text:cql_field_chooser_text("MCD additional class level",["mcal"],"")}]},{text:"<h4>Search file IPC</h4>",children:[{id:"icp",text:cql_field_chooser_text("Search file IPC",["icp"],"")}]}];UiController=Marionette.Controller.extend({initialize:function(){log("UiController.initialize")},setup_ui:function(){$(".btn-popover").popover(),this.setup_text_tools(),$.notify.defaults({className:"info",showAnimation:"fadeIn",hideAnimation:"fadeOut",autoHideDelay:4e3,showDuration:300}),"liveview"==opsChooserApp.config.get("mode")&&$(".logout-button").hide(),opsChooserApp.config.get("query")&&opsChooserApp.queryBuilderView.set_flavor("cql"),$(".link-help").click(function(){var e=opsChooserApp.config.get("baseurl"),t=e+"/help";$(this).attr("href",t)}),$(".link-fullscreen").click(function(){screenfull.enabled&&screenfull.request()})},setup_text_tools:function(){$(".very-short").shorten({showChars:5,moreText:"more",lessText:"less"})},reset_content:function(e){e=e||{},$("#info-area").empty(),e.keep_notifications||$("#alert-area").empty(),!e.keep_pager,e.documents&&opsChooserApp.documents.reset()},indicate_activity:function(e){e?($(".idler").hide(),$(".spinner").show()):($(".spinner").hide(),$(".idler").show())},propagate_alerts:function(e,t){$("#alert-area").empty();try{var i=jQuery.parseJSON(e.responseText);"error"==i.status&&(_.each(i.errors,function(e){var t=_.template($("#cornice-error-template").html()),i=t(e);$("#alert-area").append(i)}),$(".very-short").shorten({showChars:0,moreText:"more",lessText:"less"}))}catch(o){var n={location:"unknown",name:e.statusText,description:{content:e.responseText,headers:{date:e.getResponseHeader("Date")},status_code:e.status,url:e.requestUrl||t.url}},r=_.template($("#backend-error-template").html()),a=r(n);$("#alert-area").append(a)}},do_element_visibility:function(){var e="print"==opsChooserApp.config.get("mode");e&&$(".do-not-print").hide();var t="liveview"==opsChooserApp.config.get("mode");t&&$(".non-liveview").hide()},do_elements_focus:function(){opsChooserApp.documents.length&&($("#patentnumber").blur(),$("#query").blur())},confirm:function(e){var t=$.Deferred(),i=bootbox.confirm("<h4>"+e+"</h4>",function(e){e&&t.resolve()});return i.css({color:"#b94a48","background-color":"#f2dede","border-color":"#eed3d7"}),t.promise()},user_alert:function(e,t,i){if(e){var o="INFO",n="alert-info";"success"==t?(o="SUCCESS",n="alert-success"):"warning"==t?(o="WARNING",n="alert-warning"):"error"==t&&(o="ERROR",n="alert-danger");var r=_.template($("#alert-template").html()),a={title:o,description:e,clazz:n},s=r(a);i=i||"#info-area",$(i).append(s)}},notify:function(e,t){t=t||{},t.wrapper=t.wrapper||document.body,t.icon&&(e='<span class="icon '+t.icon+' icon-large"></span><p>'+e+"</p>"),t.type||(t.type="notice"),this.notification&&this.notification.dismiss(),this.notification=new NotificationFx({message:e,layout:"attached",effect:"bouncyflip",type:t.type,wrapper:t.wrapper,onClose:function(){}}),t.right&&(this.notification.ntf.className=this.notification.ntf.className.replace("ns-attached","ns-attached-right")),this.notification.show()},scroll_smooth:function(e){e&&$(e).offset()&&$("html, body").animate({scrollTop:$(e).offset().top},500)},copy_to_clipboard:function(e,t,i){i=i||{};var o=$.Deferred();if(ZeroClipboard.isFlashUnusable())return $(i.element).unbind("click"),void $(i.element).bind("click",function(){var e='Copying data to clipboard not possible, Adobe Flash Player plugin is required.<br/><a href="https://get.adobe.com/flashplayer/" target="_blank">Install Adobe Flash Player</a>.';_ui.notify(e,{type:"warning",icon:"icon-copy",wrapper:i.wrapper})});var n=new ZeroClipboard(i.element);return n.on("ready",function(){n.on("copy",function(i){var o=i.clipboardData;_.isFunction(t)&&(t=t()),o.setData(e,t)}),n.on("aftercopy",function(t){var o=t.data[e].length,n="Bytes";if(o>=1e3)var o=Math.round(o/1e3),n="kB";var r="Copied content to clipboard, size is "+o+" "+n+".";_ui.notify(r,{type:"success",icon:"icon-copy",wrapper:i.wrapper})}),o.resolve(n)}),o.promise()},copy_to_clipboard_bind_button:function(e,t,i){$(i.element).unbind("click"),$(i.element).click(function(e){e.preventDefault()}),this.copy_to_clipboard(e,t,i)},notify_module_locked:function(e){var t='The module "'+e+'" is not available to your account. Please subscribe to this feature.';this.notify(t,{type:"warning",icon:"icon-lock"})}});var _ui;if(opsChooserApp.addInitializer(function(){this.ui=new UiController,_ui=this.ui,this.listenTo(this,"application:ready",function(){this.ui.setup_ui()}),this.listenTo(this,"results:ready",function(){this.ui.do_elements_focus()})}),timestamp=now_iso,Function.prototype.bind)var log=Function.prototype.bind.call(console.log,console);else var log=function(){};_.clear=function(e){e.length=0},function(e){e.fn.extend({qnotify:function(t,i){i=i||{},_.defaults(i,{className:"info",position:"bottom"}),i.error&&(i.className="error"),i.success&&(i.className="success"),(i.warn||i.warning)&&(i.className="warning"),e(this).notify(t,i)}})}(jQuery),$.fn.exists=function(){return 0!==this.length},jQuery.fn.handle_enter_keypress=function(){var e=!1||!!document.documentMode,t=Object.prototype.toString.call(window.HTMLElement).indexOf("Constructor")>0;(e||t)&&$(this).find("input").keypress(function(e){"13"==e.which&&$(this).closest("form").find("button[type=submit],input[type=submit]").filter(":first").click()})},_.mixin({objMap:function(e,t,i){return _.reduce(e,function(o,n,r){return o[r]=t.call(i,n,r,e),o},{},i)},objFilter:function(e,t,i){return _.reduce(e,function(o,n,r){return t.call(i,n,r,e)&&(o[r]=n),o},{},i)},objReject:function(e,t,i){return _.reduce(e,function(o,n,r){return t.call(i,n,r,e)||(o[r]=n),o},{},i)},objRejectEmpty:function(e){return _.objReject(e,function(e){return _.isEmpty(e)})}});var ModalRegion=Marionette.Region.extend({constructor:function(){Marionette.Region.prototype.constructor.apply(this,arguments),this.ensureEl(),this.$el.on("hidden",{region:this},function(e){e.data.region.close()})},onShow:function(){this.$el.modal("show")},onClose:function(){this.$el.modal("hide")}}),getDocumentHeight=function(){var e=document;return Math.max(e.body.scrollHeight,e.documentElement.scrollHeight,e.body.offsetHeight,e.documentElement.offsetHeight,e.body.clientHeight,e.documentElement.clientHeight)};AbstractResultFetcher=Marionette.Controller.extend({start:function(){var e=$.Deferred(),t=opsChooserApp.queryBuilderView.get_comfort_form_data();if(!t||!t.criteria)return e.reject("Empty form data"),e;var i=this.get_url(t);return log("url:",i),$.ajax({url:i,async:!0}).success(function(t){t?e.resolve(t):e.reject("Empty response")}).error(function(t){e.reject("API failed: "+JSON.stringify(t))}),e}}),ResultAnalyticsFamilyFetcher=AbstractResultFetcher.extend({initialize:function(e){log("ResultAnalyticsFamilyFetcher.initialize"),e=e||{}},get_url:function(e){var t=_.template("/api/analytics/family/overview?<%= criteria_query %>&datasource=<%= datasource %>"),i=t({criteria_query:$.param(e.criteria),datasource:e.datasource});return i}}),ResultAnalyticsFamilyView=GenericResultView.extend({initialize:function(){console.log("ResultAnalyticsFamilyView.initialize")},onShow:function(){this.hide_buttons(),this.start()},setup_data:function(e){$("#result-content").val(JSON.stringify(e,null,2))},fetcher_factory:function(){var e=new ResultAnalyticsFamilyFetcher;
return e}}),ResultAnalyticsDaterangeFetcher=AbstractResultFetcher.extend({initialize:function(e){log("ResultAnalyticsDaterangeFetcher.initialize"),e=e||{},this.kind=e.kind},get_url:function(e){var t=_.template("/api/analytics/daterange/<%= kind %>?<%= criteria_query %>&datasource=<%= datasource %>"),i=t({kind:this.kind,criteria_query:$.param(e.criteria),datasource:e.datasource});return i}}),ResultAnalyticsDaterangeView=GenericResultView.extend({initialize:function(e){console.log("ResultAnalyticsDaterangeView.initialize"),e=e||{},this.kind=e.kind},onShow:function(){this.start()},setup_data:function(e){$("#result-content").val(JSON.stringify(e,null,2));var t=[];_.each(e,function(e){e.pubnumber&&t.push(e.pubnumber),e.publication_number&&t.push(e.publication_number)}),this.setup_numberlist_buttons(t)},fetcher_factory:function(){var e=new ResultAnalyticsDaterangeFetcher({kind:this.kind});return e}}),opsChooserApp.addInitializer(function(){this.listenTo(this,"application:ready",function(){var e=this,t="analytics",i=opsChooserApp.user_has_module(t);$("#analytics-family-overview-button").unbind("click"),$("#analytics-family-overview-button").click(function(){i?make_modal_view(ResultAnalyticsFamilyView,e.metadata):e.ui.notify_module_locked(t)}),$(".analytics-daterange-button").unbind("click"),$(".analytics-daterange-button").click(function(){i?make_modal_view(ResultAnalyticsDaterangeView,e.metadata,{kind:$(this).data("kind")}):e.ui.notify_module_locked(t)})})}),BasketModel=Backbone.RelationalModel.extend({sync:Backbone.localforage.sync("Basket"),relations:[{type:Backbone.HasMany,key:"entries",relatedModel:"BasketEntryModel",includeInJSON:Backbone.Model.prototype.idAttribute}],defaults:{},initialize:function(){console.log("BasketModel.initialize"),this.fetchRelated||(this.fetchRelated=this.getAsync),this.wrap_cache("get_numbers")},wrap_cache:function(e,t){t=t||this,this[e]=memoize(this[e],this),this.invalidate_cache=function(){this[e].__cache.remove()},this.bind("change",this.invalidate_cache)},init_from_query:function(){var e=[],t=this,i=opsChooserApp.config.get("numberlist");if(i){i=decodeURIComponent(i);var o=i.split(/[,\n]/);_(o).each(function(i){var o=t.add(i);e.push(o)})}return deferreds_bundle(e)},get_entry_by_number:function(e){var t=this.get("entries").where({number:e});return _.isEmpty(t)?void 0:t[0]},add:function(e,t){t=t||{};var i=this;if(e=e.trim(),!_.isEmpty(e)){var o=$.Deferred(),n=this.get_entry_by_number(e);if(n)return n.fetch({success:function(){o.resolve(n),!t.bulk&&i.trigger("change",i)}}),o.promise();var r=_.find(opsChooserApp.documents.models,function(t){var i=t.get_document_number();return e==i}),a=r?r.attributes.get_title_list():void 0;return n=new BasketEntryModel({number:e,timestamp:now_iso(),title:a}),n.save(null,{success:function(){var r=i.get("entries");r.add(n),i.save({entries:r},{success:function(){t.bulk?o.resolve(n):$.when(i.fetch_entries()).then(function(){o.resolve(i.get_entry_by_number(n.get("number"))),i.trigger("change",i),i.trigger("change:add",n,e)})}})}}),o.promise()}},add_multi:function(e){var t=$.Deferred(),i=this,o=[];return _.each(e,function(e){o.push(i.add(e,{bulk:!0}))}),$.when.apply($,o).then(function(){i.refresh(),t.resolve()}),t.promise()},refresh:function(){var e=this;$.when(this.fetch_entries()).then(function(){e.trigger("change")})},remove:function(e){var t=this,i=this.get_entry_by_number(e);if(i){var o=this.get("entries");o.remove(i),i.destroy(),t.save({entries:o},{success:function(){$.when(t.fetch_entries()).then(function(){t.trigger("change:remove",i,e),t.trigger("change",t)})}})}},get_numbers:function(e){e=e||{};var t=_.reject(this.get("entries").models,function(t){return e.honor_dismiss?1==t.get("dismiss"):!1}).map(function(e){return e.get("number")});return t},empty:function(){return 0==this.get("entries").length},csv_list:function(){return this.get("entries").map(function(e){var t=[e.get("number"),e.get("score"),e.get("dismiss")],i=t.join(",");return i})},unicode_stars_list:function(){return this.get("entries").map(function(e){var t=_.string.ljust(e.get("number"),20," ")+_.string.ljust(e.get("dismiss")?"∅":"",5," ")+_.string.repeat("★",e.get("score"));return t})},unicode_stars_list_email:function(){var e=String.fromCharCode(160);return this.get("entries").map(function(t){var i=(t.get("dismiss")?"∅":"")+_.string.repeat("★",t.get("score")),o=10-1.7*i.length,n=_.string.repeat(e,o),r=i+n+t.get("number");return r})},review:function(e){var t=this.get_numbers({honor_dismiss:!0}),i=t.length;opsChooserApp.set_datasource("review"),opsChooserApp.metadata.set("reviewmode",!0),opsChooserApp.perform_listsearch(e,void 0,t,i,"pn","OR")},fetch_entries:function(){var e=this,t=$.Deferred();return $.when(this.fetchRelated("entries")).then(function(){var i=[];e.get("entries").each(function(e){var t=$.Deferred();i.push(t.promise()),e.fetch({success:function(){t.resolve(e)},error:function(){console.log("error while fetching basket entry:",e),e.save(null,{success:function(){console.log("success"),t.resolve(e)},error:function(){console.log("error"),t.resolve(e)}})}})}),$.when.apply($,i).then(function(){t.resolve()})}),t.promise()},get_view_state:function(e){e=e||{};var t=opsChooserApp.project.get("name"),i=this.get_numbers(),o=i.join(","),n={context:"viewer",project:t,query:void 0,datasource:"review",numberlist:o};return _(n).extend(e),n},share_email_params:function(){var e=opsChooserApp.project.get("name"),t=opsChooserApp.permalink.make_uri(this.get_view_state({project:"via-email"})),i=this.get_numbers(),o=i.length,n=this.csv_list(),r=this.unicode_stars_list_email(),a=_.template('Shared <%= count %> patent numbers through project "<%= projectname %>" at <%= date %>')({count:o,date:now_iso_human(),projectname:e}),s=_.template($("#basket-mail-template").html().trim()),c=s({subject:a,basket_plain:i.join("\n"),basket_csv:n.join("\n"),basket_stars:r.join("\n"),url:t}),l={subject:"[IPSUITE] "+a,body:c};return l}}),BasketEntryModel=Backbone.RelationalModel.extend({sync:Backbone.localforage.sync("BasketEntry"),defaults:{number:void 0,timestamp:void 0,title:void 0,score:void 0,dismiss:void 0},initialize:function(){}}),BasketView=Backbone.Marionette.ItemView.extend({template:"#basket-template",initialize:function(){this.listenTo(this.model,"change",this.render),this.listenTo(this,"item:rendered",this.setup_ui),this.templateHelpers.config=opsChooserApp.config},templateHelpers:{},serializeData:function(){var e={};e=this.model.toJSON();var t=this.model.unicode_stars_list();return t&&(e.numbers_display=t.join("\n")),e},setup_ui:function(){var e=this,t=this.model.get("entries").length;$(".basket-entry-count").text(t);var i=opsChooserApp.config.get("ship-url");i?$("#basket-submit-button").removeClass("hide"):$("#basket-submit-button").addClass("hide"),$("#basket").unbind("paste"),$("#basket").on("paste",function(t){t.preventDefault();var i=(t.originalEvent||t).clipboardData.getData("text"),o=i.split(/[,;\r\n]/);_.each(o,function(t){e.model.add(t)})}),$("#basket-import-button").unbind("click"),$("#basket-import-button").click(function(){return e.future_premium_feature(),!1}),$(".basket-review-button").unbind("click"),$(".basket-review-button").click(function(t){t.preventDefault(),e.check_empty({kind:"review",icon:"icon-indent-left"})||e.model.review()}),$("#basket-submit-button").unbind("click"),$("#basket-submit-button").click(function(){if(!e.check_empty()){var t=e.model.get_numbers();$("textarea#basket").val(t.join("\n"))}}),$("#share-numberlist-email").unbind("click"),$("#share-numberlist-email").click(function(){if(!e.check_empty()){var t=e.model.share_email_params(),i="mailto:?"+jQuery.param(t).replace(/\+/g,"%20");$(this).attr("href",i)}}),_ui.copy_to_clipboard("text/plain",function(){if(!e.check_empty()){var t=e.model.get_numbers();return t.join("\n")}},{element:$("#share-numberlist-clipboard")}),$("#share-numberlist-url").unbind("click"),$("#share-numberlist-url").click(function(){if(!e.check_empty()){var t=opsChooserApp.permalink.make_uri(e.model.get_view_state());$(this).attr("target","_blank"),$(this).attr("href",t)}}),$("#share-numberlist-url-ttl").unbind("click"),$("#share-numberlist-url-ttl").click(function(t){if(t.preventDefault(),t.stopPropagation(),!e.check_empty()){var i=this;opsChooserApp.permalink.make_uri_opaque(e.model.get_view_state({mode:"liveview"})).then(function(e){opsChooserApp.permalink.popover_show(i,e,{title:"External document review",intro:"<small>This offers a link for external/anonymous users to review the collected documents. It will just transfer the plain numberlist without any rating scores.</small>",ttl:!0})})}}),$("#download-documents-pdf-archive").unbind("click"),$("#download-documents-pdf-archive").click(function(){if(!e.check_empty()){var t=opsChooserApp.basketModel.get_numbers();$(this).attr("target","_blank"),$(this).attr("href","/api/pdf/"+t.join(","))}}),$("#share-documents-transfer").unbind("click"),$("#share-documents-transfer").click(function(){e.future_premium_feature()}),$(".permalink-review-liveview").unbind("click"),$(".permalink-review-liveview").click(function(e){e.preventDefault(),e.stopPropagation();var t=this;opsChooserApp.permalink.liveview_with_database_params().then(function(e){var i=opsChooserApp.permalink.make_uri(e);opsChooserApp.permalink.popover_show(t,i,{intro:"<small>This offers a persistent link to review the current project. It will transfer the whole project structure including queries and basket content with rating scores.</small>"})})}),$(".permalink-review-liveview-ttl").unbind("click"),$(".permalink-review-liveview-ttl").click(function(e){e.preventDefault(),e.stopPropagation();var t=this;opsChooserApp.permalink.liveview_with_database_params().then(function(e){opsChooserApp.permalink.make_uri_opaque(e).then(function(e){opsChooserApp.permalink.popover_show(t,e,{intro:"<small>This offers a link for external/anonymous users to review the current project. It will transfer the whole project structure including queries and basket content with rating scores.</small>",ttl:!0})})})})},check_empty:function(e){e=e||{};var t="shared";return"review"==e.kind&&(t="reviewed"),e.icon||(e.icon="icon-external-link"),this.model.empty()?(opsChooserApp.ui.notify("An empty collection can't be "+t+", please add some documents.",{type:"warning",icon:e.icon+" icon-large"}),!0):!1},future_premium_feature:function(){bootbox.dialog("Available soon via subscription.",[{label:"OK",icon:"OK",callback:null}],{header:"Future feature"})},textarea_scroll_bottom:function(){$("#basket").scrollTop($("#basket")[0].scrollHeight)},textarea_scroll_text:function(e){var t=$("#basket"),i=t.text().search(e);i&&t.scrollTop(i)}}),BasketController=Marionette.Controller.extend({initialize:function(){console.log("BasketController.initialize")},link_document:function(e,t){var i=opsChooserApp.basketModel?opsChooserApp.basketModel.get_numbers():[],o=$("#chk-patent-number-"+t),n=$("#add-patent-number-"+t),r=$("#remove-patent-number-"+t),a=$("#rate-patent-number-"+t),s=a.closest(".ops-collection-entry-heading");if(_(i).contains(t)){if(o&&o.prop("checked",!0),n&&n.hide(),r&&r.show(),e){var c=e.get("score"),l=e.get("dismiss");a.raty("score",c),a.raty("dismiss",l),s.toggleClass("dismiss",Boolean(l)),s.toggleClass("score1",1==c),s.toggleClass("score2",2==c),s.toggleClass("score3",3==c)}}else o&&o.prop("checked",!1),n&&n.show(),r&&r.hide(),a.raty("reload"),s.toggleClass("dismiss",!1),s.toggleClass("score1",!1),s.toggleClass("score2",!1),s.toggleClass("score3",!1)}}),opsChooserApp.addInitializer(function(){this.basketController=new BasketController,this.listenTo(this,"application:ready",function(){"review"==this.config.get("datasource")&&this.listenToOnce(this,"basket:activated",function(e){$.when(e.init_from_query()).then(function(){e.review()})})})}),CommentModel=Backbone.RelationalModel.extend({sync:Backbone.localforage.sync("Comment"),relations:[{type:Backbone.HasOne,key:"project",relatedModel:"ProjectModel",includeInJSON:Backbone.Model.prototype.idAttribute}],defaults:{parent:void 0,created:void 0,modified:void 0,author:void 0,text:void 0},initialize:function(){console.log("CommentModel.initialize")},save:function(e,t,i){null==e||"object"==typeof e?(attrs=e,i=t):(attrs={})[e]=t,i=_.extend({},i);var o=this,n=timestamp(),r=this.isNew(),a={};r&&(a.created=n),a.modified=n,this.set(a);var s=this.get("project"),c=i.success;return i.success=function(e,t,i){r?o.collection.create(e,{success:function(){i.isNew=r,o.collection.add(e),e.set("project",s),o.trigger("saved",e,t,i),c&&c(e,t,i)}}):(o.trigger("saved",e,t,i),c&&c(e,t,i))},Backbone.Model.prototype.save.call(this,attrs,i)}}),CommentCollection=Backbone.Collection.extend({sync:Backbone.localforage.sync("Comment"),find:Backbone.localforage.find,model:CommentModel,initialize:function(){console.log("CommentCollection.initialize")},get_or_create:function(e){var t=_(this.where(e)).first();return t||(t=this.model.build(e,{collection:this,parsed:!1})),t},by_project_and_document_number:function(e,t){return this.get_or_create({project:e,parent:t})}}),CommentButtonView=Backbone.Marionette.ItemView.extend({template:"#template-comment-button",tagName:"span",triggers:{click:"toggle"}}),CommentTextView=Backbone.Marionette.ItemView.extend({template:"#template-comment-text",tagName:"span",initialize:function(){console.log("CommentTextView.initialize"),this.listenTo(this.model,"remove",this.clear)},onRender:function(){var e=this.get_textarea();e.val(this.model.get("text"))},clear:function(){this.get_textarea().val(void 0)},get_widget:function(){return $(this.el).find(":first-child").first()},get_textarea:function(){return $(this.el).find("textarea")},toggle:function(){var e=this;this.get_widget().slideToggle();var t=this.get_textarea();t.off("blur"),t.on("blur",function(){var i=t.val();e.save(i)})},save:function(e){var t=this.model.get("text");return e!=t?(this.model.set({text:e}),this.model.save()):void 0}}),CommentManager=Marionette.Controller.extend({initialize:function(e){log("CommentManager.initialize"),this.collection=e.collection,this.project=e.project,this.itemview=e.itemview,this.model=this.get_or_create(),this.comment_button=new CommentButtonView,this.comment_text=new CommentTextView({model:this.model,collection:this.collection}),this.itemview.region_comment_button.show(this.comment_button),this.itemview.region_comment_text.show(this.comment_text),this.listenTo(this.comment_button,"toggle",this.toggle_edit)},toggle_edit:function(){this.comment_text.toggle()},get_or_create:function(){var e=this.itemview.model.get_document_number(),t=this.collection.by_project_and_document_number(this.project,e);return t}}),CommentsPlugin=Marionette.Controller.extend({initialize:function(e){console.log("CommentsPlugin.initialize");this.view=e.view,this.itemviews=[],this.store=new CommentCollection,this.store.fetch({success:function(){log("CommentsPlugin: fetch ready")}}),this.listenTo(this.view,"itemview:item:rendered",function(e){e.comment_manager=this.comment_factory(e),this.itemviews.push(e)}),this.listenTo(this.view,"collection:before:render",function(){_.clear(this.itemviews)}),this.listenTo(this.view,"collection:before:close",function(){_.clear(this.itemviews)}),this.listenTo(opsChooserApp,"project:changed",function(){var e=this;_(this.itemviews).each(function(t){t.comment_manager=e.comment_factory(t)})}),this.bind_hotkeys()},comment_factory:function(e){var t=opsChooserApp.project;return log("comment_factory using project:",t),new CommentManager({collection:this.store,project:t,itemview:e})},bind_hotkeys:function(){var e=this;$(document).on("keydown",null,"C",function(){e.viewport_toggle_comment()})},viewport_toggle_comment:function(){var e=$(".document-actions:in-viewport").closest(".ops-collection-entry").backboneView();e.comment_manager&&e.comment_manager.toggle_edit()}}),opsChooserApp.addInitializer(function(){this.LOAD_IN_PROGRESS?this.listenTo(this,"projects:initialize",function(){this.comments=new CommentsPlugin({view:this.collectionView})}):this.comments=new CommentsPlugin({view:this.collectionView})}),DocumentBaseController=Marionette.Controller.extend({initialize:function(){console.log("DocumentBaseController.initialize")},setup_ui:function(){opsChooserApp.ui.do_element_visibility();var e="print"==opsChooserApp.config.get("mode");if(!e){$(".cql-query").shorten({showChars:125,moreText:"more",lessText:"less"}),$("#result-count-total").autoNumeric("init",{mDec:0}),opsChooserApp.basket_bind_actions(),$(".abstract").shorten({showChars:2e3,moreText:"more",lessText:"less"}),$(".btn-popover").popover(),$(".inid-tooltip").tooltip(),$(".abstract-acquire").on("click",function(e){e.preventDefault();var t=$(this).data("lang"),i=$(this).closest(".ops-collection-entry").prop("ops-document");$(this).after('<span class="abstract-acquire-spinner">&nbsp;&nbsp;<i class="icon-refresh icon-spin"></i></span>');var o=opsChooserApp.document_details.get_fulltext(i),n=this;o.get_abstract(t).then(function(e){$(n).replaceWith(e.html),$(".abstract-acquire-spinner").detach()}).fail(function(e){$(n).replaceWith(e.html),$(".abstract-acquire-spinner").detach()})}),$(".embed-item").each(function(e,t){var i=$(t).data("embed-url"),o=$(t).data("document-number");if(i){var n=_.template(i,null,{interpolate:/\{\{(.+?)\}\}/g}),r=n({publication_number:o}),a='<iframe src="'+r+'" class="container-fluid well" seamless="seamless" height2="200" width2="100%" style="min-height: 50%; min-width: 80%"/>';$(this).append(a)}});var t="family-citations",i=opsChooserApp.user_has_module(t);$(".family-citations-shortcut-button").unbind("click"),$(".family-citations-shortcut-button").bind("click",function(){if(i){var e=$(this).closest(".ops-collection-entry");e.find('.document-details-chooser > button[data-toggle="tab"][data-details-type="family"]').tab("show"),e.find('.family-chooser > button[data-toggle="tab"][data-view-type="citations"]').tab("show")}else opsChooserApp.ui.notify_module_locked(t)}),OpsBaseViewMixin.bind_query_links($(document)),OpsBaseViewMixin.bind_same_citations_links($(document))}}}),DocumentDetailsController=Marionette.Controller.extend({initialize:function(){console.log("DocumentDetailsController.initialize")},setup_ui:function(){var e=this;$('.document-details-chooser > button[data-toggle="tab"]').on("show",function(t){var i=$($(t.target).attr("href")),o=$(this).data("details-type"),n=$(this).closest(".ops-collection-entry").prop("ops-document");if(n)if(_(["claims","description"]).contains(o)){var r=e.get_fulltext_details(o,n);e.display_details(r,i)}else if("family"==o){var a=$(i).find(".family-chooser");a.find('button[data-toggle="tab"]').on("show",function(){var t=$(this).data("view-type");if("citations"==t){var o="family-citations",r=opsChooserApp.user_has_module(o);r?e.display_family(n,i,t):opsChooserApp.ui.notify_module_locked(o)}else e.display_family(n,i,t)});var s=a.find('button[data-toggle="tab"][class*="active"]'),c=$(s).data("view-type");e.display_family(n,i,c)}$(".btn-popover").popover()})},get_fulltext:function(e){var t=OpsFulltext,i=e.get_publication_number("epodoc"),o=e["@country"];return _(["DE","US"]).contains(o)&&(t=DepatisConnectFulltext,i=e.get_publication_number("docdb")),new t(i)},get_fulltext_details:function(e,t){var i=this.get_fulltext(t);return"description"==e?i.get_description():"claims"==e?i.get_claims():void 0},display_details:function(e,t){var i=this,o=t.find(".document-details-content"),n=t.find(".document-details-language");o&&(this.indicate_activity(t,!0),e.then(function(e){i.indicate_activity(t,!1),e&&($(o).html(e.html),e.lang&&$(n).html("["+e.lang+"]"),opsChooserApp.keywords.highlight($(o).find("*")))}))},display_family:function(e,t,i){var o,n,r=e.get_publication_number("epodoc");"compact"==i?(n=new OpsFamilyCollection(null,{document_number:r}),o=OpsFamilyCompactCollectionView):"verbose"==i?(n=new OpsFamilyCollection(null,{document_number:r}),o=OpsFamilyVerboseCollectionView):"citations"==i&&(n=new OpsFamilyCollection(null,{document_number:r,constituents:"biblio"}),o=OpsFamilyCitationsCollectionView);var a=t.find(".document-details-content"),s=new Backbone.Marionette.Region({el:a});if(!n||!o)return s.close(),void a.empty();var c=new o({collection:n}),l=this;l.indicate_activity(t,!0),n.fetch().then(function(){l.indicate_activity(t,!1),s.show(c)}).fail(function(){l.indicate_activity(t,!1),FamilyFailedView=Backbone.Marionette.ItemView.extend({render:function(){this.$el.append("No family information available.")}}),s.show(new FamilyFailedView)})},indicate_activity:function(e,t){var i=e.find(".document-details-spinner");t?i.show():i.hide()}}),DocumentCarouselController=Marionette.Controller.extend({initialize:function(){console.log("DocumentCarouselController.initialize")},setup_ui:function(){var e=this;$(".drawings-carousel").carousel({interval:null}),$(".drawings-carousel").bind("slid",function(){e.update_carousel_metadata(this)});var t=$(".drawings-carousel .carousel-control.right");t.click(function(){var t=$(this).closest(".ops-collection-entry").find(".drawings-carousel");e.carousel_fetch_next(t)}),$(".drawings-carousel").each(function(t,i){var i=$(i),o=i.data("totalcount");if(!o){o=1;var n=i.closest(".ops-collection-entry").data("document-number");if(!n)return void console.warn("document-number could not be found, won't proceed loading items into carousel");var r=_.template("/api/ops/<%= patent %>/image/info")({patent:n});$.ajax({url:r,async:!0}).success(function(t){t&&(o=t.META["drawing-total-count"],i.data("totalcount",o),e.update_carousel_metadata(i))}).error(function(e){console.warn("Error while fetching total count of drawings",e)}),i.data("totalcount",o),e.update_carousel_metadata(i)}});var i=$(".drawings-carousel").find("img");i.error(function(){$(this).hide();var e='<br/><blockquote class="text-center" style="min-height: 300px"><br/><br/><br/><br/><br/><br/>No image</blockquote>';$(this).closest(".carousel").hide().parent().find(".drawing-info").html(e)})},update_carousel_metadata:function(e){var t=$(e).closest(".ops-collection-entry"),i=$(e).data("carousel");if(i){var o=i.getActiveIndex()+1;t.find(".drawing-number").text(o)}var n=$(e).data("totalcount");n&&t.find(".drawing-totalcount").text("/"+n)},carousel_fetch_next:function(e){var t=e.find(".carousel-inner"),i=t.find("div.active").index()+1,o=t.find("div").length;if(i==o){var n=e.data("totalcount");if(n&&!(o>=n)){var r=$(t).children(":first").clone(),a=$(t).height();$(r).removeClass("active");var s=$(r).children("img"),c=s.attr("src").replace(/\?page=.*/,"");c+="?page="+(i+1),s.attr("src",c),$(r).attr("min-height",a),$(r).height(a),$(t).append(r)}}}}),PdfPanelController=Marionette.Controller.extend({initialize:function(){console.log("PdfPanelController.initialize")},setup_ui:function(){var e=this;$(".pdf-open").click(function(){var t=$(this).data("patent-number"),i=$(this).data("pdf-url"),o=1;e.pdf_set_headline(t,o),e.pdf_display("pdf",i,o),$("#pdf-previous").unbind(),$("#pdf-previous").click(function(){1!=o&&(o-=1,e.pdf_set_headline(t,o),e.pdf_display("pdf",i,o))}),$("#pdf-next").unbind(),$("#pdf-next").click(function(){o+=1,e.pdf_set_headline(t,o),e.pdf_display("pdf",i,o)})})},pdf_display:function(e,t,i){var o=new PDFObject({url:t+"?page="+i,id:"myPDF",pdfOpenParams:{navpanes:0,toolbar:0,statusbar:0,view:"FitB"}});o.embed(e)},pdf_set_headline:function(e,t){var i=e+" Page "+t;$(".modal-header #ops-pdf-modal-label").empty().append(i)}}),opsChooserApp.addInitializer(function(){this.document_base=new DocumentBaseController,this.document_details=new DocumentDetailsController,this.document_carousel=new DocumentCarouselController,this.listenTo(this,"results:ready",function(){this.document_base.setup_ui(),this.document_details.setup_ui(),this.document_carousel.setup_ui()})}),ResultNumbersView=GenericResultView.extend({initialize:function(){console.log("ResultNumbersView.initialize"),this.message_more="",this.crawler_limit=0},setup_data:function(e){var t=e,i=t.join("\n");if($("#result-content").val(i),this.setup_numberlist_buttons(t),t.length>=this.crawler_limit){var o=this.model.get("datasource");this.message_more+='<br/>Remark: The maximum number of result items for datasource "'+o+'" is "'+this.crawler_limit+'".'}},fetcher_factory:function(){var e,t=this.model.get("query_origin"),i=this.model.get("datasource");if("ops"==i)e=OpsPublishedDataCrawler,this.crawler_limit=2e3;else if("depatisnet"==i)e=DepatisnetCrawler,this.crawler_limit=1e3;else{if("ftpro"!=i)return void this.user_message('Fetching publication numbers for datasource "'+i+'" not implemented yet.',"error");e=FulltextProCrawler,this.crawler_limit=5e3}var o=new e({constituents:"pub-number",query:t});return o}}),opsChooserApp.addInitializer(function(){this.listenTo(this,"results:ready",function(){var e=this;$("#fetch-result-numbers-action").unbind("click"),$("#fetch-result-numbers-action").click(function(){var t=new ModalRegion({el:"#modal-area"}),i=new ResultNumbersView({model:e.metadata});t.show(i)})})}),HotkeysPlugin=Marionette.Controller.extend({initialize:function(e){console.log("HotkeysPlugin.initialize"),this.app=e.app},setup_hotkeys:function(){var e=this;$("#query").on("keydown",null,"meta+return",function(){e.app.perform_search({reviewmode:!1,flavor:"cql"})}),$("#query").on("keydown",null,"ctrl+return",function(){e.app.perform_search({reviewmode:!1,flavor:"cql"})}),$("#numberlist").on("keydown",null,"meta+return",function(){e.app.perform_numberlistsearch()}),$("#query").on("keydown",null,"alt+ctrl+f",function(e){e.preventDefault(),$("#cql-field-chooser").select2("open"),$("#cql-field-chooser").unbind("select2-close"),$("#cql-field-chooser").on("select2-close",function(){window.setTimeout(function(){$("#query").focus()},100)})}),$("input").on("keydown",null,"shift+return",function(e){e.preventDefault(),$(this).parent().find(".add-on.add-on-zoom").click()}),_([document,"#query","#numberlist","input"]).each(function(t){e.querybuilder_hotkeys(t)}),$(document).on("keydown",null,"+",function(){e.app.viewport.document_add_basket()}),$(document).on("keydown",null,"insert",function(){e.app.viewport.document_rate(1)}),$(document).on("keydown",null,"-",function(){e.app.viewport.document_remove_basket()}),$(document).on("keydown",null,"r",function(){e.app.viewport.document_remove_basket()}),$(document).on("keydown",null,"del",function(){e.app.viewport.document_remove_basket()}),$(document).on("keydown",null,"ctrl+d",function(){e.app.viewport.document_remove_basket()}),$(document).on("keydown",null,"0",function(){e.app.viewport.document_rate(null,!0)}),$(document).on("keydown",null,"d",function(){e.app.viewport.document_rate(null,!0)}),$(document).on("keydown",null,"1",function(){e.app.viewport.document_rate(1)}),$(document).on("keydown",null,"2",function(){e.app.viewport.document_rate(2)}),$(document).on("keydown",null,"3",function(){e.app.viewport.document_rate(3)});var t=e.app.ui.scroll_smooth;$(document).on("keydown",null,null,function(i){32!=i.keyCode||_(["input","textarea"]).contains(i.target.localName)||(i.preventDefault(),0==i.shiftKey?t(e.app.viewport.next_item({paging:!0})):1==i.shiftKey&&t(e.app.viewport.previous_item({paging:!0})))}),$(document).on("keydown",null,"pagedown",function(i){i.preventDefault(),t(e.app.viewport.next_item({paging:!0}))}),$(document).on("keydown",null,"pageup",function(i){i.preventDefault(),t(e.app.viewport.previous_item({paging:!0}))}),$(document).on("keydown",null,"right",function(t){t.preventDefault();var i=e.app.viewport.get_document().find(".document-actions .document-details-chooser").first(),o=i.find("button.active"),n=o.next("button");n.length||(n=o.siblings("button").first()),n.tab("show")}),$(document).on("keydown",null,"left",function(t){t.preventDefault();var i=e.app.viewport.get_document().find(".document-actions .document-details-chooser").first(),o=i.find("button.active"),n=o.prev("button");n.length||(n=o.siblings("button").last()),n.tab("show")}),$(document).on("keydown",null,"shift+right",function(t){t.preventDefault();var i=e.app.viewport.get_document().find(".drawings-carousel").first(),o=i.find(".carousel-control.right");o.trigger("click")}),$(document).on("keydown",null,"shift+left",function(t){t.preventDefault();var i=e.app.viewport.get_document().find(".drawings-carousel").first(),o=i.find(".carousel-control.left");o.trigger("click")}),$(document).on("keydown",null,"shift+p",function(t){t.preventDefault();var i=e.app.viewport.get_document().find("a.anchor-pdf");i[0].click()}),$(document).on("keydown",null,"shift+e",function(t){t.preventDefault();var i=e.app.viewport.get_document().find("a.anchor-biblio-espacenet");i[0].click()}),$(document).on("keydown",null,"shift+d",function(t){t.preventDefault();var i=e.app.viewport.get_document().find("a.anchor-biblio-depatisnet");i[0].click()}),$(document).on("keydown",null,"alt+shift+e",function(t){t.preventDefault(),e.app.viewport.get_document().find("a.anchor-register-epo")[0].click()}),$(document).on("keydown",null,"alt+shift+d",function(t){t.preventDefault(),e.app.viewport.get_document().find("a.anchor-register-dpma")[0].click()}),$(document).on("keydown",null,"shift+c",function(t){t.preventDefault(),e.app.viewport.get_document().find("a.anchor-ccd")[0].click()}),$(document).on("keydown",null,"h",function(t){t.preventDefault();var i=e.app.config.get("baseurl"),o=i+"/help";window.open(o)})},querybuilder_hotkeys:function(e){var t=this;$(e).on("keydown",null,"ctrl+shift+c",function(){$('#querybuilder-flavor-chooser button[data-value="comfort"]').tab("show")}),$(e).on("keydown",null,"ctrl+shift+x",function(){$('#querybuilder-flavor-chooser button[data-value="cql"]').tab("show")}),$(e).on("keydown",null,"ctrl+shift+n",function(){$('#querybuilder-flavor-chooser button[data-value="numberlist"]').tab("show")}),$(e).on("keydown",null,"ctrl+shift+e",function(){$('#datasource button[data-value="ops"]').button("toggle"),t.app.set_datasource("ops")}),$(e).on("keydown",null,"ctrl+shift+d",function(){$('#datasource button[data-value="depatisnet"]').button("toggle"),t.app.set_datasource("depatisnet")}),opsChooserApp.config.get("google_allowed")&&$(e).on("keydown",null,"ctrl+shift+g",function(){var e=$('#datasource button[data-value="google"]');e.show(),e.button("toggle"),t.app.set_datasource("google")}),opsChooserApp.config.get("ftpro_enabled")&&$(e).on("keydown",null,"ctrl+shift+f",function(){$('#datasource button[data-value="ftpro"]').button("toggle"),t.app.set_datasource("ftpro")}),$(e).on("keydown",null,"ctrl+shift+r",function(){t.app.basketModel.review()})},querybuilder_zoomed_hotkeys:function(e,t){$(e).unbind("keydown"),$(e).on("keydown",null,"meta+return",function(){$("#querybuilder-comfort-form").submit()}),$(e).on("keydown",null,"ctrl+return",function(){$("#querybuilder-comfort-form").submit()}),$(e).on("keydown",null,"shift+return",function(e){e.preventDefault(),opsChooserApp.queryBuilderView.comfort_form_zoomed_to_regular_data(),opsChooserApp.queryBuilderView.comfort_form_zoomed_to_regular_ui(t)})}}),opsChooserApp.addInitializer(function(){this.hotkeys=new HotkeysPlugin({app:this}),this.listenTo(this,"application:ready",function(){this.hotkeys.setup_hotkeys()})}),KeywordMapModel=Backbone.RelationalModel.extend({sync:Backbone.localforage.sync("KeywordMap"),defaults:{name:null,keywords:[],style:null},initialize:function(){console.log("KeywordMapModel.initialize"),this.fetchRelated||(this.fetchRelated=this.getAsync)}}),KeywordMapCollection=Backbone.Collection.extend({sync:Backbone.localforage.sync("KeywordMap"),find:Backbone.localforage.find,model:KeywordMapModel,initialize:function(){console.log("KeywordMapCollection.initialize")}}),KeywordEditorEntryView=Backbone.Marionette.ItemView.extend({tagName:"tr",template:"#keyword-editor-entry-template",initialize:function(){},templateHelpers:{},onDomRefresh:function(){},events:{}}),KeywordEditorView=Backbone.Marionette.CompositeView.extend({tagName:"div",id:"keyword-editor",className:"modal",template:"#keyword-editor-template",itemView:KeywordEditorEntryView,appendHtml:function(e,t){e.$("tbody").append(t.el)
},initialize:function(){console.log("KeywordEditorView.initialize")},setup_ui:function(){this.collection.fetch({success:function(e){_.each(e.models,function(e){var t="highlight-strong-"+e.get("name"),i=e.get("style");i=_(i).extend(opsChooserApp.keywords.styles_strong),$("."+t).css(i)})}})},templateHelpers:{},onShow:function(){this.setup_ui();var e=this;$("#keyword-editor-save-button").unbind("click"),$("#keyword-editor-save-button").click(function(){$.when(e.save_models()).then(function(){opsChooserApp.keywords.keyword_modal.close(),opsChooserApp.keywords.unhighlight(),opsChooserApp.keywords.highlight()})})},save_models:function(){var e=$.Deferred(),t=this;return this.collection.fetch({success:function(i){_.each(i.models,function(e){var i=e.get("name"),o=$('textarea[data-name="'+i+'"]'),n=o.val();if(void 0!=n){var r=_.map(n.split(","),function(e){return e.trim()}),a=t.collection.where({name:i});if(a){var s=a[0];s.set("keywords",r),s.save()}}}),e.resolve()}}),e},events:{}}),KeywordsController=Marionette.Controller.extend({initialize:function(){console.log("KeywordsController.initialize"),this.keywordmaps=new KeywordMapCollection,this.setup_fixtures(),this.module_name="keywords-user",this.module_available=opsChooserApp.user_has_module(this.module_name)},colors_light:{yellow:{backgroundColor:"hsla( 60, 100%, 88%, 1)"},green:{backgroundColor:"hsla(118, 100%, 88%, 1)"},orange:{backgroundColor:"hsla( 16, 100%, 88%, 1)"},turquoise:{backgroundColor:"hsla(174, 100%, 88%, 1)"},blue:{backgroundColor:"hsla(195, 100%, 88%, 1)"},violet:{backgroundColor:"hsla(247, 100%, 88%, 1)"},magenta:{backgroundColor:"hsla(315, 100%, 88%, 1)"}},colors_strong:{yellow:{backgroundColor:"hsla( 60, 100%, 80%, 1)"},green:{backgroundColor:"hsla(118, 100%, 80%, 1)"},orange:{backgroundColor:"hsla( 16, 100%, 80%, 1)"},turquoise:{backgroundColor:"hsla(174, 100%, 80%, 1)"},blue:{backgroundColor:"hsla(195, 100%, 80%, 1)"},violet:{backgroundColor:"hsla(247, 100%, 80%, 1)"},magenta:{backgroundColor:"hsla(315, 100%, 80%, 1)"}},styles_strong:{borderBottom:"1px dashed #333333"},setup_fixtures:function(){var e=this;this.keywordmaps.fetch({success:function(t){t.length<_(e.colors_strong).keys().length&&_.each(_(e.colors_strong).keys(),function(t){var i=e.colors_strong[t],o=new KeywordMapModel({name:t,style:i});o.save(),e.keywordmaps.add(o)})}})},setup_ui:function(){this.keyword_editor=new KeywordEditorView({collection:this.keywordmaps});var e=this;$("#highlighting-map-edit-action").unbind("click"),$("#highlighting-map-edit-action").click(function(){e.module_available?(e.keyword_modal=new ModalRegion({el:"#modal-area"}),e.keyword_modal.show(e.keyword_editor)):opsChooserApp.ui.notify_module_locked(e.module_name)})},highlight:function(e){this.highlight_from_query(e),this.highlight_from_user(e)},unhighlight:function(e){var t=e;t||(t=".keyword"),$(t).unhighlight({className:"highlight-base"})},highlight_from_query:function(e){var t=e;t||(t=".keyword");var i,o=_(this.colors_light).keys(),n=this;_.each(opsChooserApp.metadata.get("keywords"),function(e){if(log("keyword:",e),e){_.isEmpty(i)&&(i=o.slice(0));var r=i.shift(),a=n.colors_light[r],s="keyword-light-"+r;$(t).highlight(e,{className:"highlight-base "+s,wholeWords:!0,minLength:3}),$("."+s).css(a)}})},highlight_from_user:function(e){var t=e;t||(t=".keyword");var i=this;this.keywordmaps.fetch({success:function(e){_.each(e.models,function(e){var o="keyword-strong-"+e.get("name"),n=e.get("style"),r=e.get("keywords");_.each(r,function(e){e&&$(t).highlight(e,{className:"highlight-base "+o,wholeWords:!0,minLength:0})}),n=_(n).extend(i.styles_strong),$("."+o).css(n)})}})}}),opsChooserApp.addInitializer(function(){this.keywords=new KeywordsController,this.listenTo(this,"application:ready",function(){this.keywords.setup_ui()}),this.listenTo(this,"results:ready",function(){this.keywords.setup_ui(),this.keywords.highlight()})}),PermalinkPlugin=Marionette.Controller.extend({initialize:function(){console.log("PermalinkPlugin.initialize")},dataurl:function(){var e=$.Deferred();return opsChooserApp.storage.dump().then(function(t){var i=JSON.stringify(t),o=dataurl.format({data:i,mimetype:"application/json+lz-string",charset:"utf-8"});return e.resolve(o)}),e.promise()},query_parameters:function(e,t){e=e||{},t=t||window.location.href;var i={},o=$.url(t);return _(i).extend(o.param()),_(i).extend(e),i=_.objRejectEmpty(i)},query_parameters_viewstate:function(e){var t=opsChooserApp.config,i={mode:t.get("mode"),context:t.get("context"),project:t.get("project"),datasource:t.get("datasource")};_.each(i,function(e,o){t._originalAttributes[o]==e&&delete i[o]},this);var o=this.query_parameters(i,e);return o},make_uri:function(e){var t=opsChooserApp.config.get("baseurl"),i=t+"?"+jQuery.param(this.query_parameters(e));return i},make_uri_opaque:function(e){var t=$.Deferred(),i=opsChooserApp.config.get("baseurl"),o=opsChooserApp.config.get("request.host");_.string.contains(o,"patentsearch")&&(i=i.replace("patentsearch","patentview"));var n=this.query_parameters(e);return opaque_param(n).then(function(e){var o=i+"?"+e;t.resolve(o)}),t.promise()},popover_switch:function(e,t,i){i=i||{};var o=$(e).popover();if(!o.data("amended")){o.data("amended",!0);var n=i.title||o.data("content");$(e).popover("destroy"),$(e).popover({title:n,content:t,html:!0,placement:"bottom",trigger:"manual"})}},popover_toggle:function(e,t,i){i=i||{},$(e).popover("toggle");var o=$(e).popover().data("popover").$tip,n=o.hasClass("in");if(n){if(t){if(i.intro){var r=i.intro;$(o).find("#permalink-popover-intro").html(r)}$(o).find("#permalink-uri-textinput").val(t),$(o).find("#permalink-open").unbind("click"),$(o).find("#permalink-open").click(function(e){e.preventDefault(),window.open(t)});var a=$(o).find("#permalink-copy");_ui.copy_to_clipboard_bind_button("text/plain",t,{element:a[0],wrapper:this.el}),_ui.setup_text_tools()}$(o).find("#permalink-uri-textinput").select(),i.ttl&&$(o).find("#ttl-24").show()}},popover_get_content:function(){var e=_.template($("#permalink-popover-template").html());return e},popover_show:function(e,t,i){this.popover_switch(e,this.popover_get_content,i),this.popover_toggle(e,t,i)},liveview_with_database_params:function(){var e=$.Deferred(),t=opsChooserApp.project.get("name"),i={mode:"liveview",context:"viewer",project:t,query:void 0,datasource:"review"};return this.dataurl().then(function(t){_(i).extend({database:t}),e.resolve(i)}),e.promise()},setup_ui:function(){}}),opsChooserApp.addInitializer(function(){this.permalink=new PermalinkPlugin,this.listenTo(this,"application:ready",function(){this.permalink.setup_ui()}),this.listenTo(this,"results:ready",function(){this.permalink.setup_ui()})}),QueryModel=Backbone.RelationalModel.extend({sync:Backbone.localforage.sync("Query"),defaults:{flavor:void 0,datasource:void 0,query_expression:void 0,query_data:void 0,created:void 0,result_count:void 0},initialize:function(){console.log("QueryModel.initialize"),this.fetchRelated||(this.fetchRelated=this.getAsync)},equals:function(e){var t=["flavor","datasource","query_expression","query_data"],i=_.pick(this.attributes,t),o=_.pick(e.attributes,t),n=_.isEqual(i,o);return n}}),ProjectModel=Backbone.RelationalModel.extend({sync:Backbone.localforage.sync("Project"),relations:[{type:Backbone.HasOne,key:"basket",relatedModel:"BasketModel",includeInJSON:Backbone.Model.prototype.idAttribute,reverseRelation:{type:Backbone.HasOne,key:"project",includeInJSON:Backbone.Model.prototype.idAttribute}},{type:Backbone.HasMany,key:"queries",relatedModel:"QueryModel",includeInJSON:Backbone.Model.prototype.idAttribute}],defaults:{name:null,created:null,modified:null},initialize:function(){console.log("ProjectModel.initialize"),this.fetchRelated||(this.fetchRelated=this.getAsync)},record_query:function(e){log("ProjectModel.record_query search_info:",e),this.query_recorded=null;var t=e.flavor,i=e.datasource;if(t&&i){var o=this;$.when(this.fetch_queries()).then(function(){var n=o.get("queries");n=sortCollectionByField(n,"created","desc");var r=n.first(),a=new QueryModel({flavor:t,datasource:i,query_expression:e.query,query_data:e.query_data,created:now_iso(),project:o}),s=r&&a.equals(r);s?a.destroy():(o.history_add_query(a),o.query_recorded=a)})}},history_add_query:function(e){log("ProjectModel.record_query model:",e);var t=this;e.save(null,{success:function(){var i=t.get("queries");i.add(e),t.save({queries:i},{success:function(){log("ProjectModel.record_query SUCCESS!")},error:function(e){log("ProjectModel.record_query ERROR!",e)}})}})},save:function(e,t,i){return this.set("modified",now_iso()),Backbone.Model.prototype.save.call(this,e,t,i)},destroy:function(e){var t=this.get("basket");return t&&(t.get("entries").each(function(e){e&&e.destroy()}),t.destroy()),Backbone.Model.prototype.destroy.call(this,e)},fetch_queries:function(){var e=$.Deferred(),t=this;return $.when(this.fetchRelated("queries")).then(function(){var i=t.get("queries"),o=[];i.each(function(e){var t=$.Deferred();o.push(t.promise()),e.fetch({success:function(){t.resolve(e)},error:function(){t.resolve(e)}})}),$.when.apply($,o).then(function(){e.resolve()})}).fail(function(){e.reject()}),e.promise()}}),ProjectCollection=Backbone.Collection.extend({sync:Backbone.localforage.sync("Project"),find:Backbone.localforage.find,model:ProjectModel,initialize:function(){console.log("ProjectCollection.initialize")},sortByField:function(e,t){var i=this,o=function(e,t){return e=e.get(i.sort_key),t=t.get(i.sort_key),e>t?1:t>e?-1:0},n=function(e,t){return o(t,e)};return this.comparator=o,_.str.startsWith(t,"d")&&(this.comparator=n),this.sort_key=e,this.sort(),this},get_or_create:function(e,t){var i=this,o=this.where({name:e});if(o){var n=o[0],r=$.Deferred(),a=function(){t&&t.success&&t.success(n),r.resolve(n)};if(n)console.log("ProjectModel.load"),n.fetch({success:function(){$.when(n.fetchRelated("basket")).then(a)}});else{console.log("ProjectModel.create");var s=new BasketModel;s.save(null,{success:function(){n=new ProjectModel({name:e,created:now_iso(),basket:s}),i.create(n,{success:function(){i.add(n),$.when(n.fetchRelated("basket")).then(function(){var e=n.get("basket");e.save({project:n},{success:function(){n.fetch({success:function(){$.when(n.fetchRelated("basket")).then(a)},error:function(e){console.error("Could not fetch project: "+JSON.stringify(e)),r.reject(e)}})}})})}})}})}return r}}}),ProjectChooserView=Backbone.Marionette.ItemView.extend({template:"#project-chooser-template",initialize:function(){console.log("ProjectChooserView.initialize"),this.data_list_selector="#project-chooser-list ul",this.listenTo(this.model,"change",this.render),this.listenTo(this,"item:rendered",this.setup_ui)},onDomRefresh:function(){console.log("ProjectChooserView.onDomRefresh")},projectname_validate:function(e){if(!e)return"Project name must not be empty";var t=this.collection.where({name:e});return _.isEmpty(t)?void 0:"Project name already exists"},setup_ui:function(){console.log("ProjectChooserView.setup_ui");var e=this;$("#project-chooser-name").editable({mode:"inline",placeholder:"Enter project name",success:function(t,i){e.model.set("name",i),e.model.save()},validate:function(t){return e.projectname_validate(t)}}),this.set_name(this.model.get("name"));var t=$(this.data_list_selector),i=this.collection;t.empty(),i.sortByField("modified","desc").each(function(e){var i=e.get("name"),o=e.get("modified"),n=_.template('<li><a class="incognito" href="javascript: void(0);" data-value="<%= name %>"><%= name %> <span class="pull-right"><%= modified %></span></a></li>')({name:i,modified:moment(o).fromNow()});t.append(n)}),t.find("a").click(function(){var e=$(this).data("value");opsChooserApp.trigger("project:load",e)}),$(this.el).find("#project-delete-button").click(function(){var t=opsChooserApp.config.get("project");_ui.confirm('This will delete the current project "'+t+'". Are you sure?').then(function(){e.model.destroy({success:function(){_ui.notify('Project "'+e.model.get("name")+'" deleted.',{type:"success",icon:"icon-trash"});var t=e.collection.sortByField("modified","desc").first();if(t){var i=t.get("name");opsChooserApp.trigger("project:load",i)}else{opsChooserApp.basketModel.destroy(),delete opsChooserApp.basketModel;var i=opsChooserApp.config._originalAttributes.project;opsChooserApp.config.set("project",i),opsChooserApp.trigger("projects:initialize"),_ui.notify('Project "'+e.model.get("name")+'" deleted.<br/>Recreated default project.',{type:"success",icon:"icon-trash"})}}})})}),$(this.el).find("#project-create-button").unbind(),$(this.el).find("#project-create-button").click(function(t){t.stopPropagation(),t.preventDefault(),$(this).popover("hide");var i=$("#project-chooser-name");i.unbind();i.editable("getValue",!0);i.editable("destroy"),i.editable({mode:"inline",toggle:"manual",placeholder:"Enter project name",success:function(e,t){opsChooserApp.trigger("project:load",t),_ui.notify('Project "'+t+'" created.',{type:"success",icon:"icon-plus"})},validate:function(t){return e.projectname_validate(t)}}),i.editable("show"),i.editable("setValue",""),i.on("hidden",function(t,o){"save"!=o&&(i.editable("destroy"),e.setup_ui())})})},set_name:function(e){e?$("#project-chooser-name").editable("setValue",e):$("#project-chooser-name").hide()},clear:function(){this.set_name(),$(this.data_list_selector).empty()}}),opsChooserApp.addInitializer(function(){this.listenTo(this,"project:load",function(e){var t;this.project&&(t=this.project.get("name"));var i=this;$.when(this.projects.get_or_create(e)).done(function(o){i.trigger("project:ready",o),e!=t&&i.trigger("project:changed",o)}).fail(function(){i.trigger("project:ready")})}),this.listenTo(this,"projects:initialize",function(e){console.log("projects:initialize"),e||(e=this.config.get("project")),this.projects=new ProjectCollection;var t=this;this.projects.fetch({success:function(){t.trigger("project:load",e)}})}),this.listenTo(this,"results:ready",function(){var e=this.metadata.get("result_count");this.project.query_recorded&&(this.project.query_recorded.set("result_count",e),this.project.query_recorded.save())}),this.LOAD_IN_PROGRESS||this.trigger("projects:initialize")}),QueryBuilderView=Backbone.Marionette.ItemView.extend({template:"#querybuilder-template",initialize:function(){console.log("QueryBuilderView.initialize"),this.config=this.templateHelpers.config=opsChooserApp.config},templateHelpers:{},onDomRefresh:function(){console.log("QueryBuilderView.onDomRefresh"),this.setup_ui_base(),this.setup_ui_actions()},setup_ui_base:function(){console.log("QueryBuilderView.setup_ui");var e=this;opsChooserApp.config.get("ftpro_enabled")&&$("#datasource > button[data-value='ftpro']").show(),$("#datasource").on("click",".btn",function(){opsChooserApp.set_datasource($(this).data("value")),e.setup_ui_query_textarea()}),$('#querybuilder-flavor-chooser button[data-toggle="tab"]').on("shown",function(t){var i=$(t.target).data("value");i&&(e.comfort_form_zoomed_to_regular_data(),e.cql_field_chooser_setup("cql"!=i),$(".btn-query-perform").unbind("click"),"comfort"==i?(e.comfort_form_zoomed_to_regular_ui(),$("#patentnumber").focus(),$("#querybuilder-comfort-actions").show(),$("#querybuilder-cql-actions").hide(),$("#querybuilder-numberlist-actions").hide(),$("#cql-history-chooser").show(),$(".btn-query-perform").click(function(){$("#querybuilder-comfort-form").submit()})):"cql"==i?($("#query").focus(),$("#querybuilder-comfort-actions").hide(),$("#querybuilder-cql-actions").show(),$("#querybuilder-numberlist-actions").hide(),$("#cql-history-chooser").show(),e.compute_comfort_query(),$(".btn-query-perform").click(function(){opsChooserApp.disable_reviewmode(),opsChooserApp.perform_search({reviewmode:!1,clear:!0,flavor:i})}),e.setup_ui_query_textarea()):"numberlist"==i&&($("#numberlist").focus(),$("#querybuilder-comfort-actions").hide(),$("#querybuilder-cql-actions").hide(),$("#querybuilder-numberlist-actions").show(),$("#cql-history-chooser").hide(),opsChooserApp.set_datasource("ops"),$(".btn-query-perform").click(function(){opsChooserApp.disable_reviewmode(),opsChooserApp.perform_numberlistsearch({reviewmode:!1,clear:!0})})))}),$("#querybuilder-comfort-form").unbind(),$("#querybuilder-comfort-form").submit(function(){e.comfort_form_zoomed_to_regular_data();var t=e.get_comfort_form_data();e.compute_comfort_query().then(function(){opsChooserApp.disable_reviewmode(),opsChooserApp.perform_search({reviewmode:!1,clear:!0,flavor:e.get_flavor(),query_data:t})})}),$(".btn-query-perform").unbind("click"),$(".btn-query-perform").click(function(){$("#querybuilder-comfort-form").submit()}),$(".btn-full-cycle").on("click",function(e){e.stopPropagation(),"button"!=$(this).attr("data-toggle")&&$(this).toggleClass("active"),opsChooserApp.config.set("mode.full-cycle",$(this).hasClass("active"))})},setup_ui_query_textarea:function(){if(!opsChooserApp.config.get("debug"))if("ftpro"==opsChooserApp.get_datasource()){$("#query").hide(),$("#query").parent().find("#query-alert").remove(),$("#query").parent().append('<div id="query-alert" class="alert alert-default">Expert mode not available for datasource "FulltextPRO".</div>');var e=$("#query").parent().find("#query-alert");e.height($("#query").height()-18)}else $("#query").parent().find("#query-alert").remove(),$("#query").show()},query_empty:function(){return _.isEmpty($("#query").val().trim())},check_query_empty:function(e){return this.query_empty()?(opsChooserApp.ui.notify("Query expression is empty",{type:"warning",icon:e.icon}),!0):!1},numberlist_empty:function(){return _.isEmpty($("#numberlist").val().trim())},check_numberlist_empty:function(e){return this.numberlist_empty()?(opsChooserApp.ui.notify("Numberlist is empty",{type:"warning",icon:e.icon}),!0):!1},get_comfort_form_entries:function(e){e=e||{};var t=[];return _.each($("#querybuilder-comfort-form").find("input"),function(i){var o=$(i),n=o.attr("name"),r=o.val();if(r||!e.skip_empty){var a=n+":";a=_.string.rpad(a,16," "),t.push(a+r)}}),t},setup_ui_actions:function(){var e=this;$("#btn-comfort-display-values").unbind("click"),$("#btn-comfort-display-values").click(function(){var t='<a id="comfort-form-copy-button" role="button" class="btn"><i class="icon-copy"></i> &nbsp; Copy to clipboard</a>',i=e.get_comfort_form_entries(),o=i.join("\n"),n="<pre>"+o+"</pre>"+t,r=bootbox.dialog(n,[{label:"OK",icon:"OK",callback:null}],{header:"Contents of comfort form"}),t=r.find("#comfort-form-copy-button");_ui.copy_to_clipboard_bind_button("text/plain",o,{element:t[0],wrapper:r[0]})}),$("#btn-comfort-clear").unbind("click"),$("#btn-comfort-clear").click(function(){e.clear_comfort_form()}),$("#btn-query-clear").unbind("click"),$("#btn-query-clear").click(function(){$("#query").val("").focus()}),$("#btn-query-transform").unbind("click"),$("#btn-query-transform").click(function(){e.check_query_empty({icon:"icon-exchange"})||$("#clipboard-modifier-chooser").modal("show")}),$("#btn-query-history").unbind("click"),$("#btn-query-history").click(function(t){e.cql_history_chooser_setup().then(function(){var e=$("#cql-history-chooser").hasClass("open");e&&(t.preventDefault(),t.stopPropagation());var i=$("#cql-history-chooser-select2");setTimeout(function(){i.select2("open")})})}),$("#btn-query-permalink").unbind("click"),$("#btn-query-permalink").click(function(t){if(t.preventDefault(),!e.check_query_empty({icon:"icon-external-link"})){var i=this,o={mode:"liveview",context:"viewer",project:"query-permalink",query:opsChooserApp.get_query(),datasource:opsChooserApp.get_datasource()};opsChooserApp.permalink.make_uri_opaque(o).then(function(e){t.stopPropagation(),opsChooserApp.permalink.popover_show(i,e,{title:"External query review",intro:"<small>This offers a link for external/anonymous users to review the current query. </small>",ttl:!0})})}}),$(".btn-clipboard-modifier").click(function(){var e=$(this).data("modifier"),t=$("#clipboard-modifier-operator").find(".btn.active").data("value")||"OR";$("#clipboard-modifier-chooser").modal("hide");var i=$("#query").val().trim();if(!_.str.contains(i,"=")){var o=i.split("\n"),n=_(o).map(function(t){return e+'="'+t+'"'}).join(" "+t+" ");$("#query").val(n),$("#query").focus()}}),$("#btn-numberlist-normalize").unbind("click"),$("#btn-numberlist-normalize").click(function(t){t.preventDefault(),e.check_numberlist_empty({icon:"icon-exchange"})||e.normalize_numberlist($("#numberlist").val()).then(function(e){var t=e["numbers-normalized"]&&e["numbers-normalized"].valid,i=e["numbers-normalized"]&&e["numbers-normalized"].invalid;if($("#numberlist").val(t.join("\n")),_.isEmpty(i))opsChooserApp.ui.notify("Patent numbers normalized successfully",{type:"success",icon:"icon-exchange",right:!0});else{var o="Number normalization failed for:<br/><br/><pre>"+i.join("\n")+"</pre>";opsChooserApp.ui.user_alert(o,"warning")}})})},clear_comfort_form:function(){$("#querybuilder-comfort-form").find("input").val("")},normalize_numberlist:function(e){var t=$.Deferred();return $.ajax({method:"post",url:"/api/util/numberlist?normalize=true",beforeSend:function(e,t){e.requestUrl=t.url},async:!1,sync:!0,data:e,contentType:"text/plain; charset=utf-8"}).success(function(e){e?t.resolve(e):(opsChooserApp.ui.notify("Number normalization failed (empty response)",{type:"warning",icon:"icon-exchange",right:!0}),t.reject())}).error(function(e){opsChooserApp.ui.propagate_alerts(e),t.reject()}),t.promise()},setup_quick_cql_builder:function(){$(".btn-cql-boolean").button(),$("#cql-quick-operator").find(".btn-cql-boolean").click(function(){$("#query").focus()}),$(".btn-cql-field").click(function(){var e,t=$("#query").val(),i=$("#cql-quick-operator").find(".btn-cql-boolean.active").data("value"),o=$(this).data("value"),n=$("#query").caret(),r=!1,a=!0;if(0!=n){r=!0,e=t.substring(n-1,n),"="==e&&(r=!1,a=!1);var s=t.substring(n-5,n).toLowerCase();(_.string.contains(s,"and")||_.string.contains(s,"or"))&&(r=!1)}var c=e&&" "!=e?" ":"";r&&$("#query").caret(c+i),a&&$("#query").caret((r?" ":c)+o),$("#query").focus()})},cql_field_chooser_get_data:function(e){return"ops"==e?OPS_CQL_FIELDS:"depatisnet"==e?DEPATISNET_CQL_FIELDS:[]},cql_field_chooser_setup:function(e){var t=opsChooserApp.get_datasource(),i=opsChooserApp.queryBuilderView.get_flavor(),o=$("#analytics-actions")[0];if("comfort"==i?$(o).show():$(o).hide(),e||!t||_(["review","google","ftpro"]).contains(t)||"cql"!=i){var n=$("#cql-field-chooser")[0].previousSibling;return void $(n).hide()}var r=this.cql_field_chooser_get_data(t);$("#cql-field-chooser").select2({placeholder:"CQL field symbols ("+t+")",data:{results:r},dropdownCssClass:"bigdrop",escapeMarkup:function(e){return e}}),$("#cql-field-chooser").on("change",function(){var e=$(this).val();if(e){var t=$("#query").val(),i=$("#query").caret(),o=t.substring(i-1,i);"="!=o&&(" "!=o&&0!=i&&(e=" "+e),$("#query").caret(e+"="),$(this).data("select2").clear())}})},cql_history_chooser_get_data:function(){log("cql_history_chooser_get_data");var e=$.Deferred(),t=this;return $.when(opsChooserApp.project.fetch_queries()).then(function(){var i=opsChooserApp.project.get("queries");i=sortCollectionByField(i,"created","desc");var o=i.map(function(e){return t.query_model_repr(e)});e.resolve(o)}).fail(function(){e.reject()}),e.promise()},query_model_repr:function(e){var t=e.get("flavor"),i=e.get("datasource"),o=e.get("query_data"),n=e.get("created"),r=e.get("result_count"),a=e.get("query_expression");if(("comfort"==t||"ftpro"==i)&&o&&_.isObject(o.criteria)){var s=_.map(o.criteria,function(e,t){if("fulltext"==t&&o.modifiers&&o.modifiers.fulltext)if(_.every(_.values(o.modifiers.fulltext)))e+=" [all]";else{var i=_.objFilter(o.modifiers.fulltext,function(e){return Boolean(e)});e+=" ["+_.keys(i).join(",")+"]"}return t+": "+e});a=s.join(", ")}n=moment(n).fromNow();var c=i;"ops"==i?c="EPO":"depatisnet"==i?c="DPMA":"ftpro"==i&&(c="FulltextPRO"),a+='<div class="pull-right"><small>'+[t,c,n,(r?r:"no")+(1==r?" hit":" hits")].join(", ")+'</small></div><div class="clearfix"></div>';var l={id:e,text:a};return l},cql_history_chooser_setup:function(){var e=$.Deferred(),t=opsChooserApp.project.get("name"),i=$("#cql-history-chooser-select2");i.select2({placeholder:"Query history ("+t+")",data:{results:[]},dropdownCssClass:"bigdrop",escapeMarkup:function(e){return e}});var o=this;return i.unbind("change"),i.on("change",function(){$(this).unbind("change");var e=$(this).val();if(e){var t=e.get("flavor");if("cql"==t&&(o.disable_compute_comfort_query=!0),o.set_flavor(t),opsChooserApp.set_datasource(e.get("datasource")),"comfort"==t){var i=e.get("query_data");o.clear_comfort_form(),o.set_comfort_form_data(i)}else if("cql"==t){var n=e.get("query_expression");o.clear_comfort_form(),$("#query").val(n)}}$(this).data("select2").destroy(),$(this).dropdown().toggle()}),this.cql_history_chooser_get_data().then(function(t){i.select2({data:t,escapeMarkup:function(e){return e}}),e.resolve()}),e.promise()},setup_comfort_form:function(){var e=$("#querybuilder-comfort-form"),t=opsChooserApp.get_datasource(),i=this;e.handle_enter_keypress();var o=e.find("input[name='pubdate']").closest("div[class='control-group']");_(["ops","depatisnet","ftpro"]).contains(t)?o.show():_(["google"]).contains(t)&&o.hide();var n=e.find("input[name='citation']").closest("div[class='control-group']");_(["ops","depatisnet"]).contains(t)?n.show():_(["google","ftpro"]).contains(t)&&n.hide();var r=e.find("input[name='patentnumber']");_(["google","ftpro"]).contains(t)?r.attr("placeholder",r.data("placeholder-single")):r.attr("placeholder",r.data("placeholder-multi")),_.each(e.find(".input-prepend"),function(e){$(e).find(".add-on.add-on-label").on("click",function(){var t=$(e).find("input");if(!t.val()){var i=t.attr("placeholder");t.data("demo")&&(i=t.data("demo")),t.val(i)}}),$(e).find(".add-on.add-on-zoom").on("click",function(){var t=$(e).find("input");i.comfort_form_regular_to_zoomed(t)})}),_(["ftpro"]).contains(t)?($("#fulltext-modifier-chooser").show(),$("#fulltext-textarea-container").removeClass("span12").addClass("span11"),$("#fulltext-textarea-container").find("textarea").removeClass("span11").addClass("span10")):($("#fulltext-modifier-chooser").hide(),$("#fulltext-textarea-container").removeClass("span11").addClass("span12"),$("#fulltext-textarea-container").find("textarea").removeClass("span10").addClass("span11"))},comfort_form_regular_to_zoomed:function(e){var t=e.attr("name"),i=e.val(),o=$("#querybuilder-comfort-form > fieldset");o.children(".field-regular").hide();var n=o.children("#"+t+"-zoomed");n.fadeIn();var r=n.find("textarea");r.val(i),r.focus(),opsChooserApp.hotkeys.querybuilder_zoomed_hotkeys(r,e),opsChooserApp.hotkeys.querybuilder_hotkeys(r)},comfort_form_zoomed_to_regular_data:function(){var e=$("#querybuilder-comfort-form > fieldset"),t=e.children(".field-zoomed").is(":visible");if(t){var i=e.children(".field-zoomed:visible").find("textarea"),o=i.data("name"),n=i.val();e.find('input[name="'+o+'"]').val(n)}},comfort_form_zoomed_to_regular_ui:function(e){var t=$("#querybuilder-comfort-form > fieldset");t.children(".field-zoomed").hide(),t.children(".field-regular").fadeIn(),e&&e.focus()},set_comfort_form_data:function(e,t){t=t||{};var i=$("#querybuilder-comfort-form");_.each(e.criteria,function(e,t){var o=i.find('input[name="'+t+'"]');o.val(e)}),e.modifiers&&_.isObject(e.modifiers.fulltext)&&_.each(e.modifiers.fulltext,function(e,t){var o=$(i).find($('button[data-name="fulltext"][data-modifier="'+t+'"]'));e?o.addClass("active"):o.removeClass("active")})},get_comfort_form_data:function(){var e=$("#querybuilder-comfort-form"),t=opsChooserApp.get_datasource(),i={},o={},n=$(e).find($("input"));if(_.each(n,function(e){e.value&&(i[e.name]=e.value)}),!_.isEmpty(i)){var r=$(e).find($('button[data-name="fulltext"]')),o={};_.each(r,function(e){var t=$(e).data("name"),i=$(e).data("modifier"),n=$(e).hasClass("active"),r={};r[t]={},_.defaults(o,r),o[t][i]=n});var a={format:"comfort",datasource:t,criteria:i,modifiers:o};return a}},compute_comfort_query:function(){if(this.disable_compute_comfort_query){this.disable_compute_comfort_query=!1;var e=$.Deferred();return e.reject(),e}var t=this.get_comfort_form_data();if(_.isEmpty(t)){var e=$.Deferred();return e.reject(),e}return log("comfort form query:",JSON.stringify(t)),$("#keywords").val("[]"),this.compute_query_expression(t).then(function(e,t){$("#query").val(e),$("#keywords").val(t)}).fail(function(){$("#query").val(""),$("#keywords").val(""),opsChooserApp.ui.reset_content({documents:!0,keep_notifications:!0})})},compute_query_expression:function(e){var t=$.Deferred();return $.ajax({method:"post",url:"/api/util/query-expression",beforeSend:function(e,t){e.requestUrl=t.url},async:!1,sync:!0,data:JSON.stringify(e),contentType:"application/json; charset=utf-8"}).success(function(e,i,o){if(e){var n=o.getResponseHeader("X-Elmyra-Query-Keywords");t.resolve(e,n)}else t.resolve("","[]")}).error(function(e){opsChooserApp.ui.propagate_alerts(e),t.reject()}),t.promise()},get_flavor:function(){var e=$("#querybuilder-flavor-chooser > .btn.active").data("value");return e},set_flavor:function(e){$("#querybuilder-flavor-chooser .btn[data-value='"+e+"']").tab("show")},set_numberlist:function(e){_.isEmpty(e)||(this.set_flavor("numberlist"),$("#numberlist").val(e),opsChooserApp.perform_numberlistsearch())}}),opsChooserApp.addInitializer(function(){this.queryBuilderView=new QueryBuilderView({}),this.queryBuilderRegion.show(this.queryBuilderView),this.listenTo(this,"application:ready",function(){var e=this.config.get("numberlist");if(e){var t=decodeURIComponent(e);this.queryBuilderView.set_numberlist(t)}})}),StoragePlugin=Marionette.Controller.extend({initialize:function(){console.log("StoragePlugin.initialize"),this.database_version="0.0.1"},dump:function(){var e=this,t=$.Deferred();return localforage.keys().then(function(i){var o={},n=[];_.each(i,function(e){var t=$.Deferred();n.push(t),localforage.getItem(e).then(function(i){o[e]=i,t.resolve()})}),$.when(deferreds_bundle(n)).then(function(){var i={database:o,metadata:{type:"elmyra.ipsuite.navigator.database",description:"Database dump of Elmyra IP suite navigator",software_version:opsChooserApp.config.get("setting.app.software.version"),database_version:e.database_version,database_name:localforage.config("name"),created:timestamp(),useragent:navigator.userAgent}};t.resolve(i)})}),t.promise()},dbexport:function(){this.dump().then(function(e){var t=JSON.stringify(e,void 0,4),i="ipsuite-database_"+now_iso_filename()+".json";if(!t)return void _ui.notify("Database export failed",{type:"error",icon:"icon-save"});var o=new Blob([t],{type:"application/json"});saveAs(o,i);var n=Math.round(o.size/1e3);_ui.notify("Database exported successfully, size is "+n+"kB.",{type:"success",icon:"icon-save"})})},dbimport:function(e){log("StoragePlugin.dbimport");var t=e;if("string"==typeof e){if(_.string.startsWith(e,"data:")){var i=dataurl.parse(e);if(i&&(e=i.data),!i||!e){var o="ERROR: data URL format is invalid";return console.error(o+"; payload="+e),void _ui.notify(o,{type:"error"})}}try{t=jQuery.parseJSON(e)}catch(n){var r=n.message,o="ERROR: JSON format is invalid, "+r;return console.error(o+"; payload="+e),void _ui.notify(o,{type:"error"})}}var a=dotresolve(t,"metadata.type"),s=dotresolve(t,"database");if("elmyra.ipsuite.navigator.database"!=a||!s){var o="ERROR: Database dump format is invalid";return console.error(o),void _ui.notify(o,{type:"error"})}var c=[];_.each(_.keys(s),function(e){var t=$.Deferred();c.push(t.promise());var i=s[e];"Project"==e?localforage.getItem(e).then(function(o){o&&i&&(i=_.union(o,i)),localforage.setItem(e,i).then(function(){t.resolve()})}):localforage.setItem(e,i).then(function(){t.resolve()})}),$.when(deferreds_bundle(c)).then(function(){Backbone.Relational.store.reset(),opsChooserApp.trigger("projects:initialize"),_ui.notify("Database imported successfully",{type:"success",icon:"icon-folder-open-alt"})})},dbreset:function(e){log("dbreset"),e=e||{},e.shutdown_gui&&opsChooserApp.shutdown_gui(),Backbone.Relational.store.reset(),localforage.clear().then(function(){log("localforage.clear SUCCESS")
},function(){log("localforage.clear FAIL")})},setup_ui:function(){console.log("StoragePlugin.setup_ui");var e=this;$("#data-export-button").unbind("click"),$("#data-export-button").on("click",function(){e.dbexport($(this).parent())}),$("#data-import-file").unbind("change"),$("#data-import-file").on("change",function(t){t.stopPropagation(),t.preventDefault(),opsChooserApp.project_deactivate();var i=this.files[0];if(i){$(this).val(void 0);var o=i.type,n=_.string.contains(navigator.userAgent,"Windows");if(n&&""==i.type&&_.string.endsWith(i.name,".json")&&(o="application/json"),"application/json"!=o){var r="ERROR: File type is "+(o?o:"unknown")+", but should be application/json";return void _ui.notify(r,{type:"error"})}var a=new FileReader;a.onload=function(t){var i=t.target.result;e.dbimport(i)},a.onerror=function(e){var t="ERROR: Could not read file "+i.name+", message="+e.getMessage();_ui.notify(t,{type:"error"})},a.readAsText(i)}}),$("#data-import-button").unbind("click"),$("#data-import-button").on("click",function(){opsChooserApp.project_deactivate(),$("#data-import-file").click()}),$("#database-wipe-button").unbind(),$("#database-wipe-button").click(function(){_ui.confirm("This will wipe the whole local database including custom keywords. Are you sure?").then(function(){e.dbreset({shutdown_gui:!0}),_ui.notify("Database wiped successfully. You should create a new project before starting over.",{type:"success",icon:"icon-trash"})})})}}),ViewportPlugin=Marionette.Controller.extend({initialize:function(e){console.log("ViewportPlugin.initialize"),this.app=e.app,this.bottom_area_height=20},get_document:function(){var e=$(".document-actions:in-viewport").closest(".ops-collection-entry").first();return e},get_document_number_in_focus:function(){var e=this.get_document(),t=$(e).data("document-number");return t},get_rating_widget:function(e){return $("#rate-patent-number-"+e)},document_add_basket:function(){var e=this.get_document_number_in_focus();e&&this.app.basketModel.add(e)},document_remove_basket:function(){var e=this.get_document_number_in_focus();e&&this.app.basketModel.remove(e)},document_rate:function(e,t){t=t||!1;var i=this.get_document_number_in_focus();return this.app.document_rate(i,e,t)},next_item:function(e){e=e||{};var t,i=$(".ops-collection-entry:in-viewport");if(!i.exists())return t=$(".ops-collection-entry:below-the-fold");var o=i.parent().next().find(".ops-collection-entry").first(),n=$(window).scrollTop()+$(window).height()>getDocumentHeight()-this.bottom_area_height,r=!1,a=$(window).scrollTop(),s=Math.floor(i.offset().top);if(s-3>a?(t=i,r=n):(t=o,r=n||!o.exists()),r&&e.paging)try{return void opsChooserApp.paginationViewBottom.set_page("next")}catch(c){}return t},previous_item:function(e){e=e||{};var t,i=$(".ops-collection-entry:in-viewport");if(i.length)if($(window).scrollTop()>i.offset().top)t=i;else{if(t=i.closest(".ops-collection-entry").first(),t[0]===i[0]){t=$(".ops-collection-entry:above-the-top").last();var o=!t.exists();if(o&&e.paging)try{opsChooserApp.paginationViewBottom.set_page("previous")}catch(n){}}t.exists()||(t=$("body"))}return t}}),opsChooserApp.addInitializer(function(){this.viewport=new ViewportPlugin({app:this})}),ResultCollection=Backbone.Collection.extend({initialize:function(){this.document_numbers=[]},set_reference_document_numbers:function(e){this.reference_document_numbers=e},model:function(e,t){return"ftpro"==e.upstream_provider?new FulltextProResultEntry(e,t):void console.error('Could not create result model instance for upstream provider "'+e.upstream_provider+'"')}}),DatasourceSearch=Backbone.Model.extend({keywords:[],perform:function(e,t){var i={query:e};_.extend(i,t),log("DatasourceSearch.query_parameters:",i),opsChooserApp.ui.indicate_activity(!0);var o=this,n=t;return this.fetch({data:$.param(i),success:function(e,t,i){opsChooserApp.ui.indicate_activity(!1);var r=i.xhr.getResponseHeader("X-Elmyra-Query-Keywords");if(r&&(o.keywords=o.decode_header_json(r)||[]),_.isEmpty(o.keywords)){var a=n.keywords;o.keywords=o.decode_header_json(a)||[]}},error:function(e,t){console.log("DatasourceSearch error: "+t.responseText),opsChooserApp.ui.indicate_activity(!1),opsChooserApp.ui.reset_content({documents:!0}),opsChooserApp.ui.propagate_alerts(t,{url:o.url})}})},decode_header_json:function(e){if(e){e="["+e+"]";var t=jQuery.parseJSON(e);if(!_.isEmpty(t))return t[0]}}}),DepatisnetSearch=DatasourceSearch.extend({url:"/api/depatisnet/published-data/search"}),DepatisnetCrawler=Marionette.Controller.extend({initialize:function(e){log("DepatisnetCrawler.initialize"),e=e||{},this.query=e.query,this.constituents=e.constituents},start:function(){var e=$.Deferred(),t=_.template("/api/depatisnet/published-data/crawl/<%= constituents %>?query=<%= query %>"),i=t({constituents:this.constituents,query:this.query}),o=this;return $.ajax({url:i,async:!0}).success(function(t){if(t)if("pub-number"==o.constituents){var i=t.numbers;e.resolve(i)}else e.reject('Unknown constituents "'+o.constituents+'"');else e.reject("Empty response")}).error(function(t){e.reject("API failed: "+JSON.stringify(t))}),e}}),DepatisConnectFulltext=Marionette.Controller.extend({initialize:function(e){log("DepatisConnectFulltext.initialize"),this.document_number=e},get_claims:function(){var e=this,t=$.Deferred(),i=_.template("/api/depatisconnect/<%= document_number %>/claims")({document_number:this.document_number});return $.ajax({url:i,async:!0}).success(function(e){if(e){var i={html:e.xml,lang:e.lang};t.resolve(i)}}).error(function(i){console.warn("Error while fetching claims from DEPATISconnect for",e.document_number,i),t.resolve({html:"No data available"})}),t.promise()},get_description:function(){var e=this,t=$.Deferred(),i=_.template("/api/depatisconnect/<%= document_number %>/description")({document_number:this.document_number});return $.ajax({url:i,async:!0}).success(function(e){if(e){var i={html:e.xml,lang:e.lang};t.resolve(i)}}).error(function(i){console.warn("Error while fetching description from DEPATISconnect for",e.document_number,i),t.resolve({html:"No data available"})}),t.promise()},get_abstract:function(e){var t=this,i=$.Deferred(),o="/api/depatisconnect/<%= document_number %>/abstract";e&&(o+="?language=<%= language %>");var n=_.template(o)({document_number:this.document_number,language:e});return $.ajax({url:n,async:!0}).success(function(e){if(e&&e.xml){var o={html:e.xml,lang:e.lang};i.resolve(o)}else console.warn("DEPATISconnect: Empty abstract for",t.document_number),i.reject({html:"Abstract for this document is empty, see original data source"})}).error(function(e){console.warn("DEPATISconnect: Error while fetching abstract for",t.document_number,e),i.reject({html:"No data available",error:e})}),i.promise()}}),FulltextProSearch=DatasourceSearch.extend({url:"/api/ftpro/published-data/search"}),FulltextProResultEntry=Backbone.Model.extend({defaults:{}}),FulltextProCrawler=Marionette.Controller.extend({initialize:function(e){log("FulltextProCrawler.initialize"),e=e||{},this.query=e.query,this.constituents=e.constituents},start:function(){var e=$.Deferred(),t=_.template("/api/ftpro/published-data/crawl/<%= constituents %>?query=<%= query %>"),i=t({constituents:this.constituents,query:this.query}),o=this;return $.ajax({url:i,async:!0}).success(function(t){if(t)if("pub-number"==o.constituents){var i=t.numbers;e.resolve(i)}else e.reject('Unknown constituents "'+o.constituents+'"');else e.reject("Empty response")}).error(function(t){e.reject("API failed: "+JSON.stringify(t))}),e}}),GooglePatentSearch=DatasourceSearch.extend({url:"/api/google/published-data/search"}),OpsPublishedDataSearch=Backbone.Model.extend({url:"/api/ops/published-data/search",keywords:[],perform:function(e,t,i,o){log("OpsPublishedDataSearch.perform"),opsChooserApp.ui.indicate_activity(!0);var n=this;return this.fetch({data:$.param({query:i,range:o}),success:function(i,o,r){var a=r.xhr.getResponseHeader("X-Elmyra-Query-Keywords");if(a&&(a=a.replace(/(.+), \[.+\]/,"$1"),n.keywords=jQuery.parseJSON(a)),opsChooserApp.ui.indicate_activity(!1),opsChooserApp.ui.reset_content(),console.log("response data:",o),_.isEmpty(o))return void e.reset();var s=o["ops:world-patent-data"]["ops:biblio-search"]["ops:search-result"],c=[];if(!_.isEmpty(s)){var l=[],u=to_list(s["exchange-documents"]);_(u).each(function(e){var t=to_list(e["exchange-document"]),i=[];if(_(t).each(function(e){i.push(new OpsExchangeDocument(e))}),_(t).each(function(e){e["bibliographic-data"]["full-cycle"]=i}),opsChooserApp.config.get("mode.full-cycle"))l=$.merge(l,t);else{var o=t[0];l.push(o)}}),c=n.make_models(l)}e.reset(c);var p=o["ops:world-patent-data"]["ops:biblio-search"],d=p["@total-result-count"],h=p["ops:range"],m=h["@begin"]+"-"+h["@end"],f=p["ops:query"].$,g=f;t.set({result_count:d,result_range:m,result_count_received:c?c.length:0,query_origin:f,query_real:g}),t.set("keywords",_.union(n.keywords,t.get("keywords")))},error:function(e,t){console.log("OpsPublishedDataSearch error: "+t.responseText),opsChooserApp.ui.indicate_activity(!1),opsChooserApp.ui.reset_content({documents:!0});var t=jQuery.parseJSON(t.responseText);"error"==t.status&&(_.each(t.errors,function(e){var t=_.template($("#backend-error-template").html());e.description=e.description||{},_.isString(e.description)&&(e.description={content:e.description}),_(e.description).defaults({headers:{}});var i=t(e);$("#alert-area").append(i)}),$(".very-short").shorten({showChars:0,moreText:"more",lessText:"less"}))}})},make_models:function(e){var t=[];return _(e).each(function(e){if("invalid result"==e["@status"])console.error("OPS INVALID RESULT:",e);else{var i=new OpsExchangeDocument(e);t.push(i)}}),t}}),OpsExchangeMetadata=Backbone.Model.extend({defaults:{reviewmode:!1,datasource:"ops",searchmode:null,page_size:25,result_count:null,result_range:null,result_count_received:null,query_origin:null,query_real:null,pagination_entry_count:12,pagination_pagesize_choices:[25,50,75,100],pagination_current_page:1,keywords:[],maximum_results:{ops:2e3,depatisnet:1e3,google:1e3},get_url:function(){var e=window.location.pathname+"?query="+encodeURIComponent($("#query").val())+"&pagesize="+this.page_size;return e},get_url_print:function(){return this.get_url()+"&mode=print"},get_url_pdf:function(){var e=this.get_url()+"&pdf=true";return e}},initialize:function(){var e=$.url(window.location.href),t=e.param("pagesize");t&&this.set("page_size",parseInt(t))},resetToDefaults:function(){this.set(this.defaults)},resetSomeDefaults:function(e){this.set(_(this.defaults).pick("searchmode","result_count","result_range","result_count_received","query_origin","query_real","keywords")),e&&e.clear&&this.set(_(this.defaults).pick("pagination_current_page"))}}),OpsPublishedDataCrawler=Marionette.Controller.extend({initialize:function(e){log("OpsPublishedDataCrawler.initialize"),e=e||{},this.query=e.query,this.constituents=e.constituents},start:function(){var e=$.Deferred(),t=_.template("/api/ops/published-data/crawl/<%= constituents %>?query=<%= query %>"),i=t({constituents:this.constituents,query:this.query}),o=this;return $.ajax({url:i,async:!0}).success(function(t){if(t)if("pub-number"==o.constituents){var i=t["ops:world-patent-data"]["ops:biblio-search"]["ops:search-result"]["publication-numbers"];e.resolve(i)}else e.reject('Unknown constituents "'+o.constituents+'"');else e.reject("Empty response")}).error(function(t){e.reject("API failed: "+JSON.stringify(t))}),e}}),OpsHelpers=Backbone.Model.extend({enrich_links:function(e,t,i){var o=this;return _.map(e,function(e){return _.isString(e)?o.enrich_link(e,t,e,i):_.isObject(e)?(e.display=o.enrich_link(e.display,t,e.display,i),e):void 0})},enrich_link:function(e,t,i,o){i||(i=e);var n="print"==opsChooserApp.config.get("mode");if(n)return i;var r="external",a="_blank",s=null;o&&(i=o(i)),_.string.include(i," ")&&(i='"'+i+'"');var c;if("internal"==r?c=_.template('<a href="" class="query-link" data-query-attribute="<%= attribute %>" data-query-value="<%= value %>"><%= label %></a>'):"external"==r&&(s=encodeURIComponent(t+"="+i),c=_.template('<a href="?query=<%= query %>" class="query-link incognito" target="<%= target %>"><%= label %></a>')),c){var l=c({label:e,attribute:t,value:i,target:a,query:s});return l}}}),OpsBaseModel=Backbone.Model.extend({defaults:_({}).extend(OpsHelpers.prototype,{get_document_id:function(e,t,i){e=e||this;var o;if(t){var n=t+"-reference";o=to_list(e[n]["document-id"])}else o=to_list(e["document-id"]);var r=_(o).find(function(e){return e["@document-id-type"]==i}),a=this.flatten_document_id(r);return a.fullnumber="epodoc"==i?a.docnumber:(a.country||"")+(a.docnumber||"")+(a.kind||""),a.isodate=this.format_date(a.date),a},get_publication_reference:function(e,t){return this.get_document_id(e,"publication",t)},get_application_reference:function(e,t){return this.get_document_id(e,"application",t)},get_publication_number:function(e,t){var i=this.get_publication_reference(e,t);return i.fullnumber},get_application_number:function(e,t){var i=this.get_application_reference(e,t);return i.fullnumber},flatten_document_id:function(e){var t={};return _(e).each(function(e,i){if("@document-id-type"==i?i="format":"doc-number"==i&&(i="docnumber"),"object"==typeof e){var o=e.$;o&&(e=o)}t[i]=e}),t},format_date:function(e){return e?moment(e,"YYYYMMDD").format("YYYY-MM-DD"):void 0},get_citations_environment_button:function(){var e=_.template($("#ops-citations-environment-button-template").html());return e({data:this})},get_patent_citation_list:function(e,t,i){e=e||this,i=i||"docdb";var o=this,n=[];if(!e||!e["references-cited"])return[];var r=e["references-cited"];if(r){var a=to_list(r.citation);n=a.filter(function(e){return e.patcit}).map(function(e){var t=o.get_document_id(e.patcit,null,i),n=o.flatten_document_id(t).fullnumber;return _.isEmpty(n)&&(t=o.get_document_id(e.patcit,null,"epodoc"),n=o.flatten_document_id(t).fullnumber),n})}return t&&(n=this.enrich_links(n,"pn")),n}})}),OpsExchangeDocument=OpsBaseModel.extend({defaults:_({}).extend(OpsBaseModel.prototype.defaults,OpsHelpers.prototype,{selected:!1,get_patent_number:function(){return this["@country"]+this["@doc-number"]+this["@kind"]},get_document_number:function(){return this.get_patent_number()},get_publication_number:function(e){var t=this.get_publication_reference(e);return t.fullnumber},get_application_number:function(e){var t=this.get_application_reference(e);return t.fullnumber},get_full_cycle:function(){var e=[],t=this["bibliographic-data"]["full-cycle"];return _(t).each(function(t){e.push(t)}),e},get_publication_reference:function(e){return OpsBaseModel.prototype.defaults.get_publication_reference(this["bibliographic-data"],e)},get_application_reference:function(e){return OpsBaseModel.prototype.defaults.get_application_reference(this["bibliographic-data"],e)},get_patent_citation_list:function(e,t){return OpsBaseModel.prototype.defaults.get_patent_citation_list(this["bibliographic-data"],e,t)},get_title_list:function(){var e=[],t=this["bibliographic-data"]["invention-title"];return t&&(e=_.map(to_list(t),function(e){var t=e["@lang"]&&"["+e["@lang"].toUpperCase()+"] "||"";return t+e.$})),e},get_abstract_list:function(){var e=[],t=[];if(this["abstract"])var i=to_list(this["abstract"]),e=i.map(function(e){var i=to_list(e.p),o=i.map(function(e){return e.$}).join(" "),n=e["@lang"]?e["@lang"].toUpperCase():"",r=n?"["+n+"] ":"";return n&&t.push(n),r+o});var o=this["@country"];return"DE"!=o||_(t).contains("DE")||e.push('[DE] <a href="#" class="abstract-acquire" data-lang="de">OPS lacks german abstract, try to acquire from different data source</a>'),e},get_applicants:function(e){try{var t=this["bibliographic-data"].parties.applicants}catch(i){return[]}t=t||[];var o=t.applicant,n=this.parties_to_list(o,"applicant-name");return e&&(n=this.enrich_links(n,"applicant")),n},get_inventors:function(e){try{var t=this["bibliographic-data"].parties.inventors}catch(i){return[]}t=t||[];var o=t.inventor,n=this.parties_to_list(o,"inventor-name");return e&&(n=this.enrich_links(n,"inventor")),n},parties_to_list:function(e,t){var i="0",o={};_.each(e,function(e){var n=e["@data-format"],r=e["@sequence"],a=_.string.trim(e[t].name.$,", ");o[n]=o[n]||{},o[n][r]=a,r>i&&(i=r)});var n=[];return _.each(_.range(1,parseInt(i)+1),function(e){e=e.toString();var t=o.epodoc[e],i=o.original[e],r=i;t&&(r=t.replace(/\[.+?\]/,"").trim());var a={display:r,epodoc:t,original:i};n.push(a)}),n},has_ipc:function(){return Boolean(this["bibliographic-data"]["classification-ipc"])},get_ipc_list:function(e){var t=[],i=this["bibliographic-data"]["classification-ipc"];if(i){var o=to_list(i.text);t=_.map(o,function(e){return e.$})}return e&&(t=this.enrich_links(t,"ipc",quotate)),t},has_ipcr:function(){return Boolean(this["bibliographic-data"]["classifications-ipcr"])},get_ipcr_list:function(e){var t=[],i=this["bibliographic-data"]["classifications-ipcr"];if(i&&i["classification-ipcr"]){var o=to_list(i["classification-ipcr"]);t=_.map(o,function(e){return e.text.$})}return t=_(t).map(function(e){return e.substring(0,15).replace(/ /g,"")}),e&&(t=this.enrich_links(t,"ipc",quotate)),t},has_classifications:function(){return Boolean(this["bibliographic-data"]["patent-classifications"])},get_classification_schemes:function(){return["CPC","UC","FI","FTERM"]},get_classifications:function(e){var t={},i=this["bibliographic-data"]["patent-classifications"],o=["section","class","subclass","main-group","/","subgroup"],n=this;if(i&&i["patent-classification"]){var r=to_list(i["patent-classification"]);_(r).each(function(e){var i=e["classification-scheme"]["@scheme"],r={};r[i]=[],_.defaults(t,r);var a;if("CPC"==i){var s=[];_(o).each(function(t){if("/"==t)return void s.push("/");if(e[t]){var i=e[t].$;s.push(i)}else console.error('Unknown cpc classification field "'+t+'" for document "'+n.get_document_number()+'":',e)}),a=s.join("")}else"UC"==i||"FI"==i||"FTERM"==i?a=e["classification-symbol"].$:console.error('Unknown classification scheme "'+i+'" for document "'+n.get_document_number()+'":',e);_.isEmpty(a)||t[i].push(a)})}return e&&_.each(t,function(e,i){"CPC"==i&&(t[i]=n.enrich_links(e,"cpc",quotate))}),t},get_priority_claims:function(){var e=this,t=[],i=this["bibliographic-data"]["priority-claims"];if(i){var o=to_list(i["priority-claim"]);_(o).each(function(i){var o=e.get_document_id(i,null,"epodoc"),n=e.get_document_id(i,null,"original");if(!_.isEmpty(o)){var r='<td class="span2">'+(o.isodate||"--")+'</td><td class="span3">'+(o.docnumber&&e.enrich_link(o.docnumber,"spr")||"--")+"</td><td>";_.isEmpty(n.docnumber)||(r+="original: "+n.docnumber),r+="</td>",t.push(r)}})}return t},get_application_references:function(){var e=this.get_application_number("epodoc"),t=this.get_application_number("original"),i='<td class="span2">'+(this.get_application_date()||"--")+'</td><td class="span3">'+(this.enrich_link(e,"sap")||"--")+"</td><td>";return _.isEmpty(t)||(i+="original: "+t),i+="</td>"},has_citations:function(){return this["bibliographic-data"]&&Boolean(this["bibliographic-data"]["references-cited"])},get_citing_query:function(){var e="ct="+this.get_publication_number("epodoc");return e},get_same_citations_query:function(){var e=this.get_patent_citation_list(!1,"epodoc");return this.get_items_query(e,"ct","OR")},get_all_citations_query:function(){var e=this.get_patent_citation_list(!1,"epodoc");return this.get_items_query(e,"pn","OR")},get_items_query:function(e,t,i){e=e.slice(0,10),e=e.map(function(e){return t+"="+e});var o=e.join(" "+i+" ");return o},_expand_links:function(e){var t=/(http|ftp|https):\/\/[\w-]+(\.[\w-]+)+([\w.,@?^=%&amp;:\/~+#-]*[\w@?^=%&amp;\/~+#-])?/g;return _(e.match(t)).each(function(t){e=e.replace(t,'<a href="'+t+'" target="_blank">'+t+"</a>")}),e},_add_crossref:function(e){var t="print"==opsChooserApp.config.get("mode");return t?e:e+='&nbsp;&nbsp;<a href="http://search.crossref.org/?q='+encodeURIComponent(e.replace(/^- /,""))+'" target="_blank" class="incognito"><i class="icon-external-link"></i></a>'},get_npl_citation_list:function(){var e=this,t=[],i=this["bibliographic-data"]["references-cited"];if(i){var o=to_list(i.citation);t=o.filter(function(e){return e.nplcit}).map(function(e){return e.nplcit.text.$}).map(e._add_crossref)}return t},has_fulltext:function(){var e=["EP","WO","AT","CA","CH"];return e.push("DE"),e.push("US"),_(e).contains(this["@country"])},search_date:function(e){var t=null;return _.each(e,function(e){!t&&e.date&&e.date.$&&(t=e.date.$)}),t},get_publication_date:function(){return this.format_date(this.search_date(this["bibliographic-data"]["publication-reference"]["document-id"]))},get_application_date:function(){return this.format_date(this.search_date(this["bibliographic-data"]["application-reference"]["document-id"]))}}),initialize:function(){this.printmode="print"==opsChooserApp.config.get("mode")},get_document_number:function(){return this.attributes.get_patent_number()},select:function(){this.set("selected",!0)},unselect:function(){this.set("selected",!1)}}),OpsExchangeDocumentCollection=Backbone.Collection.extend({model:OpsExchangeDocument,initialize:function(){},get_document_numbers:function(){var e=[];return _.each(this.models,function(t){e.push(t.get_document_number()),_.each(t.attributes.get_full_cycle(),function(t){e.push(t.get_document_number())})}),e}}),OpsFulltext=Marionette.Controller.extend({initialize:function(e){log("OpsFulltext.initialize"),this.document_number=e},get_claims:function(){var e=this,t=$.Deferred(),i=_.template("/api/ops/<%= document_number %>/claims")({document_number:this.document_number});return $.ajax({url:i,async:!0}).success(function(e){if(e){var i=e["ops:world-patent-data"]["ftxt:fulltext-documents"]["ftxt:fulltext-document"].claims,o=_(to_list(i.claim["claim-text"])).map(function(e){return"<p>"+_(e.$).escape().replace(/\n/g,"<br/>")+"</p>"}),n=o.join("\n"),r={html:n,lang:i["@lang"]};t.resolve(r)}}).error(function(i){console.warn("Error while fetching claims from OPS for",e.document_number,i),t.resolve({html:"No data available"})}),t.promise()},get_description:function(){var e=this,t=$.Deferred(),i=_.template("/api/ops/<%= document_number %>/description")({document_number:this.document_number});return $.ajax({url:i,async:!0}).success(function(e){if(e){var i=e["ops:world-patent-data"]["ftxt:fulltext-documents"]["ftxt:fulltext-document"].description,o=_(to_list(i.p)).map(function(e){return"<p>"+_(e.$).escape().replace(/\n/g,"<br/><br/>")+"</p>"}),n=o.join("\n"),r={html:n,lang:i["@lang"]};t.resolve(r)}}).error(function(i){console.warn("Error while fetching description from OPS for",e.document_number,i),t.resolve({html:"No data available"})}),t.promise()}}),OpsFamilyMember=OpsBaseModel.extend({defaults:_({}).extend(OpsBaseModel.prototype.defaults,OpsHelpers.prototype,{}),parse:function(e){return e["priority-claim"]=to_list(e["priority-claim"]),e}}),OpsFamilyCollection=Backbone.Collection.extend({model:OpsFamilyMember,initialize:function(e,t){this.document_number=t.document_number,this.constituents=t.constituents},url:function(){var e=_.template("/api/ops/publication/<%= document_number %>/family/inpadoc")({document_number:this.document_number});return this.constituents&&(e+="?constituents="+this.constituents),e},parse:function(e){return to_list(e["ops:world-patent-data"]["ops:patent-family"]["ops:family-member"])}}),ResultItemView=Backbone.Marionette.ItemView.extend({tagName:"div",className:"row-fluid",serializeData:function(){var e=Backbone.Marionette.ItemView.prototype.serializeData.apply(this,arguments);return e.is_document_missing=!_(this.model.collection.reference_document_numbers).contains(this.model.get("publication_number")),e}}),ResultCollectionView=Backbone.Marionette.CompositeView.extend({tagName:"div",id:"resultcollection",className:"container",template:"#generic-collection-template",getItemView:function(e){return"ftpro"==e.get("upstream_provider")?FulltextProResultView:void console.error('Could not create result view instance for upstream provider "'+model.get("upstream_provider")+'"')},initialize:function(){console.log("ResultCollectionView.initialize")},onRender:function(){console.log("ResultCollectionView.onRender")}}),GenericResultView=Backbone.Marionette.ItemView.extend({tagName:"div",id:"result-view",className:"modal",template:"#result-template",initialize:function(){console.log("ResultView.initialize")},indicate_activity:function(e){e?(this.$el.find("#result-busy").show(),this.$el.find("#result-ready").hide()):(this.$el.find("#result-busy").hide(),this.$el.find("#result-ready").show())},user_message:function(e,t){return $("#result-info").empty(),opsChooserApp.ui.user_alert(e,t,"#result-info")},templateHelpers:{},events:{},setup_numberlist_buttons:function(e){var t=this,i=e.join("\n"),o=this.$el.find("#result-to-clipboard-button");_ui.copy_to_clipboard_bind_button("text/plain",i,{element:o[0],wrapper:this.el});var n=this.$el.find("#result-to-basket-button");n.unbind("click"),n.on("click",function(){$("#result-to-basket-indicator").removeClass("icon-plus").addClass("icon-spinner icon-spin"),setTimeout(function(){$.when(opsChooserApp.basketModel.add_multi(e)).then(function(){$("#result-to-basket-indicator").removeClass("icon-spinner icon-spin").addClass("icon-plus");var i="Added "+e.length+" patent numbers to document collection.";_ui.notify(i,{type:"success",icon:"icon-plus",wrapper:t.el})})},50)})},hide_buttons:function(){this.$el.find("#result-to-clipboard-button").hide(),this.$el.find("#result-to-basket-button").hide()},onShow:function(){this.start()},start:function(){this.indicate_activity(!0),this.user_message('Fetching results, please stand by. &nbsp; <i class="spinner icon-refresh icon-spin"></i>',"info");var e=this,t=this.fetcher_factory();t.start().then(function(t){e.setup_data(t),e.indicate_activity(!1);var i=0/0;_.isArray(t)&&(i=t.length),_.isObject(t)&&(i=Object.keys(t).length);var o=i+" result item(s) fetched successfully.";o+=e.message_more,e.user_message(o,"success")}).fail(function(t,i){e.indicate_activity(!1);var t='Error while fetching results from datasource "'+e.model.get("datasource")+'".<br/>Reason: '+t;e.user_message(t,"error"),console.warn(t,i)})}}),FulltextProResultView=ResultItemView.extend({template:_.template($("#ftpro-entry-template").html(),this.model,{variable:"data"}),initialize:function(){},templateHelpers:_({}).extend(OpsHelpers.prototype,{is_application_number_invalid:function(){return"JP"==this.cc&&(7==this.ApplicationNumber.length||8==this.ApplicationNumber.length)},get_linkable_application_number:function(){var e=this.cc+this.ApplicationNumber;return"JP"==this.cc&&"U"==this.kd&&this.ApplicationNumber.length<11&&(e=this.cc+this.ApplicationNumber.substring(0,4)+_.string.rjust(this.ApplicationNumber.substring(4),7,"0")+this.kd),e}})}),OpsBaseViewMixin={bind_query_links:function(e){e.find(".query-link").unbind("click"),e.find(".query-link").on("click",function(){var e=$(this).attr("href"),t=opsChooserApp.permalink.query_parameters_viewstate(e);if(t.datasource="ops",opsChooserApp.config.get("isviewer")){t.mode="liveview";var i=this;opaque_param(t).then(function(e){$(i).attr("href","?"+e)})}else $(this).attr("href","?"+jQuery.param(t))})},bind_same_citations_links:function(e){e.find(".same-citations-link").bind("click",function(e){var t=$(this).data("length");if(t>10){e.preventDefault(),e.stopPropagation(),opsChooserApp.ui.notify("List is capped to the first 10 cited references. Sorry for this limitation.",{type:"warning",icon:"icon-cut"});var i=this;setTimeout(function(){open($(i).attr("href"))},3e3)}})}},OpsExchangeDocumentView=Backbone.Marionette.Layout.extend({template:_.template($("#ops-entry-template").html(),this.model,{variable:"data"}),tagName:"div",className:"row-fluid",regions:{region_comment_button:"#region-comment-button",region_comment_text:"#region-comment-text"},initialize:function(){console.log("OpsExchangeDocumentView.initialize"),this.templateHelpers.config=opsChooserApp.config},templateHelpers:{get_linkmaker:function(){return new Ipsuite.LinkMaker(this)}},onDomRefresh:function(){console.log("OpsExchangeDocumentView.onDomRefresh");var e=$(this.el).find(".ops-collection-entry");$(e).prop("ops-document",this.model.attributes)},events:{"click .rank_up img":"rankUp","click .rank_down img":"rankDown","click a.disqualify":"disqualify"},render:function(){try{var e=Array.prototype.slice.apply(arguments),t=Backbone.Marionette.Layout.prototype.render.apply(this,e);return t}catch(i){console.error("Error while rendering OpsExchangeDocumentView:",i.message,i.stack);var e=Array.prototype.slice.apply(arguments);this.model.set("error_message",i.message),this.template="#ops-entry-error-template";var t=Backbone.Marionette.Layout.prototype.render.apply(this,e);return t}}}),OpsExchangeDocumentCollectionView=Backbone.Marionette.CompositeView.extend({tagName:"div",id:"opsexchangedocumentcollection",className:"container",template:"#ops-collection-template",itemView:OpsExchangeDocumentView,initialize:function(){console.log("OpsExchangeDocumentCollectionView.initialize")},_initialEvents:function(){this.collection&&(this.listenTo(this.collection,"remove",this.removeItemView,this),this.listenTo(this.collection,"reset",this.render,this))},close:function(){},onRender:function(){console.log("OpsExchangeDocumentCollectionView.onRender")},onDomRefresh:function(){console.log("OpsExchangeDocumentCollectionView.onDomRefresh")}}),MetadataView=Backbone.Marionette.ItemView.extend({tagName:"div",template:_.template($("#ops-metadata-template").html(),this.model,{variable:"data"}),initialize:function(){this.templateHelpers.config=opsChooserApp.config,this.listenTo(this.model,"change",this.render),this.listenTo(this,"render",this.setup_ui)},templateHelpers:{},setup_ui:function(){log("MetadataView.setup_ui"),$('.content-chooser > button[data-toggle="tab"]').on("show",function(){var e=$(this).data("list-type");"ops"==e?opsChooserApp.listRegion.show(opsChooserApp.collectionView):"upstream"==e&&opsChooserApp.listRegion.show(opsChooserApp.resultView)})}}),OpsFamilyVerboseMemberView=Backbone.Marionette.ItemView.extend({template:_.template($("#ops-family-verbose-member-template").html(),this.model,{variable:"data"}),tagName:"tr"}),OpsFamilyVerboseCollectionView=Backbone.Marionette.CompositeView.extend({template:"#ops-family-verbose-collection-template",itemView:OpsFamilyVerboseMemberView,id:"ops-family-verbose-verbose-collection",appendHtml:function(e,t){e.$("tbody").append(t.el)}}),OpsFamilyCompactMemberView=Backbone.Marionette.ItemView.extend({template:_.template($("#ops-family-compact-member-template").html(),this.model,{variable:"data"}),tagName:"tr"}),OpsFamilyCompactCollectionView=Backbone.Marionette.CompositeView.extend({template:_.template($("#ops-family-compact-collection-template").html(),this.collection,{variable:"data"}),itemView:OpsFamilyCompactMemberView,id:"ops-family-compact-collection",appendHtml:function(e,t){e.$("tbody").append(t.el)},onDomRefresh:function(){this.setup_ui()},setup_ui:function(){OpsBaseViewMixin.bind_query_links(this.$el),OpsBaseViewMixin.bind_same_citations_links(this.$el)},templateHelpers:function(){return{items:this.collection.toJSON(),get_patent_family_member_list:function(e){e=e||"docdb";var t=[];return _.each(this.items,function(i){var o=OpsBaseModel.prototype.defaults.get_publication_number(i,e);t.push(o)}),t}}}}),OpsFamilyCitationsMemberView=Backbone.Marionette.ItemView.extend({template:_.template($("#ops-family-citations-member-template").html(),this.model,{variable:"data"}),tagName:"tr",templateHelpers:{get_patent_citation_list:function(e){if(this["exchange-document"]){var t=new OpsExchangeDocument(this["exchange-document"]),i=t.attributes.get_patent_citation_list(e);return i}return[]},get_citations_environment_button:function(){var e=new OpsExchangeDocument(this["exchange-document"]),t=e.attributes.get_citations_environment_button();return t}}}),OpsFamilyCitationsCollectionView=Backbone.Marionette.CompositeView.extend({id:"ops-family-citations-collection",template:_.template($("#ops-family-citations-collection-template").html(),this.collection,{variable:"data"}),itemView:OpsFamilyCitationsMemberView,appendHtml:function(e,t){e.$("tbody").append(t.el)
},_initialEvents:function(){this.collection&&(this.listenTo(this.collection,"remove",this.removeItemView,this),this.listenTo(this.collection,"reset",this.render,this))},onDomRefresh:function(){this.setup_ui(),this.highlight()},setup_ui:function(){OpsBaseViewMixin.bind_query_links(this.$el),OpsBaseViewMixin.bind_same_citations_links(this.$el)},templateHelpers:function(){return{items:this.collection.toJSON(),get_citations_environment_button:function(){var e=_.template($("#ops-citations-environment-button-template").html());return e({data:this})},has_citations:function(){return this.items.length>0},get_patent_citation_list:function(e,t){t=t||"docdb";var i=new Set;_.each(this.items,function(e){var t=new OpsExchangeDocument(e["exchange-document"]),o=t.attributes.get_patent_citation_list(!1,"epodoc");_.each(o,function(e){i.add(e)})});var o=Array.from(i);return o},get_items_query:function(e,t,i){e=e.slice(0,10),e=e.map(function(e){return t+"="+e});var o=e.join(" "+i+" ");return o},get_same_citations_query:function(){var e=this.get_patent_citation_list(!1,"epodoc");return this.get_items_query(e,"ct","OR")},get_citing_query:function(){throw Error("not implemented")},get_publication_number:function(){throw Error("not implemented")}}},get_highlight_styles:function(){var e=_.range(0,360,35).map(function(e){var t={backgroundColor:_.template("hsla(  <%= hue %>, 100%, 88%, 1)")({hue:e})};return t});return e},highlight:function(){var e={};_.each(this.collection.models,function(t){var i=t.attributes["exchange-document"];if(i&&i["bibliographic-data"]){var o=t.attributes.get_patent_citation_list(i["bibliographic-data"],!1,"epodoc");_.each(o,function(t){e[t]||(e[t]=0),e[t]++})}}),_.each(e,function(t,i){2>t&&delete e[i]});var t,i=this;_.each(e,function(e,o){if(o){_.isEmpty(t)&&(t=i.get_highlight_styles());var n=t.shift(),r=_.uniqueId("citation-highlight-");i.$el.highlight(o,{className:"highlight-base "+r,wholeWords:!0,minLength:3}),$("."+r).css(n)}})}}),PaginationView=Backbone.Marionette.ItemView.extend({tagName:"div",template:_.template($("#ops-pagination-template").html(),this.model),initialize:function(e){console.log("PaginationView.initialize"),this.listenTo(this.model,"commit",this.render),this.listenTo(this,"item:rendered",this.setup_ui),this.templateHelpers.config=opsChooserApp.config,this.bottom_pager=e.bottom_pager},templateHelpers:{},getTemplate:function(){return"#ops-pagination-template"},setup_ui:function(){console.log("PaginationView.setup_ui");var e=this,t=this.model.get("datasource"),i=this.model.get("pagination_pagesize_choices"),o=this.model.get("page_size"),n=this.model.get("result_count"),r=this.get_maximum_results(),a=this.model.get("result_range"),s=this.model.get("pagination_current_page");"google"==t&&null==n&&(n=1e3);var c=0;if(n>0&&o>0){var l=n/o;l>=1&&(c=Math.ceil(l)),c=_.min([c,Math.ceil(r/o)])}return 1>c?void this.$el.hide():(this.$el.show(),$(this.el).find(".jqpagination").each(function(){$(this).jqPagination(),$(this).jqPagination("destroy"),$(this).jqPagination({max_page:c,current_page:s,paged:function(t){e.model.set("pagination_current_page",t),e.bottom_pager&&$.when($(window).scrollTop(0)).then(function(){});var i=e.get_range(t);"numberlist"==opsChooserApp.queryBuilderView.get_flavor()&&1!=opsChooserApp.metadata.get("reviewmode")?opsChooserApp.perform_numberlistsearch(i):opsChooserApp.perform_search(i)}})}),$(this.el).find(".page-size-chooser ul").each(function(){$(this).empty();var e=this;_(i).map(function(t){var i="";i=t==o?'<i class="icon-check"></i>':'<i class="icon-check-empty"></i>';var n=_.template('<li><a href="" data-value="<%= entry %>"><%= icon %> <%= entry %></a></li>')({entry:t,icon:i});$(e).append(n)})}),$(this.el).find(".page-size-chooser a").click(function(t){t.preventDefault();var i=$(this).data("value");return e.model.set("page_size",i),opsChooserApp.perform_search({clear:!0}),!1}),"subsearch"==this.model.get("searchmode")&&$(this.el).find(".page-size-chooser > .dropdown-toggle").prop("disabled",!0),$(this.el).find(".pagination ul").each(function(){$(this).empty();var t=this;_.range(1,c+1).map(function(i){var o=e.get_range(i).range,n=_.template('<li><a href="" range="<%= range %>"><%= range %></a></li>')({range:o});$(t).append(n)})}),$(this.el).find(".pagination a").click(function(){var e=$(this).attr("range");return opsChooserApp.perform_search({range:e}),!1}),void $(this.el).find(".pagination").find("a").each(function(e,t){var i=$(t).attr("range");if(i==a){var o=$(t).parent();o.addClass("active")}}))},set_page:function(e){var t=$(this.el).find(".jqpagination").last();return $(t).jqPagination("option","current_page",e)},onDomRefresh:function(){console.log("PaginationView.onDomRefresh")},get_maximum_results:function(){var e=this.model.get("datasource"),t=this.model.get("maximum_results")[e]||1/0;return t},get_range:function(e){var t=this.model.get("page_size"),i=(e-1)*t+1,o=i+t-1;o=_.min([o,this.get_maximum_results()]);var n=i+"-"+o;return{range:n,range_begin:i,range_end:o,page:e}}}),function(){var e,t=this;e="undefined"!=typeof exports?exports:t.Ipsuite={};var i=e.LinkMaker=function(e){e&&(this.document=e,this.country=e["@country"],this.docnumber=e["@doc-number"],this.kind=e["@kind"]),Object.defineProperty(this,"document_number",{get:function(){return this.document.get_document_number()}})};_.extend(i.prototype,{drawing_url:function(){var e=_.template("/api/drawing/<%= document_number %>"),t=e({document_number:this.document_number});return t},fullimage_url:function(){var e=_.template("/api/ops/<%= patent_number %>/image/full"),t=e({patent_number:this.get_patent_number()});return t},universal_pdf_url:function(e){if(e)var t=_.template("/api/pdf/<%= document_id %>"),i=t({document_id:e});else var t=_.template("/api/pdf/<%= country %><%= docnumber %><%= kind %>"),i=t(this);return i},ops_pdf_url:function(){var e=_.template("/api/ops/<%= country %><%= docnumber %><%= kind %>/pdf/all"),t=e(this);return t},espacenet_pdf_url:function(){var e=_.template("http://worldwide.espacenet.com/espacenetDocument.pdf?flavour=trueFull&FT=D&CC=<%= country %>&NR=<%= docnumber %><%= kind %>&KC=<%= kind %>"),t=e(this);return t},depatisnet_pdf_url:function(){var e=_.template("https://depatisnet.dpma.de/DepatisNet/depatisnet?action=pdf&docid=<%= country %><%= docnumber %><%= kind %>"),t=e(this);return t},epo_register_url:function(){var e=this.document.get_application_reference("docdb"),t=_.template("https://register.epo.org/application?number=<%= country %><%= docnumber %>"),i=t(e);return i},inpadoc_legal_url:function(){var e=_.template("http://worldwide.espacenet.com/publicationDetails/inpadoc?FT=D&CC=<%= country %>&NR=<%= docnumber %><%= kind %>&KC=<%= kind %>"),t=e(this);return t},dpma_register_url:function(){var e=this.document.get_application_reference("docdb"),t=_.template("/office/dpma/register/application/<%= country %><%= docnumber %>?redirect=true"),i=t(e);return i},uspto_pair_url:function(){var e=_.template("http://portal.uspto.gov/pair/PublicPair"),t=e(this);return t},inpadoc_family_url:function(){var e=_.template("http://worldwide.espacenet.com/publicationDetails/inpadocPatentFamily?FT=D&CC=<%= country %>&NR=<%= docnumber %><%= kind %>&KC=<%= kind %>"),t=e(this);return t},ops_family_url:function(){var e=_.template("http://ops.epo.org/3.1/rest-services/family/publication/docdb/<%= country %>.<%= docnumber %>.<%= kind %>/biblio,legal"),t=e(this);return t},ccd_viewer_url:function(){var e=this.document.get_application_reference("epodoc"),t=_.template("http://ccd.fiveipoffices.org/CCD-2.0.4/html/viewCcd.html?num=<%= docnumber %>&type=application&format=epodoc"),i=t(e);return i},depatisnet_url:function(){var e=this.document.get_publication_reference("docdb"),t=_.template("https://depatisnet.dpma.de/DepatisNet/depatisnet?action=bibdat&docid=<%= country %><%= docnumber %><%= kind %>"),i=t(e);return i},espacenet_worldwide_url:function(){var e=this.document.get_publication_reference("docdb"),t=_.template("http://worldwide.espacenet.com/publicationDetails/biblio?DB=worldwide.espacenet.com&FT=D&CC=<%= country %>&NR=<%= docnumber %><%= kind %>&KC=<%= kind %>"),i=t(e);return i},google_url:function(){var e=this.document.get_publication_reference("docdb"),t=_.template("https://www.google.com/patents/<%= country %><%= docnumber %><%= kind %>"),i=t(e);return i},google_prior_art_url:function(){var e=this.document.get_publication_reference("docdb"),t=_.template("https://www.google.com/patents/related/<%= country %><%= docnumber %><%= kind %>"),i=t(e);return i}})}.call(this);
//# sourceMappingURL=/static/js/app.min.map