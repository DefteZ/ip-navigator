// (c) 2013,2014 Elmyra UG
function indicate_activity(e){e?($("#idler").hide(),$("#spinner").show()):($("#spinner").hide(),$("#idler").show())}function pdf_display(e,t,i){var o=new PDFObject({url:t+"?page="+i,id:"myPDF",pdfOpenParams:{navpanes:0,toolbar:0,statusbar:0,view:"FitB"}});o.embed(e)}function pdf_set_headline(e,t){var i=e+" Page "+t;$(".modal-header #ops-pdf-modal-label").empty().append(i)}function listview_bind_actions(){function e(e){var t=$(e).closest(".ops-collection-entry"),i=$(e).data("carousel");if(i){var o=i.getActiveIndex()+1;t.find(".drawing-number").text(o)}var a=$(e).data("totalcount");a&&t.find(".drawing-totalcount").text("/"+a)}if(PRINTMODE)return void $(".do-not-print").hide();$(".cql-query").shorten({showChars:125,moreText:"more",lessText:"less"}),$("#result-count-total").autoNumeric("init",{mDec:0}),opsChooserApp.basket_update_downstreams(),$(".abstract").shorten({showChars:2e3,moreText:"more",lessText:"less"}),_.each(opsChooserApp.metadata.get("keywords"),function(e){$(".keyword").keywordHighlight({keyword:e,caseSensitive:"false",contains:"true"})}),$(".add-patent-number").popover(),$(".remove-patent-number").popover(),$(".btn-popover").popover(),$(".inid-tooltip").tooltip(),$(".pdf-open").click(function(){var e=$(this).data("patent-number"),t=$(this).data("pdf-url"),i=1;pdf_set_headline(e,i),pdf_display("pdf",t,i),$("#pdf-previous").unbind(),$("#pdf-previous").click(function(){1!=i&&(i-=1,pdf_set_headline(e,i),pdf_display("pdf",t,i))}),$("#pdf-next").unbind(),$("#pdf-next").click(function(){i+=1,pdf_set_headline(e,i),pdf_display("pdf",t,i)})}),$(".query-link").click(function(e){e.preventDefault();var t=$(this).data("query-attribute"),i=$(this).data("query-value"),o=t+"="+i;opsChooserApp.send_query(o)}),$(".drawings-carousel").carousel({interval:null}),$(".drawings-carousel").bind("slid",function(){e(this)});var t=$(".drawings-carousel .carousel-control.right");t.click(function(){var e=$(this).closest(".ops-collection-entry").find(".drawings-carousel"),t=e.find(".carousel-inner"),i=t.find("div.active").index()+1,o=t.find("div").length;if(i==o){var a=e.data("totalcount");if(a&&!(o>=a)){var n=$(t).children(":first").clone(),r=$(t).height();$(n).removeClass("active");var s=$(n).children("img"),c=s.attr("src").replace(/\?page=.*/,"");c+="?page="+(i+1),s.attr("src",c),$(n).attr("min-height",r),$(n).height(r),$(t).append(n)}}}),$(".drawings-carousel").each(function(t,i){var i=$(i),o=i.data("totalcount");if(!o){o=1;var a=i.closest(".ops-collection-entry").data("document-number");if(!a)return void console.warn("document-number could not be found, won't proceed loading items into carousel");var n=_.template("/api/ops/<%= patent %>/image/info")({patent:a});$.ajax({url:n,async:!0}).success(function(t){t&&(o=t.META["drawing-total-count"],i.data("totalcount",o),e(i))}).error(function(e){console.warn("Error while fetching total count of drawings: "+e)}),i.data("totalcount",o),e(i)}});var i=$(".drawings-carousel").find("img");i.error(function(){$(this).hide();var e='<br/><blockquote class="text-center" style="min-height: 300px"><br/><br/><br/><br/><br/><br/>No image</blockquote>';$(this).closest(".carousel").hide().parent().find(".drawing-info").html(e)}),$(".embed-item").each(function(e,t){var i=$(t).data("embed-url"),o=$(t).data("document-number");if(i){var a=_.template(i,null,{interpolate:/\{\{(.+?)\}\}/g}),n=a({publication_number:o}),r='<iframe src="'+n+'" class="container-fluid well" seamless="seamless" height2="200" width2="100%" style="min-height: 50%; min-width: 80%"/>';$(this).append(r)}})}function reset_content(e){$("#alert-area").empty(),$("#info-area").empty(),opsChooserApp.documents.reset(),$("#pagination-info").hide(),e=e||{},e.keep_pager||$(".pager-area").hide()}function boot_application(){console.log("boot_application");var e=$.url(window.location.href),t=e.param("datasource");if(!t){var i=$("#query").val();""==i.trim()&&(t="depatisnet")}t||(t="ops"),reset_content(),$(".btn-popover").popover(),$(".very-short").shorten({showChars:5,moreText:"more",lessText:"less"}),$("#query").caret($("#query").val().length),$(".btn-query-perform").click(function(){opsChooserApp.perform_search({reviewmode:!1})}),$("#datasource").on("click",".btn",function(){opsChooserApp.set_datasource($(this).data("value"))}),$("#query").on("keydown",null,"meta+return",function(){opsChooserApp.perform_search({reviewmode:!1})}),$("#query").on("keydown",null,"ctrl+return",function(){opsChooserApp.perform_search({reviewmode:!1})}),_([document,"#query"]).each(function(e){$(e).on("keydown",null,"ctrl+shift+d",function(){$('#datasource button[data-value="depatisnet"]').button("toggle"),opsChooserApp.set_datasource("depatisnet")}),$(e).on("keydown",null,"ctrl+shift+o",function(){$('#datasource button[data-value="ops"]').button("toggle"),opsChooserApp.set_datasource("ops")}),$(e).on("keydown",null,"ctrl+shift+r",function(){opsChooserApp.basketModel.review()})}),$("#btn-query-clear").click(function(){$("#query").val("").focus()}),$("#btn-query-transform").click(function(){$("#query").val().trim()&&$("#clipboard-modifier-chooser").modal("show")}),$(".btn-clipboard-modifier").click(function(){var e=$(this).data("modifier"),t=$("#clipboard-modifier-operator").find(".btn.active").data("value")||"OR";$("#clipboard-modifier-chooser").modal("hide");var i=$("#query").val().trim();if(!_.str.contains(i,"=")){var o=i.split("\n"),a=_(o).map(function(t){return e+'="'+t+'"'}).join(" "+t+" ");$("#query").val(a),$("#query").focus()}}),$(".btn-cql-boolean").button(),$("#cql-quick-operator").find(".btn-cql-boolean").click(function(){$("#query").focus()}),$(".btn-cql-field").click(function(){var e,t=$("#query").val(),i=$("#cql-quick-operator").find(".btn-cql-boolean.active").data("value"),o=$(this).data("value"),a=$("#query").caret(),n=!1,r=!0;if(0!=a){n=!0,e=t.substring(a-1,a),"="==e&&(n=!1,r=!1);var s=t.substring(a-5,a).toLowerCase();(_.string.include(s,"and")||_.string.include(s,"or"))&&(n=!1)}var c=e&&" "!=e?" ":"";n&&$("#query").caret(c+i),r&&$("#query").caret((n?" ":c)+o),$("#query").focus()}),t&&opsChooserApp.set_datasource(t),$("#link-help").click(function(){$("#help-modal").modal("show")})}function cql_field_chooser_toggle(e){cql_field_chooser_setup("ops"==e?OPS_CQL_FIELDS:"depatisnet"==e?DEPATISNET_CQL_FIELDS:[])}function cql_field_chooser_setup(e){var t=opsChooserApp.get_datasource();$("#cql-field-chooser").select2({placeholder:"CQL field symbols ("+t+")",data:{results:e},dropdownCssClass:"bigdrop",escapeMarkup:function(e){return e}}),$("#cql-field-chooser").on("change",function(){var e=$(this).val();if(e){var t=$("#query").val(),i=$("#query").caret(),o=t.substring(i-1,i);"="!=o&&(" "!=o&&0!=i&&(e=" "+e),$("#query").caret(e+"="),$(this).data("select2").clear())}})}function to_list(e){return _.isArray(e)&&e||[e]}function cql_field_chooser_text(e,t,i){var o=_.template($("#cql-field-chooser-entry").html());t=t.map(function(e){return e+"="});var a=o({label:e,fields:t,more:i});return a}function now_iso(){return moment().format()}function today_iso(){return moment().format("YYYY-MM-DD")}function changeTooltipColorTo(e){$(".tooltip-inner").css("background-color",e),$(".tooltip.top .tooltip-arrow").css("border-top-color",e),$(".tooltip.right .tooltip-arrow").css("border-right-color",e),$(".tooltip.left .tooltip-arrow").css("border-left-color",e),$(".tooltip.bottom .tooltip-arrow").css("border-bottom-color",e)}OpsChooserApp=Backbone.Marionette.Application.extend({get_datasource:function(){var e=$("#datasource > .btn.active").data("value");return e},set_datasource:function(e){$("#datasource > .btn[data-value='"+e+"']").button("toggle"),cql_field_chooser_toggle(e),"review"==e?$("#query").prop("disabled",!0):$("#query").prop("disabled",!1)},perform_search:function(e){this.metadata.resetSomeDefaults();var t=$("#query").val(),i=this.get_datasource();console.log("App.perform_search: datasource="+i+", query="+t),e&&null!=e.reviewmode&&this.metadata.set("reviewmode",e.reviewmode);var o=this.metadata.get("reviewmode");if(1==o)return void this.basketModel.review(e);if(!_.isEmpty(t)){var a=this;if(this.metadata.set("datasource",i),"ops"==i){var n=this.compute_range(e);console.log("App.perform_search: trigger search:before"),this.trigger("search:before",t,n),opsChooserApp.search.perform(this.documents,this.metadata,t,n).done(function(){a.metadata.set("keywords",opsChooserApp.search.keywords),listview_bind_actions()})}else if("depatisnet"==i){indicate_activity(!0),this.metadata.set("query_origin",t);var r=new DepatisnetSearch;r.perform(t).done(function(i){a.propagate_depatisnet_message(i),a.metadata.set("keywords",r.keywords),console.log(i);var o=i.data,n=i.hits;a.perform_listsearch(e,t,o,n,"pn","OR").done(function(){a.propagate_depatisnet_message(i)})})}}},send_query:function(e,t){e&&($("#query").val(e),opsChooserApp.perform_search(t),$(window).scrollTop(0))},perform_listsearch:function(e,t,i,o,a,n){indicate_activity(!1),reset_content({keep_pager:!0});var r=e&&e.range?e.range:"1-10",s=r.split("-"),c=parseInt(s[0])-1,l=parseInt(s[1]);if(i&&(0==i.length||c>i.length)){var d=_.template('No results with query "<%= query %>", range "<%= range %>".')({query:query,range:r});return console.warn(d),void this.user_alert(d,"warning")}var p=_(_.map(i,function(e){return a+"="+e})),u=p.join(" "+n+" "),h=p.slice(c,l).join(" "+n+" ");console.log("OPS sliced CQL query:",h),t||(t=u),this.metadata.set("page_size",10),this.metadata.set("searchmode","subsearch");var m=this;return opsChooserApp.search.perform(this.documents,this.metadata,h,"1-10").done(function(){m.metadata.set("query_origin",t),m.metadata.set("result_count",o),m.metadata.set("result_range",r),m.metadata.set("pagination_entry_count",17),$(".pagination").removeClass("span10"),$(".pagination").addClass("span12"),listview_bind_actions()})},compute_range:function(e){var t=this.metadata.get("page_size"),i="1-"+t,o=e&&e.range?e.range:i;return o},propagate_depatisnet_message:function(e){this.user_alert(e.message,"warning")},user_alert:function(e,t){if(e){var i="INFO",o="alert-info";"warning"==t&&(i="WARNING",o="alert-warning");var a=_.template($("#alert-template").html()),n={title:i,description:e,clazz:o},r=a(n);$("#info-area").append(r)}},project_activate:function(e){var t=this;if(!e)return void console.error("project is null, will not activate");var i=e.get("name");console.log("App.project_activate:",i),this.project=e,this.stopListening(this,"search:before"),this.listenTo(this,"search:before",function(e){this.project.record_query(e)});var o=new ProjectChooserView({el:$("#project-chooser-area"),model:e,collection:this.projects});o.render();var a=e.get("basket");a.fetch({success:function(){t.basket_activate(a)}})},basket_activate:function(e){if(console.log("App.basket_activate"),!e)return void console.error("basket is null, will not activate");this.basketModel=e,this.listenTo(e,"change:add",this.collectionView.basket_update_ui_entry),this.listenTo(e,"change:remove",this.collectionView.basket_update_ui_entry);var t=new BasketView({el:$("#basket-area"),model:e});t.render(),this.basket_update_downstreams()},basket_update_downstreams:function(){var e=this;$(".add-patent-number").unbind("click"),$(".add-patent-number").click(function(){var t=$(this).data("patent-number");e.basketModel.add(t)}),$(".remove-patent-number").unbind("click"),$(".remove-patent-number").click(function(){var t=$(this).data("patent-number");e.basketModel.remove(t)}),this.documents.each(function(t){var i=t.attributes.get_patent_number();e.collectionView.basket_update_ui_entry(i)})}}),opsChooserApp=new OpsChooserApp,opsChooserApp.addRegions({metadataRegion:"#ops-metadata-region",listRegion:"#ops-collection-region",paginationRegionTop:"#ops-pagination-region-top",paginationRegionBottom:"#ops-pagination-region-bottom"}),OpsExchangeDocumentView=Backbone.Marionette.ItemView.extend({template:_.template($("#ops-entry-template").html(),this.model,{variable:"data"}),tagName:"div",className:"row-fluid",events:{"click .rank_up img":"rankUp","click .rank_down img":"rankDown","click a.disqualify":"disqualify"},onDomRefresh:function(){var e=this.model.attributes.get_patent_number();opsChooserApp.collectionView.basket_update_ui_entry(e)}}),OpsExchangeDocumentCollectionView=Backbone.Marionette.CompositeView.extend({tagName:"div",id:"opsexchangedocumentcollection",className:"container",template:"#ops-collection-template",itemView:OpsExchangeDocumentView,appendHtml:function(e,t){$(e.el).append(t.el)},basket_update_ui_entry:function(e){var t=$("#basket").val(),i=$("#chk-patent-number-"+e),o=$("#add-patent-number-"+e),a=$("#remove-patent-number-"+e);_.string.include(t,e)?(i&&i.prop("checked",!0),o&&o.hide(),a&&a.show()):(i&&i.prop("checked",!1),o&&o.show(),a&&a.hide())}}),MetadataView=Backbone.Marionette.ItemView.extend({tagName:"div",template:"#ops-metadata-template",initialize:function(){this.listenTo(this.model,"change",this.render)},onDomRefresh:function(){}}),opsChooserApp.addInitializer(function(){this.search=new OpsPublishedDataSearch,this.metadata=new OpsExchangeMetadata,this.documents=new OpsExchangeDocumentCollection}),opsChooserApp.addInitializer(function(){this.metadataView=new MetadataView({model:this.metadata}),this.collectionView=new OpsExchangeDocumentCollectionView({collection:this.documents}),this.paginationViewTop=new PaginationView({model:this.metadata}),this.paginationViewBottom=new PaginationView({model:this.metadata}),opsChooserApp.metadataRegion.show(this.metadataView),opsChooserApp.listRegion.show(this.collectionView),opsChooserApp.paginationRegionTop.show(this.paginationViewTop),opsChooserApp.paginationRegionBottom.show(this.paginationViewBottom)}),opsChooserApp.addInitializer(function(){this.basket_activate(new BasketModel)}),opsChooserApp.addInitializer(function(){this.listenTo(this,"project:ready",this.project_activate),this.listenToOnce(this,"project:ready",this.perform_search)}),$(document).ready(function(){console.log("document.ready"),opsChooserApp.start(),boot_application()});var OPS_CQL_FIELDS=[{text:"<h4>Popular</h4>",children:[{id:"num",text:cql_field_chooser_text("Publication-, application- or<br/>priority number",["num"],"(10, 11, 21, 31)")},{id:"txt",text:cql_field_chooser_text("Title, abstract, inventor-, or applicant name",["txt"],"(54, 57, 72, 71, 73)")},{id:"cl",text:cql_field_chooser_text("CPC or IPC8 class",["cl"],"")}]},{text:"<h4>Publication</h4>",children:[{id:"pn",text:cql_field_chooser_text("Publication number",["pn","publicationnumber"],"(10, 11)")},{id:"pd",text:cql_field_chooser_text("Publication date",["pd","publicationdate"],"")},{id:"pa",text:cql_field_chooser_text("Applicant",["pa","applicant"],"(71, 73)")},{id:"in",text:cql_field_chooser_text("Inventor",["in","inventor"],"(72)")},{id:"ia",text:cql_field_chooser_text("Inventor or applicant",["ia","inventorandapplicant"],"(72, 71, 73)")},{id:"spn",text:cql_field_chooser_text("Publication number<br/><small>in epodoc format</small>",["spn"],"")}]},{text:"<h4>Text</h4>",children:[{id:"ti",text:cql_field_chooser_text("Title",["ti","title"],"(54)")},{id:"ab",text:cql_field_chooser_text("Abstract",["ab","abstract"],"(57)")},{id:"ta",text:cql_field_chooser_text("Title or abstract",["ta","titleandabstract"],"(54, 57)")},{id:"txt",text:cql_field_chooser_text("Title, abstract, inventor-, or applicant name",["txt"],"(54, 57, 72, 71, 73)")}]},{text:"<h4>Application, priority and family</h4>",children:[{id:"ap",text:cql_field_chooser_text("Application number",["ap","applicantnumber"],"(21)")},{id:"sap",text:cql_field_chooser_text("Application number<br/><small>in epodoc format</small>",["sap"],"")},{id:"pr",text:cql_field_chooser_text("Priority number",["pr","prioritynumber"],"(31)")},{id:"spr",text:cql_field_chooser_text("Priority number<br/><small>in epodoc format</small>",["spr"],"")},{id:"famn",text:cql_field_chooser_text("Family identifier (simple)",["famn"],"")}]},{text:"<h4>Classification</h4>",children:[{id:"cpc",text:cql_field_chooser_text("CPC classification<br/><small>(invention and additional)</small>",["cpc","cpci","cpca"],"")},{id:"ipc",text:cql_field_chooser_text("IPC8 class",["ipc","ic"],"")},{id:"ci",text:cql_field_chooser_text("IPC8 core invention class",["ci"],"")},{id:"cn",text:cql_field_chooser_text("IPC8 core additional class<br/><small>(non-invention)</small>",["cn"],"")},{id:"ai",text:cql_field_chooser_text("IPC8 advanced invention class",["ai"],"")},{id:"an",text:cql_field_chooser_text("IPC8 advanced additional class<br/><small>(non-invention)</small>",["an"],"")},{id:"a",text:cql_field_chooser_text("IPC8 advanced class",["a"],"")},{id:"c",text:cql_field_chooser_text("IPC8 core class",["c"],"")},{id:"cl",text:cql_field_chooser_text("CPC or IPC8 class",["cl"],"")}]},{text:"<h4>Citations</h4>",children:[{id:"ct",text:cql_field_chooser_text("Cited document number",["ct","citation"],"(56)")},{id:"ex",text:cql_field_chooser_text("Cited document number<br/><small>during examination</small>",["ex"],"")},{id:"op",text:cql_field_chooser_text("Cited document number<br/><small>during opposition</small>",["op"],"")},{id:"rf",text:cql_field_chooser_text("Cited document number<br/><small>provided by applicant</small>",["rf"],"")},{id:"oc",text:cql_field_chooser_text("Another cited document number",["oc"],"")}]}],DEPATISNET_CQL_FIELDS=[{text:"<h4>Publication</h4>",children:[{id:"pn",text:cql_field_chooser_text("Publication number",["pn"],"(10, 11)")},{id:"pc",text:cql_field_chooser_text("Country of publication",["pc"],"(19)")},{id:"pub",text:cql_field_chooser_text("Publication date",["pub"],"")},{id:"py",text:cql_field_chooser_text("Publication year",["py"],"")},{id:"pa",text:cql_field_chooser_text("Applicant/Owner",["pa"],"(71, 73)")},{id:"in",text:cql_field_chooser_text("Inventor",["in"],"(72)")},{id:"pcod",text:cql_field_chooser_text("Kind code",["pcod"],"(12)")}]},{text:"<h4>Text</h4>",children:[{id:"ti",text:cql_field_chooser_text("Title",["ti"],"(54)")},{id:"ab",text:cql_field_chooser_text("Abstract",["ab"],"(57)")},{id:"de",text:cql_field_chooser_text("Description",["de"],"")},{id:"cl",text:cql_field_chooser_text("Claims",["cl"],"(57)")},{id:"bi",text:cql_field_chooser_text("Full text data",["bi"])}]},{text:"<h4>Application</h4>",children:[{id:"an",text:cql_field_chooser_text("Application number",["ap"],"(21)")},{id:"ac",text:cql_field_chooser_text("Country of application",["ac"],"")},{id:"ad",text:cql_field_chooser_text("Application date",["ad"],"(22, 96)")},{id:"ay",text:cql_field_chooser_text("Application year",["ay"],"")}]},{text:"<h4>Priority</h4>",children:[{id:"prn",text:cql_field_chooser_text("Priority number",["prn"],"(31)")},{id:"prc",text:cql_field_chooser_text("Country of priority",["prc"],"(33)")},{id:"prd",text:cql_field_chooser_text("Priority date",["prd"],"(32)")},{id:"pry",text:cql_field_chooser_text("Priority year",["pry"],"")}]},{text:"<h4>Citations</h4>",children:[{id:"ct",text:cql_field_chooser_text("Cited documents",["ct"],"(56)")},{id:"ctnp",text:cql_field_chooser_text("Cited non-patent literature",["ctnp"],"(56)")}]},{text:"<h4>Bibliographic IPC</h4>",children:[{id:"icb",text:cql_field_chooser_text("Bibliographic IPC",["icb"],"")},{id:"icm",text:cql_field_chooser_text("IPC main class",["icm"],"(51)")},{id:"ics",text:cql_field_chooser_text("IPC secondary class",["ics"],"(51)")},{id:"ica",text:cql_field_chooser_text("IPC additional class",["ica"],"")},{id:"ici",text:cql_field_chooser_text("IPC index classes",["ici"],"")},{id:"icmv",text:cql_field_chooser_text("IPC main class version",["icmv"],"")},{id:"icsv",text:cql_field_chooser_text("IPC secondary class version",["icsv"],"")},{id:"icav",text:cql_field_chooser_text("IPC additional class version",["icav"],"")},{id:"icml",text:cql_field_chooser_text("IPC main class level",["icml"],"")},{id:"icsl",text:cql_field_chooser_text("IPC secondary class level",["icsl"],"")},{id:"ical",text:cql_field_chooser_text("IPC additional class level",["ical"],"")}]},{text:"<h4>Reclassified IPC</h4>",children:[{id:"mcd",text:cql_field_chooser_text("Reclassified IPC",["mcd"],"")},{id:"mcm",text:cql_field_chooser_text("MCD main class",["mcm"],"")},{id:"mcs",text:cql_field_chooser_text("MCD secondary class",["mcs"],"")},{id:"mca",text:cql_field_chooser_text("MCD additional class",["mca"],"")},{id:"mcml",text:cql_field_chooser_text("MCD main class level",["mcml"],"")},{id:"mcsl",text:cql_field_chooser_text("MCD secondary class level",["mcsl"],"")},{id:"mcal",text:cql_field_chooser_text("MCD additional class level",["mcal"],"")}]}];BasketModel=Backbone.RelationalModel.extend({sync:Backbone.localforage.sync("Basket"),defaults:{numberlist:[],ship_url:"",ship_param:"payload"},initialize:function(){console.log("BasketModel.initialize"),this.init_from_query()},init_from_query:function(){var e=["numberlist","ship-url","ship-param"],t=this,i=$.url(window.location.href);_(e).each(function(e){var o=e.replace("-","_"),a=i.param(e);a||(a=i.param(o)),a&&(a=decodeURIComponent(a),a=a.split(","),t.set(o,a))})},add:function(e){var t=this.get("numberlist");_(t).contains(e)||(t.push(e),this.trigger("change",this),this.trigger("change:add",e))},remove:function(e){var t=this.get("numberlist");_(t).contains(e)&&(t.pop(e),this.trigger("change",this),this.trigger("change:remove",e))},review:function(e){var t=$("#basket").val();if(t){var e=e||{},i=null,o=t.split("\n").filter(function(e){return e}),a=o.length;opsChooserApp.set_datasource("review"),opsChooserApp.metadata.set("reviewmode",!0),opsChooserApp.perform_listsearch(e,i,o,a,"pn","OR")}}}),BasketView=Backbone.Marionette.ItemView.extend({template:"#basket-template",initialize:function(){console.log("BasketView.initialize"),this.listenTo(this.model,"change",this.render),this.listenTo(this,"item:rendered",this.setup_ui)},serializeData:function(){var e={};e=this.model.toJSON();var t=this.model.get("numberlist");return t&&(e.numberlist=t.join("\n")),e},setup_ui:function(){console.log("BasketView.setup_ui");var e=this;$("#basket-import-button").click(function(){return e.future_premium_feature(),!1});var t=this.model.get("ship_url");t?$("#basket-submit-button").prop("disabled",!1):$("#basket-submit-button").prop("disabled",!0),$(".basket-review-button").click(function(){e.model.review()}),$("#share-numberlist-email").click(function(){e.future_premium_feature()}),$("#share-documents-transfer").click(function(){e.future_premium_feature()})},future_premium_feature:function(){bootbox.dialog("Available soon via subscription.",[{label:"OK",icon:"OK",callback:null}],{header:"Future feature"})},onDomRefresh:function(){console.log("BasketView.onDomRefresh")}}),localforage.setDriver("localStorageWrapper"),QueryModel=Backbone.Model.extend({}),ProjectModel=Backbone.RelationalModel.extend({sync:Backbone.localforage.sync("Project"),relations:[{type:Backbone.HasOne,key:"basket",relatedModel:"BasketModel",includeInJSON:Backbone.Model.prototype.idAttribute,reverseRelation:{type:Backbone.HasOne,key:"project",includeInJSON:Backbone.Model.prototype.idAttribute}}],defaults:{name:null,created:null,modified:null,queries:[]},initialize:function(){console.log("ProjectModel.initialize")},record_query:function(e){console.log("ProjectModel.record_query: "+e);var t=!1,i=this.get("queries");_(i).last()!=e&&(i.push(e),t=!0),t&&(this.set("queries",i),this.save())},save:function(e,t,i){return this.set("modified",now_iso()),Backbone.Model.prototype.save.call(this,e,t,i)}}),ProjectCollection=Backbone.Collection.extend({sync:Backbone.localforage.sync("Project"),find:Backbone.localforage.find,model:ProjectModel,initialize:function(){console.log("ProjectCollection.initialize")},sortByField:function(e,t){var i=this,o=function(e,t){return e=e.get(i.sort_key),t=t.get(i.sort_key),e>t?1:t>e?-1:0},a=function(e,t){return o(t,e)};return this.comparator=o,_.str.startsWith(t,"d")&&(this.comparator=a),this.sort_key=e,this.sort(),this},get_or_create:function(e){var t=this.where({name:e});if(t){var i=t[0];if(i)i.fetch();else{console.log("ProjectModel.create");var o=new BasketModel;i=new ProjectModel({name:e,created:now_iso(),basket:o}),this.create(i),o.set("project",i),o.save()}i.fetchRelated("basket");var o=i.get("basket");return this.listenTo(o,"change",function(){o.save()}),this.listenTo(o,"change",function(){i.save()}),i}}}),ProjectChooserView=Backbone.Marionette.ItemView.extend({template:"#project-chooser-template",initialize:function(){console.log("ProjectChooserView.initialize"),this.listenTo(this.model,"change",this.render),this.listenTo(this,"item:rendered",this.setup_ui)},onDomRefresh:function(){console.log("ProjectChooserView.onDomRefresh")},setup_ui:function(){console.log("ProjectChooserView.setup_ui");var e=this;$("#project-chooser-name").editable({mode:"inline",success:function(t,i){var o=e.collection.where({name:i});return _.isEmpty(o)?(e.model.set("name",i),void e.model.save()):($(".editable-container input").tooltip({title:"Project already exists"}).tooltip("show"),changeTooltipColorTo("#DF0101"),!1)}}),$("#project-chooser-name").editable("setValue",this.model.get("name"));var t=$("#project-chooser-list ul"),i=this.collection;t.empty(),i.sortByField("modified","desc").each(function(e){var i=e.get("name"),o=e.get("modified"),a=_.template('<li><a class="span12" href="javascript: void(0);" data-value="<%= name %>"><%= name %> <span class="pull-right"><%= modified %></span></a></li>')({name:i,modified:moment(o).fromNow()});t.append(a)}),t.find("a").click(function(){var e=$(this).data("value"),t=i.get_or_create(e);opsChooserApp.trigger("project:ready",t)})}}),opsChooserApp.addInitializer(function(){this.projects=new ProjectCollection;var e=this;console.log("App.projects.fetch"),this.projects.fetch({success:function(){var t=today_iso(),i=e.projects.get_or_create(t);console.log("project:ready"),e.trigger("project:ready",i)}})}),DepatisnetSearch=Backbone.Model.extend({url:"/api/depatisnet/published-data/search",keywords:[],perform:function(e,t){var i=this;return this.fetch({data:$.param({query:e,range:t}),success:function(e,t,o){i.keywords=jQuery.parseJSON(o.xhr.getResponseHeader("X-Elmyra-Query-Keywords"))},error:function(e,t){reset_content(),$("#alert-area").empty();try{var i=jQuery.parseJSON(t.responseText);"error"==i.status&&(_.each(i.errors,function(e){var t=_.template($("#cornice-error-template").html()),i=t(e);$("#alert-area").append(i)}),$(".very-short").shorten({showChars:0,moreText:"more",lessText:"less"}))}catch(o){var i=t.responseText;$("#alert-area").append(i)}}})}}),OpsPublishedDataSearch=Backbone.Model.extend({url:"/api/ops/published-data/search",keywords:[],perform:function(e,t,i,o){indicate_activity(!0),e.reset(),$(opsChooserApp.paginationViewBottom.el).hide();var a=this;return this.fetch({data:$.param({query:i,range:o}),success:function(i,o,n){if(a.keywords=jQuery.parseJSON(n.xhr.getResponseHeader("X-Elmyra-Query-Keywords")),indicate_activity(!1),reset_content(),console.log("response data:"),console.log(o),!_.isEmpty(o)){$(".pager-area").show();var r,s=o["ops:world-patent-data"]["ops:biblio-search"]["ops:search-result"];if(s){$(opsChooserApp.paginationViewBottom.el).show();var c=to_list(s["exchange-documents"]);r=_.map(c,function(e){return new OpsExchangeDocument(e["exchange-document"])})}e.reset(r);var l=o["ops:world-patent-data"]["ops:biblio-search"],d=l["@total-result-count"],p=l["ops:range"],u=p["@begin"]+"-"+p["@end"],h=l["ops:query"].$,m=h;t.set({result_count:d,result_range:u,result_count_received:r?r.length:0,query_origin:h,query_real:m}),t.set("keywords",_.union(a.keywords,t.get("keywords")))}},error:function(e,t){indicate_activity(!1),reset_content();var t=jQuery.parseJSON(t.responseText);"error"==t.status&&(_.each(t.errors,function(e){var t=_.template($("#backend-error-template").html()),i=t(e);$("#alert-area").append(i)}),$(".very-short").shorten({showChars:0,moreText:"more",lessText:"less"}))}})}}),OpsExchangeMetadata=Backbone.Model.extend({defaults:{debugmode:!1,reviewmode:!1,datasource:null,searchmode:null,page_size:25,result_count:null,result_range:null,result_count_received:null,query_origin:null,query_real:null,pagination_entry_count:12,pagination_pagesize_choices:[25,50,75,100],keywords:[],get_url:function(){var e=window.location.pathname+"?query="+encodeURIComponent($("#query").val())+"&pagesize="+this.page_size;return e},get_url_print:function(){return this.get_url()+"&print=true"},get_url_pdf:function(){var e=this.get_url()+"&pdf=true";return e}},initialize:function(){var e=$.url(window.location.href),t=e.param("pagesize");t&&this.set("page_size",parseInt(t));var i=e.param("debug");i&&this.set("debugmode",!0)},resetToDefaults:function(){this.set(this.defaults)},resetSomeDefaults:function(){this.set(_(this.defaults).pick("datasource","searchmode","result_count","result_range","result_count_received","query_origin","query_real","keywords"))}}),OpsExchangeDocument=Backbone.Model.extend({defaults:{selected:!1,get_patent_number:function(){return this["@country"]+this["@doc-number"]+this["@kind"]},_flatten_textstrings:function(e){var t={};return _(e).each(function(e,i){if("@document-id-type"==i?i="type":"doc-number"==i&&(i="number"),"object"==typeof e){var o=e.$;o&&(e=o)}t[i]=e}),t},get_publication_reference:function(e){var t=this["bibliographic-data"]["publication-reference"]["document-id"],i=_(t).find(function(t){return t["@document-id-type"]==e});return this._flatten_textstrings(i)},get_application_reference:function(e){var t=this["bibliographic-data"]["application-reference"]["document-id"],i=_(t).find(function(t){return t["@document-id-type"]==e});return this._flatten_textstrings(i)},get_applicants:function(e){try{var t=this["bibliographic-data"].parties.applicants}catch(i){return[]}t=t||[];var o=t.applicant,a=this.parties_to_list(o,"applicant-name");return e&&(a=this.enrich_links(a,"applicant")),a},get_inventors:function(e){try{var t=this["bibliographic-data"].parties.inventors}catch(i){return[]}t=t||[];var o=t.inventor,a=this.parties_to_list(o,"inventor-name");return e&&(a=this.enrich_links(a,"inventor")),a},parties_to_list:function(e,t){var i="0",o={};_.each(e,function(e){var a=e["@data-format"],n=e["@sequence"],r=_.string.trim(e[t].name.$,", ");o[a]=o[a]||{},o[a][n]=r,n>i&&(i=n)});var a=[];return _.each(_.range(1,parseInt(i)+1),function(e){e=e.toString();var t=o.epodoc[e],i=o.original[e],n=i;t&&(n=t.replace(/\[.+?\]/,"").trim()),a.push(n)}),a},get_ipc_list:function(e){var t=[],i=this["bibliographic-data"]["classifications-ipcr"];if(i){var o=to_list(i["classification-ipcr"]);t=_.map(o,function(e){return e.text.$})}return e&&(t=this.enrich_links(t,"ipc",function(e){return e.substring(0,15).replace(/ /g,"")})),t},enrich_links:function(e,t,i){var o=this;return _.map(e,function(e){return o.enrich_link(e,t,e,i)})},enrich_link:function(e,t,i,o){if(i||(i=e),PRINTMODE)return i;var a="external",n="_blank",r=null;o&&(i=o(i)),_.string.include(i," ")&&(i='"'+i+'"');var s;if("internal"==a?s=_.template('<a class="query-link" href="" data-query-attribute="<%= attribute %>" data-query-value="<%= value %>"> <%= label %> </a>'):"external"==a&&(r=encodeURIComponent(t+"="+i),s=_.template('<a href="?query=<%= query %>" target="<%= target %>" class="incognito"> <%= label %> </a>')),s){var c=s({label:e,attribute:t,value:i,target:n,query:r});return c}},_find_document_number:function(e,t){for(i in e){var o=e[i];if(o["@document-id-type"]==t){var a=(o.country?o.country.$:"")+(o["doc-number"]?o["doc-number"].$:"")+(o.kind?o.kind.$:"");return a}}},get_patent_citation_list:function(e){var t=this,i=[],o=this["bibliographic-data"]["references-cited"];if(o){var a=to_list(o.citation);i=a.filter(function(e){return e.patcit}).map(function(e){return t._find_document_number(e.patcit["document-id"],"docdb")})}return e&&(i=this.enrich_links(i,"pn")),i},_expand_links:function(e){var t=/(http|ftp|https):\/\/[\w-]+(\.[\w-]+)+([\w.,@?^=%&amp;:\/~+#-]*[\w@?^=%&amp;\/~+#-])?/g;return _(e.match(t)).each(function(t){e=e.replace(t,'<a href="'+t+'" target="_blank">'+t+"</a>")}),e},get_npl_citation_list:function(){var e=this,t=[],i=this["bibliographic-data"]["references-cited"];
if(i){var o=to_list(i.citation);t=o.filter(function(e){return e.nplcit}).map(function(e){return e.nplcit.text.$}).map(e._expand_links)}return t},get_drawing_url:function(){var e=_.template("/api/drawing/<%= patent_number %>"),t=e({patent_number:this.get_patent_number()});return t},get_fullimage_url:function(){var e=_.template("/api/ops/<%= patent_number %>/image/full"),t=e({patent_number:this.get_patent_number()});return t},get_espacenet_pdf_url:function(){var e=_.template("http://worldwide.espacenet.com/espacenetDocument.pdf?flavour=trueFull&FT=D&CC=<%= country %>&NR=<%= docnumber %><%= kind %>&KC=<%= kind %>"),t=e({country:this["@country"],docnumber:this["@doc-number"],kind:this["@kind"]});return t},get_ops_pdf_url:function(){var e=_.template("/api/ops/<%= country %><%= docnumber %><%= kind %>/pdf/all"),t=e({country:this["@country"],docnumber:this["@doc-number"],kind:this["@kind"]});return t},get_depatisnet_pdf_url:function(){var e=_.template("https://depatisnet.dpma.de/DepatisNet/depatisnet?action=pdf&docid=<%= country %><%= docnumber %><%= kind %>"),t=e({country:this["@country"],docnumber:this["@doc-number"],kind:this["@kind"]});return t},get_epo_register_url:function(){var e=this.get_application_reference("docdb"),t=_.template("https://register.epo.org/application?number=<%= country %><%= number %>"),i=t(e);return i},get_inpadoc_legal_url:function(){var e=_.template("http://worldwide.espacenet.com/publicationDetails/inpadoc?FT=D&CC=<%= country %>&NR=<%= docnumber %><%= kind %>&KC=<%= kind %>"),t=e({country:this["@country"],docnumber:this["@doc-number"],kind:this["@kind"]});return t},get_dpma_register_url:function(){var e=this.get_application_reference("docdb"),t=_.template("/office/dpma/register/application/<%= country %><%= number %>?redirect=true"),i=t(e);return i},get_uspto_pair_url:function(){var e=_.template("http://portal.uspto.gov/pair/PublicPair"),t=e({country:this["@country"],docnumber:this["@doc-number"],kind:this["@kind"]});return t},get_inpadoc_family_url:function(){var e=_.template("http://worldwide.espacenet.com/publicationDetails/inpadocPatentFamily?FT=D&CC=<%= country %>&NR=<%= docnumber %><%= kind %>&KC=<%= kind %>"),t=e({country:this["@country"],docnumber:this["@doc-number"],kind:this["@kind"]});return t},get_ops_family_url:function(){var e=_.template("http://ops.epo.org/3.0/rest-services/family/publication/docdb/<%= country %>.<%= docnumber %>.<%= kind %>/biblio,legal"),t=e({country:this["@country"],docnumber:this["@doc-number"],kind:this["@kind"]});return t},get_ccd_viewer_url:function(){var e=this.get_application_reference("epodoc"),t=_.template("http://ccd.fiveipoffices.org/CCD-2.0.4/html/viewCcd.html?num=<%= number %>&type=application&format=epodoc"),i=t(e);return i},get_depatisnet_url:function(){var e=this.get_publication_reference("docdb"),t=_.template("https://depatisnet.dpma.de/DepatisNet/depatisnet?action=bibdat&docid=<%= country %><%= number %><%= kind %>"),i=t(e);return i}},select:function(){this.set("selected",!0)},unselect:function(){this.set("selected",!1)}}),OpsExchangeDocumentCollection=Backbone.Collection.extend({model:OpsExchangeDocument,initialize:function(){}}),PaginationView=Backbone.Marionette.ItemView.extend({tagName:"div",template:"#ops-pagination-template",initialize:function(){this.listenTo(this.model,"change",this.render),this.listenTo(this,"item:rendered",this.setup_ui)},setup_ui:function(){var e=opsChooserApp.metadata.get("searchmode"),t=(opsChooserApp.metadata.get("datasource"),opsChooserApp.metadata.get("pagination_pagesize_choices")),i=opsChooserApp.metadata.get("page_size"),o=opsChooserApp.metadata.get("result_count"),a=opsChooserApp.metadata.get("pagination_entry_count"),n=opsChooserApp.metadata.get("result_range"),r=0;if("subsearch"==e&&(this.template="#ops-pagination-template-nopagesize"),o>0&&i>0){var s=o/i;s>=1&&(r=Math.ceil(s)),r=_.min([r,a])}return 1>r?void $(".page-size-chooser").parent().remove():($(this.el).find(".page-size-chooser ul").each(function(){$(this).empty();var e=this;_(t).map(function(t){var o="";o=t==i?'<i class="icon-check"></i>':'<i class="icon-check-empty"></i>';var a=_.template('<li><a href="" data-value="<%= entry %>"><%= icon %> <%= entry %></a></li>')({entry:t,icon:o});$(e).append(a)})}),$(this.el).find(".page-size-chooser a").click(function(){var e=$(this).data("value");return opsChooserApp.metadata.set("page_size",e),opsChooserApp.perform_search(),!1}),$(this.el).find(".pagination ul").each(function(){$(this).empty();var e=this;_.range(1,r*i,i).map(function(t){var o=t,a=o+i-1,n=o+"-"+a,r=_.template('<li><a href="" range="<%= range %>"><%= range %></a></li>')({range:n});$(e).append(r)})}),$(this.el).find(".pagination a").click(function(){var e=$(this).attr("range");return opsChooserApp.perform_search({range:e}),!1}),void $(this.el).find(".pagination").find("a").each(function(e,t){var i=$(t).attr("range");if(i==n){var o=$(t).parent();o.addClass("active")}}))},onDomRefresh:function(){}});
//# sourceMappingURL=/static/js/app.min.map