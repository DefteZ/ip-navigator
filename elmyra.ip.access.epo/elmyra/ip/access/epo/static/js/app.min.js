// (c) 2013,2014 Elmyra UG - All rights reserved
function getconfig(e,t){t=t||{};var o=opsChooserApp.config.get(e);return o&&(t.before&&(o=t.before+o),t.after&&(o+=t.after)),o}function propagate_opaque_errors(){var e=opsChooserApp.config.get("opaque.meta.status");if("error"==e){var t=opsChooserApp.config.get("opaque.meta.errors");_.each(t,function(e){"JSON Web Token"==e.location&&"expired"==e.description&&(e.description="We are sorry, it looks like the validity time of this link has expired at "+e.jwt_expiry_iso+'.<br/><br/>Please contact us at <a href="mailto:support@elmyra.de">support@elmyra.de</a> for any commercial plans.'),"JSON Web Signature"==e.location&&(e.description="It looks like the token used to encode this request is invalid. ("+e.description+")");var t=_.template($("#cornice-error-template").html()),o=t(e);$("#alert-area").append(o)})}}function boot_application(){console.log("boot_application"),$("#query").val(opsChooserApp.config.get("query")),$("#ui-title").html(getconfig("setting.ui.page.title")),$("#ui-subtitle").html(getconfig("setting.ui.page.subtitle")),$("#ui-statusline").html(getconfig("setting.ui.page.statusline")),$("#ui-productname").html(getconfig("setting.ui.productname")),$("#ui-footer").html(getconfig("setting.ui.page.footer",{after:"<br/>"})),$("#ui-footer-version").html(getconfig("setting.ui.version",{after:"<br/>"}));var e=opsChooserApp.config.get("datasource");e&&opsChooserApp.set_datasource(e),opsChooserApp.ui.reset_content(),propagate_opaque_errors(),opsChooserApp.trigger("application:ready"),opsChooserApp.ui.do_element_visibility()}function cql_field_chooser_text(e,t,o){var i=_.template($("#cql-field-chooser-entry").html());t=t.map(function(e){return e+"="});var n=i({label:e,fields:t,more:o});return n}function to_list(e){return _.isArray(e)&&e||[e]}function now_iso(){return moment().format()}function now_iso_human(){return moment().format("YYYY-MM-DD HH:mm:ss")}function now_iso_filename(){return moment().format("YYYY-MM-DD_HH:mm:ss")}function today_iso(){return moment().format("YYYY-MM-DD")}function changeTooltipColorTo(e){$(".tooltip-inner").css("background-color",e),$(".tooltip.top .tooltip-arrow").css("border-top-color",e),$(".tooltip.right .tooltip-arrow").css("border-right-color",e),$(".tooltip.left .tooltip-arrow").css("border-left-color",e),$(".tooltip.bottom .tooltip-arrow").css("border-bottom-color",e)}function quotate(e){return'"'+e+'"'}function asbool(e){switch("string"==typeof e&&(e=e.trim().toLowerCase()),e){case!0:case"true":case 1:case"1":case"on":case"yes":return!0;default:return!1}}function dotresolve(e,t){for(t=t.split(".");e&&t[0];)e=e[t.shift()]||void 0;return e}function deferreds_bundle(e){var t=$.Deferred();return $.when.apply($,e).then(function(){t.resolve()}),t.promise()}function htmlentities(e,t,o,i){var n=this.get_html_translation_table("HTML_ENTITIES",t),r="";if(e=null==e?"":e+"",!n)return!1;if(t&&"ENT_QUOTES"===t&&(n["'"]="&#039;"),i||null==i)for(r in n)n.hasOwnProperty(r)&&(e=e.split(r).join(n[r]));else e=e.replace(/([\s\S]*?)(&(?:#\d+|#x[\da-f]+|[a-zA-Z][\da-z]*);|$)/g,function(e,t,o){for(r in n)n.hasOwnProperty(r)&&(t=t.split(r).join(n[r]));return t+o});return e}function get_html_translation_table(e,t){var o,i={},n={},r={},a={},s={},c={};if(r[0]="HTML_SPECIALCHARS",r[1]="HTML_ENTITIES",a[0]="ENT_NOQUOTES",a[2]="ENT_COMPAT",a[3]="ENT_QUOTES",s=isNaN(e)?e?e.toUpperCase():"HTML_SPECIALCHARS":r[e],c=isNaN(t)?t?t.toUpperCase():"ENT_COMPAT":a[t],"HTML_SPECIALCHARS"!==s&&"HTML_ENTITIES"!==s)throw new Error("Table: "+s+" not supported");i[38]="&amp;","HTML_ENTITIES"===s&&(i[160]="&nbsp;",i[161]="&iexcl;",i[162]="&cent;",i[163]="&pound;",i[164]="&curren;",i[165]="&yen;",i[166]="&brvbar;",i[167]="&sect;",i[168]="&uml;",i[169]="&copy;",i[170]="&ordf;",i[171]="&laquo;",i[172]="&not;",i[173]="&shy;",i[174]="&reg;",i[175]="&macr;",i[176]="&deg;",i[177]="&plusmn;",i[178]="&sup2;",i[179]="&sup3;",i[180]="&acute;",i[181]="&micro;",i[182]="&para;",i[183]="&middot;",i[184]="&cedil;",i[185]="&sup1;",i[186]="&ordm;",i[187]="&raquo;",i[188]="&frac14;",i[189]="&frac12;",i[190]="&frac34;",i[191]="&iquest;",i[192]="&Agrave;",i[193]="&Aacute;",i[194]="&Acirc;",i[195]="&Atilde;",i[196]="&Auml;",i[197]="&Aring;",i[198]="&AElig;",i[199]="&Ccedil;",i[200]="&Egrave;",i[201]="&Eacute;",i[202]="&Ecirc;",i[203]="&Euml;",i[204]="&Igrave;",i[205]="&Iacute;",i[206]="&Icirc;",i[207]="&Iuml;",i[208]="&ETH;",i[209]="&Ntilde;",i[210]="&Ograve;",i[211]="&Oacute;",i[212]="&Ocirc;",i[213]="&Otilde;",i[214]="&Ouml;",i[215]="&times;",i[216]="&Oslash;",i[217]="&Ugrave;",i[218]="&Uacute;",i[219]="&Ucirc;",i[220]="&Uuml;",i[221]="&Yacute;",i[222]="&THORN;",i[223]="&szlig;",i[224]="&agrave;",i[225]="&aacute;",i[226]="&acirc;",i[227]="&atilde;",i[228]="&auml;",i[229]="&aring;",i[230]="&aelig;",i[231]="&ccedil;",i[232]="&egrave;",i[233]="&eacute;",i[234]="&ecirc;",i[235]="&euml;",i[236]="&igrave;",i[237]="&iacute;",i[238]="&icirc;",i[239]="&iuml;",i[240]="&eth;",i[241]="&ntilde;",i[242]="&ograve;",i[243]="&oacute;",i[244]="&ocirc;",i[245]="&otilde;",i[246]="&ouml;",i[247]="&divide;",i[248]="&oslash;",i[249]="&ugrave;",i[250]="&uacute;",i[251]="&ucirc;",i[252]="&uuml;",i[253]="&yacute;",i[254]="&thorn;",i[255]="&yuml;"),"ENT_NOQUOTES"!==c&&(i[34]="&quot;"),"ENT_QUOTES"===c&&(i[39]="&#39;"),i[60]="&lt;",i[62]="&gt;";for(o in i)i.hasOwnProperty(o)&&(n[String.fromCharCode(o)]=i[o]);return n}function opaquetoken(e){var t=$.Deferred();return $.ajax({method:"post",url:"/api/opaquelinks/token",async:!1,sync:!0,data:JSON.stringify(e),contentType:"application/json; charset=utf-8"}).success(function(e){e&&t.resolve(e)}).error(function(e){console.warn("Error while signing opaque parameters",e),t.reject(e)}),t.promise()}function opaquetoken_query(e){var t=$.Deferred();return opaquetoken(e).then(function(e){var o="op="+e;t.resolve(o)}),t.promise()}function opaque_param(e){return e=e||{},e.op?$.Deferred().resolve("op="+e.op):opaquetoken_query(e)}OpsChooserApp=Backbone.Marionette.Application.extend({get_datasource:function(){var e=$("#datasource > .btn.active").data("value");return e},set_datasource:function(e){$("#datasource .btn[data-value='"+e+"']").button("toggle"),this.queryBuilderView.cql_field_chooser_setup(),this.queryBuilderView.setup_comfort_form()},get_query:function(){return $("#query").val()},disable_reviewmode:function(){this.metadata.set("reviewmode",!1)},perform_search:function(e){e=e||{},e.datasource=o;var t=this.get_query(),o=this.get_datasource();this.metadata.set("datasource",o),this.metadata.resetSomeDefaults(e),e&&null!=e.reviewmode&&this.metadata.set("reviewmode",e.reviewmode);var i=this.metadata.get("reviewmode");if(1==i)return void this.basketModel.review(e);if(!_.isEmpty(t)){console.log("App.perform_search: datasource="+o,"query="+t,"options=",e),e.keywords=$("#keywords").val();var n=this;if("ops"==o){var r=this.compute_range(e);this.trigger("search:before",{datasource:o,query:t,range:r}),opsChooserApp.search.perform(this.documents,this.metadata,t,r).done(function(){var e=n.metadata.get("result_count");e>n.metadata.get("maximum_results").ops&&n.user_alert("Total hits: "+e+".    The first 2000 hits are accessible from OPS.  You can narrow your search by adding more search criteria.","warning"),n.metadata.set("keywords",opsChooserApp.search.keywords),n.trigger("results:ready")})}else if("depatisnet"==o){this.trigger("search:before",{datasource:o,query:t}),this.metadata.set("query_origin",t);var a=new DepatisnetSearch;a.perform(t,e).done(function(o){n.propagate_datasource_message(o),n.metadata.set("keywords",a.keywords),console.log("depatisnet response:",o);var i=o.numbers,r=o.hits;n.perform_listsearch(e,t,i,r,"pn","OR").done(function(){n.propagate_datasource_message(o)})})}else if("google"==o){this.trigger("search:before",{datasource:o,query:t}),this.metadata.set("query_origin",t);var s=new GooglePatentSearch;s.perform(t,e).done(function(o){e=e||{},n.propagate_datasource_message(o),n.metadata.set("keywords",s.keywords),console.log("google response:",o),console.log("google keywords:",s.keywords);var i=o.numbers,r=o.hits;i&&(e.remote_limit=100,n.perform_listsearch(e,t,i,r,"pn","OR").done(function(){n.propagate_datasource_message(o),null==r&&n.user_alert("Result count unknown. At Google Patents, sometimes result counts are not displayed. Let's assume 1000 to make the paging work.","warning"),r>n.metadata.get("maximum_results").google&&n.user_alert("Total results "+r+". From Google Patents, the first 1000 results are accessible. You might want to narrow your search by adding more search criteria.","warning")}))})}else if("ftpro"==o){this.trigger("search:before",{datasource:o,query:t}),this.metadata.set("query_origin",t);var c=new FulltextProSearch;c.perform(t,e).done(function(o){e=e||{},console.log("ftpro response:",o),n.propagate_datasource_message(o),n.metadata.set("keywords",c.keywords);var i=o.details,r=o.meta.MemCount;e.remote_limit=o.meta.Limit,n.perform_listsearch(e,t,i,r,"pn","OR").done(function(){n.propagate_datasource_message(o)})})}else this.ui.notify('Search provider "'+o+'" not implemented.',{type:"error",icon2:"icon-copy"})}},send_query:function(e,t){e&&($("#query").val(e),opsChooserApp.perform_search(t),$(window).scrollTop(0))},perform_listsearch:function(e,t,o,i,n,r){this.ui.indicate_activity(!1),this.ui.reset_content({keep_pager:!0,documents:!0});var a=e&&e.range?e.range:"1-10",s=a.split("-"),c=parseInt(s[0])-1,l=parseInt(s[1]);if(e&&e.remote_limit&&(log("slice options.remote_limit:",e.remote_limit),c%=e.remote_limit,l%=e.remote_limit,0==l&&(l=e.remote_limit-1)),console.log("local slices:",c,l),o&&(0==o.length||c>o.length)){var u=$.Deferred();if(u.resolve(),_.isEmpty(t)&&_.isEmpty(o))return this.ui.reset_content({keep_pager:!1,documents:!0}),this.user_alert("No results.","info"),u.promise()}var p=o.slice(c,l);if(!_.isEmpty(p)&&_.isObject(p[0]))try{this.results.reset(p)}catch(d){console.error("Problem propagating data to results collection",d)}else this.results.reset();var m=_(_.map(p,function(e){var t;return t=_.isObject(e)?e.publication_number:e,n+"="+t})),h=m.join(" "+r+" ");console.log("OPS CQL query:",h),t||(t=h),this.metadata.set("page_size",10),this.metadata.set("searchmode","subsearch");var f=this;return this.search.perform(this.documents,this.metadata,h,"1-10").done(function(){f.metadata.set("query_origin",t),f.metadata.set("result_count",i),f.metadata.set("result_range",a),f.metadata.set("pagination_entry_count",17),$(".pagination").removeClass("span10"),$(".pagination").addClass("span12"),f.results.set_reference_document_numbers(f.documents.get_document_numbers()),f.trigger("results:ready")})},parse_numberlist:function(e){if(!_.isEmpty(e)){var t=_(e.split(/[,\n]/)).map(function(e){return e.trim()}).filter(function(e){return!(_.isEmpty(e)||_.string.startsWith(e,"//")||_.string.startsWith(e,"#"))});return t}},perform_numberlistsearch:function(e){var t=this.parse_numberlist($("#numberlist").val()),o=t.length;this.perform_listsearch(e,void 0,t,o,"pn","OR")},compute_range:function(e){var t=this.metadata.get("page_size"),o="1-"+t,i=e&&e.range?e.range:o;return i},propagate_datasource_message:function(e){log("propagate_datasource_message"),this.user_alert(e.message,"warning")},user_alert:function(e,t){if(e){var o="INFO",i="alert-info";"warning"==t&&(o="WARNING",i="alert-warning");var n=_.template($("#alert-template").html()),r={title:o,description:e,clazz:i},a=n(r);$("#info-area").append(a)}},project_activate:function(e){var t=this;if(!e)return void console.error("project is null, will not activate");var o=e.get("name");console.log("App.project_activate:",o),this.project&&(this.stopListening(this.project),delete this.project),this.project=e,this.stopListening(this,"search:before"),this.listenTo(this,"search:before",function(t){e.record_query(t)}),$(window).off("focus",this.project_reload),$(window).on("focus",this.project_reload),this.projectChooserView=new ProjectChooserView({el:$("#project-chooser-area"),model:e,collection:e.collection}),this.projectChooserView.render(),this.storage.setup_ui(),this.permalink.setup_ui(),$("#ui-project-name").html('Review for project "'+e.get("name")+'".'),$("#ui-project-dates").html("Created "+moment(e.get("created")).fromNow()+", modified "+moment(e.get("modified")).fromNow()+"."),$("#ui-opaquelink-expiry").html("Link expires "+moment(this.config.get("link_expires")).fromNow()+"."),this.config.set("project",e.get("name"));var i=e.get("basket");i.fetch({success:function(){$.when(i.fetch_entries()).then(function(){t.basket_activate(i)})},error:function(){t.basket_deactivate()}})},project_deactivate:function(){$(window).off("focus",this.project_reload)},project_reload:function(){var e=opsChooserApp.project.get("name");opsChooserApp.trigger("project:load",e)},basket_deactivate:function(){this.basketModel&&(this.stopListening(this.basketModel),delete this.basketModel),this.basketView&&(this.basketView.close(),this.stopListening(this.basketView),delete this.basketView)},basket_activate:function(e){return console.log("App.basket_activate"),e?(this.basket_deactivate(),this.basketModel=e,this.basketView=new BasketView({model:e}),this.basketRegion.show(this.basketView),this.stopListening(null,"change:add"),this.stopListening(null,"change:remove"),this.listenTo(e,"change:add",this.basketController.link_document),this.listenTo(e,"change:remove",this.basketController.link_document),this.listenTo(e,"change:rate",this.basketController.link_document),this.stopListening(null,"change"),this.listenTo(e,"change",function(){this.project.save()}),this.listenTo(e,"change:add",function(e,t){this.basketView.textarea_scroll_text(t)}),this.basketView.render(),this.basket_bind_actions(),void this.trigger("basket:activated",e)):void console.error("basket is null, will not activate")},basket_bind_actions:function(){var e=this;$(".add-patent-number").unbind("click"),$(".add-patent-number").click(function(){var t=$(this).data("patent-number");e.basketModel.add(t)}),$(".remove-patent-number").unbind("click"),$(".remove-patent-number").click(function(){var t=$(this).data("patent-number");e.basketModel.remove(t)}),$("#basket-add-all-documents").unbind("click"),$("#basket-add-all-documents").click(function(){e.documents.each(function(t){var o=t.attributes.get_patent_number();e.basketModel.add(o)})}),console.log("setup rating widget"),$(".rating-widget").raty({number:3,hints:["slightly relevant","relevant","important"],cancel:!0,cancelHint:"not relevant",dismissible:!0,path:"/static/widget/raty/img",action:function(t){var o=t.score,i=t.dismiss,n=$(this).data("document-number");e.document_rate(n,o,i)}}),this.documents.each(function(t){var o=t.attributes.get_patent_number();if(e.basketModel){var i=e.basketModel.get_entry_by_number(o);e.basketController.link_document(i,o)}else e.basketController.link_document(void 0,o)})},document_rate:function(e,t,o){var i=this;e&&this.basketModel.add(e).then(function(n){n.save({score:t,dismiss:o},{success:function(){i.basketModel.trigger("change:rate",n,e),i.basketView.textarea_scroll_text(e)},error:function(){console.error("rating save error",e,n)}})})},shutdown_gui:function(){this.basketModel.destroy(),this.basket_bind_actions(),this.basketView.render(),this.comments.store.set(),this.projects.reset(),this.projectChooserView.clear()}}),opsChooserApp=new OpsChooserApp({config:ipsuiteNavigatorConfig}),opsChooserApp.addRegions({queryBuilderRegion:"#querybuilder-region",basketRegion:"#basket-region",metadataRegion:"#ops-metadata-region",listRegion:"#ops-collection-region",paginationRegionTop:"#ops-pagination-region-top",paginationRegionBottom:"#ops-pagination-region-bottom"}),opsChooserApp.addInitializer(function(){this.storage=new StoragePlugin,this.listenTo(this,"application:ready",function(){this.storage.setup_ui()}),this.listenTo(this,"results:ready",function(){this.storage.setup_ui()})}),opsChooserApp.addInitializer(function(){localforage.setDriver("localStorageWrapper"),localforage.config({name:this.config.get("context")});var e=this.config.get("database");e&&("viewer"==this.config.get("context")&&this.storage.dbreset(),this.LOAD_IN_PROGRESS=!0,this.storage.dbimport(e))}),opsChooserApp.addInitializer(function(){this.search=new OpsPublishedDataSearch,this.metadata=new OpsExchangeMetadata,this.documents=new OpsExchangeDocumentCollection,this.results=new ResultCollection}),opsChooserApp.addInitializer(function(){this.metadataView=new MetadataView({model:this.metadata}),this.collectionView=new OpsExchangeDocumentCollectionView({collection:this.documents}),this.resultView=new ResultCollectionView({collection:this.results}),this.paginationViewTop=new PaginationView({model:this.metadata}),this.paginationViewBottom=new PaginationView({model:this.metadata}),this.metadataRegion.show(this.metadataView),this.paginationRegionTop.show(this.paginationViewTop),this.paginationRegionBottom.show(this.paginationViewBottom)}),opsChooserApp.addInitializer(function(){}),opsChooserApp.addInitializer(function(){this.listenTo(this,"results:ready",function(){this.metadata.trigger("commit"),this.listRegion.show(this.collectionView)}),this.listenTo(this,"project:ready",this.project_activate),this.listenToOnce(this,"project:ready",function(){this.perform_search()})}),$(document).ready(function(){console.log("document.ready"),opsChooserApp.start(),boot_application()});var OPS_CQL_FIELDS=[{text:"<h4>Popular</h4>",children:[{id:"num",text:cql_field_chooser_text("Publication-, application- or<br/>priority number",["num"],"(10, 11, 21, 31)")},{id:"txt",text:cql_field_chooser_text("Title, abstract, inventor-, or applicant name",["txt"],"(54, 57, 72, 71, 73)")},{id:"cl",text:cql_field_chooser_text("CPC or IPC8 class",["cl"],"")}]},{text:"<h4>Publication</h4>",children:[{id:"pn",text:cql_field_chooser_text("Publication number",["pn","publicationnumber"],"(10, 11)")},{id:"pd",text:cql_field_chooser_text("Publication date",["pd","publicationdate"],"")},{id:"pa",text:cql_field_chooser_text("Applicant",["pa","applicant"],"(71, 73)")},{id:"in",text:cql_field_chooser_text("Inventor",["in","inventor"],"(72)")},{id:"ia",text:cql_field_chooser_text("Inventor or applicant",["ia","inventorandapplicant"],"(72, 71, 73)")},{id:"spn",text:cql_field_chooser_text("Publication number<br/><small>in epodoc format</small>",["spn"],"")}]},{text:"<h4>Text</h4>",children:[{id:"ti",text:cql_field_chooser_text("Title",["ti","title"],"(54)")},{id:"ab",text:cql_field_chooser_text("Abstract",["ab","abstract"],"(57)")},{id:"ta",text:cql_field_chooser_text("Title or abstract",["ta","titleandabstract"],"(54, 57)")},{id:"txt",text:cql_field_chooser_text("Title, abstract, inventor-, or applicant name",["txt"],"(54, 57, 72, 71, 73)")}]},{text:"<h4>Application, priority and family</h4>",children:[{id:"ap",text:cql_field_chooser_text("Application number",["ap","applicantnumber"],"(21)")},{id:"sap",text:cql_field_chooser_text("Application number<br/><small>in epodoc format</small>",["sap"],"")},{id:"pr",text:cql_field_chooser_text("Priority number",["pr","prioritynumber"],"(31)")},{id:"spr",text:cql_field_chooser_text("Priority number<br/><small>in epodoc format</small>",["spr"],"")},{id:"famn",text:cql_field_chooser_text("Family identifier (simple)",["famn"],"")}]},{text:"<h4>Classification</h4>",children:[{id:"cpc",text:cql_field_chooser_text("CPC classification<br/><small>(invention and additional)</small>",["cpc","cpci","cpca"],"")},{id:"ipc",text:cql_field_chooser_text("IPC8 class",["ipc","ic"],"")},{id:"ci",text:cql_field_chooser_text("IPC8 core invention class",["ci"],"")},{id:"cn",text:cql_field_chooser_text("IPC8 core additional class<br/><small>(non-invention)</small>",["cn"],"")},{id:"ai",text:cql_field_chooser_text("IPC8 advanced invention class",["ai"],"")},{id:"an",text:cql_field_chooser_text("IPC8 advanced additional class<br/><small>(non-invention)</small>",["an"],"")},{id:"a",text:cql_field_chooser_text("IPC8 advanced class",["a"],"")},{id:"c",text:cql_field_chooser_text("IPC8 core class",["c"],"")},{id:"cl",text:cql_field_chooser_text("CPC or IPC8 class",["cl"],"")}]},{text:"<h4>Citations</h4>",children:[{id:"ct",text:cql_field_chooser_text("Cited document number",["ct","citation"],"(56)")},{id:"ex",text:cql_field_chooser_text("Cited document number<br/><small>during examination</small>",["ex"],"")},{id:"op",text:cql_field_chooser_text("Cited document number<br/><small>during opposition</small>",["op"],"")},{id:"rf",text:cql_field_chooser_text("Cited document number<br/><small>provided by applicant</small>",["rf"],"")},{id:"oc",text:cql_field_chooser_text("Another cited document number",["oc"],"")}]}],DEPATISNET_CQL_FIELDS=[{text:"<h4>Publication</h4>",children:[{id:"pn",text:cql_field_chooser_text("Publication number",["pn"],"(10, 11)")},{id:"pc",text:cql_field_chooser_text("Country of publication",["pc"],"(19)")},{id:"pub",text:cql_field_chooser_text("Publication date",["pub"],"")},{id:"py",text:cql_field_chooser_text("Publication year",["py"],"")},{id:"pa",text:cql_field_chooser_text("Applicant/Owner",["pa"],"(71, 73)")},{id:"in",text:cql_field_chooser_text("Inventor",["in"],"(72)")},{id:"pcod",text:cql_field_chooser_text("Kind code",["pcod"],"(12)")}]},{text:"<h4>Text</h4>",children:[{id:"ti",text:cql_field_chooser_text("Title",["ti"],"(54)")},{id:"ab",text:cql_field_chooser_text("Abstract",["ab"],"(57)")},{id:"de",text:cql_field_chooser_text("Description",["de"],"")},{id:"cl",text:cql_field_chooser_text("Claims",["cl"],"(57)")},{id:"bi",text:cql_field_chooser_text("Full text data",["bi"])}]},{text:"<h4>Application</h4>",children:[{id:"an",text:cql_field_chooser_text("Application number",["ap"],"(21)")},{id:"ac",text:cql_field_chooser_text("Country of application",["ac"],"")},{id:"ad",text:cql_field_chooser_text("Application date",["ad"],"(22, 96)")},{id:"ay",text:cql_field_chooser_text("Application year",["ay"],"")}]},{text:"<h4>Priority</h4>",children:[{id:"prn",text:cql_field_chooser_text("Priority number",["prn"],"(31)")},{id:"prc",text:cql_field_chooser_text("Country of priority",["prc"],"(33)")},{id:"prd",text:cql_field_chooser_text("Priority date",["prd"],"(32)")},{id:"pry",text:cql_field_chooser_text("Priority year",["pry"],"")}]},{text:"<h4>Citations</h4>",children:[{id:"ct",text:cql_field_chooser_text("Cited documents",["ct"],"(56)")},{id:"ctnp",text:cql_field_chooser_text("Cited non-patent literature",["ctnp"],"(56)")}]},{text:"<h4>All IPC</h4>",children:[{id:"ic",text:cql_field_chooser_text("All IPC fields",["ic"],"")}]},{text:"<h4>Bibliographic IPC</h4>",children:[{id:"icb",text:cql_field_chooser_text("Bibliographic IPC",["icb"],"")},{id:"icm",text:cql_field_chooser_text("IPC main class",["icm"],"(51)")},{id:"ics",text:cql_field_chooser_text("IPC secondary class",["ics"],"(51)")},{id:"ica",text:cql_field_chooser_text("IPC additional class",["ica"],"")},{id:"ici",text:cql_field_chooser_text("IPC index classes",["ici"],"")},{id:"icmv",text:cql_field_chooser_text("IPC main class version",["icmv"],"")},{id:"icsv",text:cql_field_chooser_text("IPC secondary class version",["icsv"],"")},{id:"icav",text:cql_field_chooser_text("IPC additional class version",["icav"],"")},{id:"icml",text:cql_field_chooser_text("IPC main class level",["icml"],"")},{id:"icsl",text:cql_field_chooser_text("IPC secondary class level",["icsl"],"")},{id:"ical",text:cql_field_chooser_text("IPC additional class level",["ical"],"")}]},{text:"<h4>Reclassified IPC</h4>",children:[{id:"mcd",text:cql_field_chooser_text("Reclassified IPC",["mcd"],"")},{id:"mcm",text:cql_field_chooser_text("MCD main class",["mcm"],"")},{id:"mcs",text:cql_field_chooser_text("MCD secondary class",["mcs"],"")},{id:"mca",text:cql_field_chooser_text("MCD additional class",["mca"],"")},{id:"mcml",text:cql_field_chooser_text("MCD main class level",["mcml"],"")},{id:"mcsl",text:cql_field_chooser_text("MCD secondary class level",["mcsl"],"")},{id:"mcal",text:cql_field_chooser_text("MCD additional class level",["mcal"],"")}]},{text:"<h4>Search file IPC</h4>",children:[{id:"icp",text:cql_field_chooser_text("Search file IPC",["icp"],"")}]}];UiController=Marionette.Controller.extend({initialize:function(){log("UiController.initialize")},setup_ui:function(){$(".btn-popover").popover(),this.setup_text_tools(),$.notify.defaults({className:"info",showAnimation:"fadeIn",hideAnimation:"fadeOut",autoHideDelay:4e3,showDuration:300}),"liveview"==opsChooserApp.config.get("mode")&&$(".logout-button").hide(),opsChooserApp.config.get("query")&&opsChooserApp.queryBuilderView.set_flavor("cql"),$(".link-help").click(function(){var e=opsChooserApp.config.get("baseurl"),t=e+"/help";$(this).attr("href",t)})},setup_text_tools:function(){$(".very-short").shorten({showChars:5,moreText:"more",lessText:"less"})},reset_content:function(e){$("#alert-area").empty(),$("#info-area").empty(),$("#pagination-info").hide(),e=e||{},e.keep_pager||$(".pager-area").hide(),e.documents&&opsChooserApp.documents.reset()},indicate_activity:function(e){e?($(".idler").hide(),$(".spinner").show()):($(".spinner").hide(),$(".idler").show())},propagate_alerts:function(e){$("#alert-area").empty();try{var t=jQuery.parseJSON(e);"error"==t.status&&(_.each(t.errors,function(e){var t=_.template($("#cornice-error-template").html()),o=t(e);$("#alert-area").append(o)}),$(".very-short").shorten({showChars:0,moreText:"more",lessText:"less"}))}catch(o){var t=e;$("#alert-area").append(t)}},do_element_visibility:function(){var e="print"==opsChooserApp.config.get("mode");e&&$(".do-not-print").hide();var t="liveview"==opsChooserApp.config.get("mode");t&&$(".non-liveview").hide()},do_elements_focus:function(){opsChooserApp.documents.length&&($("#patentnumber").blur(),$("#query").blur())},confirm:function(e){var t=$.Deferred(),o=bootbox.confirm("<h4>"+e+"</h4>",function(e){e&&t.resolve()});return o.css({color:"#b94a48","background-color":"#f2dede","border-color":"#eed3d7"}),t.promise()},notify:function(e,t){t.icon&&(e='<span class="icon '+t.icon+' icon-large"></span><p>'+e+"</p>"),t.type||(t.type="notice"),this.notification&&this.notification.dismiss(),this.notification=new NotificationFx({message:e,layout:"attached",effect:"bouncyflip",type:t.type,onClose:function(){}}),this.notification.show()},scroll_smooth:function(e){$(e).offset()&&$("html, body").animate({scrollTop:$(e).offset().top},500)},copy_to_clipboard:function(e,t,o){o=o||{};var i=$.Deferred(),n=new ZeroClipboard(o.element);return n.on("ready",function(){n.on("copy",function(o){var i=o.clipboardData;_.isFunction(t)&&(t=t()),i.setData(e,t)}),n.on("aftercopy",function(t){var o=t.data[e].length,i="Bytes";if(o>=1e3)var o=Math.round(o/1e3),i="kB";var n="Copied content to clipboard, size is "+o+" "+i+".";_ui.notify(n,{type:"success",icon:"icon-copy"})}),i.resolve(n)}),i.promise()}});var _ui;if(opsChooserApp.addInitializer(function(){this.ui=new UiController,_ui=this.ui,this.listenTo(this,"application:ready",function(){this.ui.setup_ui()}),this.listenTo(this,"results:ready",function(){this.ui.do_elements_focus()})}),timestamp=now_iso,Function.prototype.bind)var log=Function.prototype.bind.call(console.log,console);else var log=function(){};_.clear=function(e){e.length=0},function(e){e.fn.extend({qnotify:function(t,o){o=o||{},_.defaults(o,{className:"info",position:"bottom"}),o.error&&(o.className="error"),o.success&&(o.className="success"),(o.warn||o.warning)&&(o.className="warning"),e(this).notify(t,o)}})}(jQuery),jQuery.fn.handle_enter_keypress=function(){var e=_.string.contains(navigator.userAgent,".NET");e&&$(this).find("input").keypress(function(e){"13"==e.which&&$(this).closest("form").find("button[type=submit],input[type=submit]").filter(":first").click()})},_.mixin({objMap:function(e,t,o){return _.reduce(e,function(i,n,r){return i[r]=t.call(o,n,r,e),i},{},o)},objFilter:function(e,t,o){return _.reduce(e,function(i,n,r){return t.call(o,n,r,e)&&(i[r]=n),i},{},o)},objReject:function(e,t,o){return _.reduce(e,function(i,n,r){return t.call(o,n,r,e)||(i[r]=n),i},{},o)},objRejectEmpty:function(e){return _.objReject(e,function(e){return _.isEmpty(e)})}}),BasketModel=Backbone.RelationalModel.extend({sync:Backbone.localforage.sync("Basket"),relations:[{type:Backbone.HasMany,key:"entries",relatedModel:"BasketEntryModel",includeInJSON:Backbone.Model.prototype.idAttribute}],defaults:{},initialize:function(){console.log("BasketModel.initialize"),this.fetchRelated||(this.fetchRelated=this.getAsync)},init_from_query:function(){var e=[],t=this,o=opsChooserApp.config.get("numberlist");if(o){o=decodeURIComponent(o);var i=o.split(/[,\n]/);_(i).each(function(o){var i=t.add(o);e.push(i)})}return deferreds_bundle(e)},get_entry_by_number:function(e){var t=this.get("entries").where({number:e});return _.isEmpty(t)?void 0:t[0]},add:function(e){var t=this;if(e=e.trim(),!_.isEmpty(e)){var o=$.Deferred(),i=this.get_entry_by_number(e);if(i)return i.fetch({success:function(){o.resolve(i),t.trigger("change",t)}}),o.promise();var n=_.find(opsChooserApp.documents.models,function(t){var o=t.get_document_number();return e==o}),r=n?n.attributes.get_title_list():void 0;return i=new BasketEntryModel({number:e,timestamp:now_iso(),title:r}),i.save(null,{success:function(){var n=t.get("entries");n.add(i),t.save({entries:n},{success:function(){$.when(t.fetch_entries()).then(function(){o.resolve(t.get_entry_by_number(i.get("number"))),t.trigger("change",t),t.trigger("change:add",i,e)})}})}}),o.promise()}},remove:function(e){var t=this,o=this.get_entry_by_number(e);if(o){var i=this.get("entries");i.remove(o),o.destroy(),t.save({entries:i},{success:function(){$.when(t.fetch_entries()).then(function(){t.trigger("change:remove",o,e),t.trigger("change",t)})}})}},get_numbers:function(){return this.get("entries").invoke("get","number")},empty:function(){return 0==this.get("entries").length},csv_list:function(){return this.get("entries").map(function(e){var t=[e.get("number"),e.get("score"),e.get("dismiss")],o=t.join(",");return o})},unicode_stars_list:function(){return this.get("entries").map(function(e){var t=_.string.ljust(e.get("number"),20," ")+_.string.ljust(e.get("dismiss")?"∅":"",5," ")+_.string.repeat("★",e.get("score"));return t})},unicode_stars_list_email:function(){var e=String.fromCharCode(160);return this.get("entries").map(function(t){var o=(t.get("dismiss")?"∅":"")+_.string.repeat("★",t.get("score")),i=10-1.7*o.length,n=_.string.repeat(e,i),r=o+n+t.get("number");return r})},review:function(e){var t=this.get_numbers(),o=t.length;opsChooserApp.set_datasource("review"),opsChooserApp.metadata.set("reviewmode",!0),opsChooserApp.perform_listsearch(e,void 0,t,o,"pn","OR")},fetch_entries:function(){var e=this,t=$.Deferred();return $.when(this.fetchRelated("entries")).then(function(){var o=[];e.get("entries").each(function(e){var t=$.Deferred();o.push(t.promise()),e.fetch({success:function(){t.resolve(e)},error:function(){console.log("error while fetching basket entry:",e),e.save(null,{success:function(){console.log("success"),t.resolve(e)},error:function(){console.log("error"),t.resolve(e)}})}})}),$.when.apply($,o).then(function(){t.resolve()})}),t.promise()},get_view_state:function(e){e=e||{};var t=opsChooserApp.project.get("name"),o=this.get_numbers(),i=o.join(","),n={context:"viewer",project:t,query:void 0,datasource:"review",numberlist:i};return _(n).extend(e),n},share_email_params:function(){var e=opsChooserApp.project.get("name"),t=opsChooserApp.permalink.make_uri(this.get_view_state({project:"via-email"})),o=this.get_numbers(),i=o.length,n=this.csv_list(),r=this.unicode_stars_list_email(),a=_.template('Shared <%= count %> patent numbers through project "<%= projectname %>" at <%= date %>')({count:i,date:now_iso_human(),projectname:e}),s=_.template($("#basket-mail-template").html().trim()),c=s({subject:a,basket_plain:o.join("\n"),basket_csv:n.join("\n"),basket_stars:r.join("\n"),url:t}),l={subject:"[IPSUITE] "+a,body:c};return l}}),BasketEntryModel=Backbone.RelationalModel.extend({sync:Backbone.localforage.sync("BasketEntry"),defaults:{number:void 0,timestamp:void 0,title:void 0,score:void 0,dismiss:void 0},initialize:function(){}}),BasketView=Backbone.Marionette.ItemView.extend({template:"#basket-template",initialize:function(){this.listenTo(this.model,"change",this.render),this.listenTo(this,"item:rendered",this.setup_ui),this.templateHelpers.config=opsChooserApp.config
},templateHelpers:{},serializeData:function(){var e={};e=this.model.toJSON();var t=this.model.unicode_stars_list();return t&&(e.numbers_display=t.join("\n")),e},setup_ui:function(){var e=this,t=this.model.get("entries").length;$(".basket-entry-count").text(t);var o=opsChooserApp.config.get("ship-url");o?$("#basket-submit-button").removeClass("hide"):$("#basket-submit-button").addClass("hide"),$("#basket").unbind("paste"),$("#basket").on("paste",function(t){t.preventDefault();var o=(t.originalEvent||t).clipboardData.getData("text"),i=o.split(/[,;\r\n]/);_.each(i,function(t){e.model.add(t)})}),$("#basket-import-button").unbind("click"),$("#basket-import-button").click(function(){return e.future_premium_feature(),!1}),$(".basket-review-button").unbind("click"),$(".basket-review-button").click(function(t){t.preventDefault(),e.check_empty({kind:"review",icon:"icon-indent-left"})||e.model.review()}),$("#basket-submit-button").unbind("click"),$("#basket-submit-button").click(function(){if(!e.check_empty()){var t=e.model.get_numbers();$("textarea#basket").val(t.join("\n"))}}),$("#share-numberlist-email").unbind("click"),$("#share-numberlist-email").click(function(){if(!e.check_empty()){var t=e.model.share_email_params(),o="mailto:?"+jQuery.param(t).replace(/\+/g,"%20");$(this).attr("href",o)}}),_ui.copy_to_clipboard("text/plain",function(){if(!e.check_empty()){var t=e.model.get_numbers();return t.join("\n")}},{element:$("#share-numberlist-clipboard")}),$("#share-numberlist-url").unbind("click"),$("#share-numberlist-url").click(function(){if(!e.check_empty()){var t=opsChooserApp.permalink.make_uri(e.model.get_view_state());$(this).attr("target","_blank"),$(this).attr("href",t)}}),$("#share-numberlist-url-ttl").unbind("click"),$("#share-numberlist-url-ttl").click(function(t){if(t.preventDefault(),t.stopPropagation(),!e.check_empty()){var o=this;opsChooserApp.permalink.make_uri_opaque(e.model.get_view_state({mode:"liveview"})).then(function(e){opsChooserApp.permalink.popover_show(o,e,{title:"External document review",intro:"<small>This offers a link for external/anonymous users to review the collected documents. It will just transfer the plain numberlist without any rating scores.</small>",ttl:!0})})}}),$("#download-documents-pdf-archive").unbind("click"),$("#download-documents-pdf-archive").click(function(){if(!e.check_empty()){var t=opsChooserApp.basketModel.get_numbers();$(this).attr("target","_blank"),$(this).attr("href","/api/pdf/"+t.join(","))}}),$("#share-documents-transfer").unbind("click"),$("#share-documents-transfer").click(function(){e.future_premium_feature()}),$(".permalink-review-liveview").unbind("click"),$(".permalink-review-liveview").click(function(e){e.preventDefault(),e.stopPropagation();var t=this;opsChooserApp.permalink.liveview_with_database_params().then(function(e){var o=opsChooserApp.permalink.make_uri(e);opsChooserApp.permalink.popover_show(t,o,{intro:"<small>This offers a persistent link to review the current project. It will transfer the whole project structure including queries and basket content with rating scores.</small>"})})}),$(".permalink-review-liveview-ttl").unbind("click"),$(".permalink-review-liveview-ttl").click(function(e){e.preventDefault(),e.stopPropagation();var t=this;opsChooserApp.permalink.liveview_with_database_params().then(function(e){opsChooserApp.permalink.make_uri_opaque(e).then(function(e){opsChooserApp.permalink.popover_show(t,e,{intro:"<small>This offers a link for external/anonymous users to review the current project. It will transfer the whole project structure including queries and basket content with rating scores.</small>",ttl:!0})})})})},check_empty:function(e){e=e||{};var t="shared";return"review"==e.kind&&(t="reviewed"),e.icon||(e.icon="icon-external-link"),this.model.empty()?(opsChooserApp.ui.notify("An empty collection can't be "+t+", please add some documents.",{type:"warning",icon:e.icon+" icon-large"}),!0):!1},future_premium_feature:function(){bootbox.dialog("Available soon via subscription.",[{label:"OK",icon:"OK",callback:null}],{header:"Future feature"})},textarea_scroll_bottom:function(){$("#basket").scrollTop($("#basket")[0].scrollHeight)},textarea_scroll_text:function(e){var t=$("#basket"),o=t.text().search(e);o&&t.scrollTop(o)}}),BasketController=Marionette.Controller.extend({initialize:function(){console.log("BasketController.initialize")},link_document:function(e,t){var o=opsChooserApp.basketModel?opsChooserApp.basketModel.get_numbers():[],i=$("#chk-patent-number-"+t),n=$("#add-patent-number-"+t),r=$("#remove-patent-number-"+t),a=$("#rate-patent-number-"+t),s=a.closest(".ops-collection-entry-heading");if(_(o).contains(t)){if(i&&i.prop("checked",!0),n&&n.hide(),r&&r.show(),e){var c=e.get("score"),l=e.get("dismiss");a.raty("score",c),a.raty("dismiss",l),s.toggleClass("dismiss",Boolean(l)),s.toggleClass("score1",1==c),s.toggleClass("score2",2==c),s.toggleClass("score3",3==c)}}else i&&i.prop("checked",!1),n&&n.show(),r&&r.hide(),a.raty("reload"),s.toggleClass("dismiss",!1),s.toggleClass("score1",!1),s.toggleClass("score2",!1),s.toggleClass("score3",!1)}}),opsChooserApp.addInitializer(function(){this.basketController=new BasketController,this.listenTo(this,"application:ready",function(){"review"==this.config.get("datasource")&&this.listenToOnce(this,"basket:activated",function(e){$.when(e.init_from_query()).then(function(){e.review()})})})}),CommentModel=Backbone.RelationalModel.extend({sync:Backbone.localforage.sync("Comment"),relations:[{type:Backbone.HasOne,key:"project",relatedModel:"ProjectModel",includeInJSON:Backbone.Model.prototype.idAttribute}],defaults:{parent:void 0,created:void 0,modified:void 0,author:void 0,text:void 0},initialize:function(){console.log("CommentModel.initialize")},save:function(e,t,o){null==e||"object"==typeof e?(attrs=e,o=t):(attrs={})[e]=t,o=_.extend({},o);var i=this,n=timestamp(),r=this.isNew(),a={};r&&(a.created=n),a.modified=n,this.set(a);var s=this.get("project"),c=o.success;return o.success=function(e,t,o){r?i.collection.create(e,{success:function(){o.isNew=r,i.collection.add(e),e.set("project",s),i.trigger("saved",e,t,o),c&&c(e,t,o)}}):(i.trigger("saved",e,t,o),c&&c(e,t,o))},Backbone.Model.prototype.save.call(this,attrs,o)}}),CommentCollection=Backbone.Collection.extend({sync:Backbone.localforage.sync("Comment"),find:Backbone.localforage.find,model:CommentModel,initialize:function(){console.log("CommentCollection.initialize")},get_or_create:function(e){var t=_(this.where(e)).first();return t||(t=this.model.build(e,{collection:this,parsed:!1})),t},by_project_and_document_number:function(e,t){return this.get_or_create({project:e,parent:t})}}),CommentButtonView=Backbone.Marionette.ItemView.extend({template:"#template-comment-button",tagName:"span",triggers:{click:"toggle"}}),CommentTextView=Backbone.Marionette.ItemView.extend({template:"#template-comment-text",tagName:"span",initialize:function(){console.log("CommentTextView.initialize"),this.listenTo(this.model,"remove",this.clear)},onRender:function(){var e=this.get_textarea();e.val(this.model.get("text"))},clear:function(){this.get_textarea().val(void 0)},get_widget:function(){return $(this.el).find(":first-child").first()},get_textarea:function(){return $(this.el).find("textarea")},toggle:function(){var e=this;this.get_widget().slideToggle();var t=this.get_textarea();t.off("blur"),t.on("blur",function(){var o=t.val();e.save(o)})},save:function(e){var t=this.model.get("text");return e!=t?(this.model.set({text:e}),this.model.save()):void 0}}),CommentManager=Marionette.Controller.extend({initialize:function(e){log("CommentManager.initialize"),this.collection=e.collection,this.project=e.project,this.itemview=e.itemview,this.model=this.get_or_create(),this.comment_button=new CommentButtonView,this.comment_text=new CommentTextView({model:this.model,collection:this.collection}),this.itemview.region_comment_button.show(this.comment_button),this.itemview.region_comment_text.show(this.comment_text),this.listenTo(this.comment_button,"toggle",this.toggle_edit)},toggle_edit:function(){this.comment_text.toggle()},get_or_create:function(){var e=this.itemview.model.get_document_number(),t=this.collection.by_project_and_document_number(this.project,e);return t}}),CommentsPlugin=Marionette.Controller.extend({initialize:function(e){console.log("CommentsPlugin.initialize");this.view=e.view,this.itemviews=[],this.store=new CommentCollection,this.store.fetch({success:function(){log("CommentsPlugin: fetch ready")}}),this.listenTo(this.view,"itemview:item:rendered",function(e){e.comment_manager=this.comment_factory(e),this.itemviews.push(e)}),this.listenTo(this.view,"collection:before:render",function(){_.clear(this.itemviews)}),this.listenTo(this.view,"collection:before:close",function(){_.clear(this.itemviews)}),this.listenTo(opsChooserApp,"project:changed",function(){var e=this;_(this.itemviews).each(function(t){t.comment_manager=e.comment_factory(t)})}),this.bind_hotkeys()},comment_factory:function(e){var t=opsChooserApp.project;return log("comment_factory using project:",t),new CommentManager({collection:this.store,project:t,itemview:e})},bind_hotkeys:function(){var e=this;$(document).on("keydown",null,"C",function(){e.viewport_toggle_comment()})},viewport_toggle_comment:function(){var e=$(".document-actions:in-viewport").closest(".ops-collection-entry").backboneView();e.comment_manager&&e.comment_manager.toggle_edit()}}),opsChooserApp.addInitializer(function(){this.LOAD_IN_PROGRESS?this.listenTo(this,"projects:initialize",function(){this.comments=new CommentsPlugin({view:this.collectionView})}):this.comments=new CommentsPlugin({view:this.collectionView})}),DocumentBaseController=Marionette.Controller.extend({initialize:function(){console.log("DocumentBaseController.initialize")},setup_ui:function(){opsChooserApp.ui.do_element_visibility();var e="print"==opsChooserApp.config.get("mode");e||($(".cql-query").shorten({showChars:125,moreText:"more",lessText:"less"}),$("#result-count-total").autoNumeric("init",{mDec:0}),$(opsChooserApp.paginationViewBottom.el).show(),opsChooserApp.basket_bind_actions(),$(".abstract").shorten({showChars:2e3,moreText:"more",lessText:"less"}),$(".btn-popover").popover(),$(".inid-tooltip").tooltip(),$(".query-link").unbind("click"),$(".query-link").on("click",function(){var e=$(this).attr("href"),t=opsChooserApp.permalink.query_parameters_viewstate(e);if(t.datasource="ops",opsChooserApp.config.get("isviewer")){t.mode="liveview";var o=this;opaque_param(t).then(function(e){$(o).attr("href","?"+e)})}else $(this).attr("href","?"+jQuery.param(t))}),$(".abstract-acquire").on("click",function(e){e.preventDefault();var t=$(this).data("lang"),o=$(this).closest(".ops-collection-entry").prop("ops-document");$(this).after('<span class="abstract-acquire-spinner">&nbsp;&nbsp;<i class="icon-refresh icon-spin"></i></span>');var i=opsChooserApp.document_details.get_fulltext(o),n=this;i.get_abstract(t).then(function(e){$(n).replaceWith(e.html),$(".abstract-acquire-spinner").detach()})}),$(".embed-item").each(function(e,t){var o=$(t).data("embed-url"),i=$(t).data("document-number");if(o){var n=_.template(o,null,{interpolate:/\{\{(.+?)\}\}/g}),r=n({publication_number:i}),a='<iframe src="'+r+'" class="container-fluid well" seamless="seamless" height2="200" width2="100%" style="min-height: 50%; min-width: 80%"/>';$(this).append(a)}}))},enrich_links:function(e,t,o){var i=this;return _.map(e,function(e){return i.enrich_link(e,t,e,o)})},enrich_link:function(e,t,o,i){o||(o=e);var n="print"==opsChooserApp.config.get("mode");if(n)return o;var r="external",a="_blank",s=null;i&&(o=i(o)),_.string.include(o," ")&&(o='"'+o+'"');var c;if("internal"==r?c=_.template('<a href="" class="query-link" data-query-attribute="<%= attribute %>" data-query-value="<%= value %>"><%= label %></a>'):"external"==r&&(s=encodeURIComponent(t+"="+o),c=_.template('<a href="?query=<%= query %>" class="query-link incognito" target="<%= target %>"><%= label %></a>')),c){var l=c({label:e,attribute:t,value:o,target:a,query:s});return l}}}),DocumentDetailsController=Marionette.Controller.extend({initialize:function(){console.log("DocumentDetailsController.initialize")},setup_ui:function(){var e=this;$('.document-details-chooser > button[data-toggle="tab"]').on("show",function(t){var o=$($(t.target).attr("href")),i=$(this).data("details-type"),n=$(this).closest(".ops-collection-entry").prop("ops-document");if(n)if(_(["claims","description"]).contains(i)){var r=e.get_fulltext_details(i,n);e.display_details(r,o)}else if("family"==i){var a=$(o).find(".family-chooser");a.find('button[data-toggle="tab"]').on("show",function(){var t=$(this).data("view-type");e.display_family(n,o,t)}),e.display_family(n,o,"compact")}$(".btn-popover").popover()})},get_fulltext:function(e){var t=OpsFulltext,o=e.get_publication_number("epodoc"),i=e["@country"];return _(["DE","US"]).contains(i)&&(t=DepatisConnectFulltext,o=e.get_publication_number("docdb")),new t(o)},get_fulltext_details:function(e,t){var o=this.get_fulltext(t);return"description"==e?o.get_description():"claims"==e?o.get_claims():void 0},display_details:function(e,t){var o=this,i=t.find(".document-details-content"),n=t.find(".document-details-language");i&&(this.indicate_activity(t,!0),e.then(function(e){o.indicate_activity(t,!1),e&&($(i).html(e.html),e.lang&&$(n).html("["+e.lang+"]"),opsChooserApp.document_highlighting.apply($(i).find("*")))}))},display_family:function(e,t,o){var i=OpsFamilyCompactCollectionView;"verbose"==o&&(i=OpsFamilyVerboseCollectionView);var n=e.get_publication_number("epodoc"),r=new OpsFamilyCollection(null,{document_number:n}),a=t.find(".document-details-content"),s=new Backbone.Marionette.Region({el:a}),c=new i({collection:r});s.show(c);var l=this;l.indicate_activity(t,!0),r.fetch().then(function(){l.indicate_activity(t,!1)})},indicate_activity:function(e,t){var o=e.find(".document-details-spinner");t?o.show():o.hide()}}),DocumentCarouselController=Marionette.Controller.extend({initialize:function(){console.log("DocumentCarouselController.initialize")},setup_ui:function(){var e=this;$(".drawings-carousel").carousel({interval:null}),$(".drawings-carousel").bind("slid",function(){e.update_carousel_metadata(this)});var t=$(".drawings-carousel .carousel-control.right");t.click(function(){var t=$(this).closest(".ops-collection-entry").find(".drawings-carousel");e.carousel_fetch_next(t)}),$(".drawings-carousel").each(function(t,o){var o=$(o),i=o.data("totalcount");if(!i){i=1;var n=o.closest(".ops-collection-entry").data("document-number");if(!n)return void console.warn("document-number could not be found, won't proceed loading items into carousel");var r=_.template("/api/ops/<%= patent %>/image/info")({patent:n});$.ajax({url:r,async:!0}).success(function(t){t&&(i=t.META["drawing-total-count"],o.data("totalcount",i),e.update_carousel_metadata(o))}).error(function(e){console.warn("Error while fetching total count of drawings",e)}),o.data("totalcount",i),e.update_carousel_metadata(o)}});var o=$(".drawings-carousel").find("img");o.error(function(){$(this).hide();var e='<br/><blockquote class="text-center" style="min-height: 300px"><br/><br/><br/><br/><br/><br/>No image</blockquote>';$(this).closest(".carousel").hide().parent().find(".drawing-info").html(e)})},update_carousel_metadata:function(e){var t=$(e).closest(".ops-collection-entry"),o=$(e).data("carousel");if(o){var i=o.getActiveIndex()+1;t.find(".drawing-number").text(i)}var n=$(e).data("totalcount");n&&t.find(".drawing-totalcount").text("/"+n)},carousel_fetch_next:function(e){var t=e.find(".carousel-inner"),o=t.find("div.active").index()+1,i=t.find("div").length;if(o==i){var n=e.data("totalcount");if(n&&!(i>=n)){var r=$(t).children(":first").clone(),a=$(t).height();$(r).removeClass("active");var s=$(r).children("img"),c=s.attr("src").replace(/\?page=.*/,"");c+="?page="+(o+1),s.attr("src",c),$(r).attr("min-height",a),$(r).height(a),$(t).append(r)}}}}),PdfPanelController=Marionette.Controller.extend({initialize:function(){console.log("PdfPanelController.initialize")},setup_ui:function(){var e=this;$(".pdf-open").click(function(){var t=$(this).data("patent-number"),o=$(this).data("pdf-url"),i=1;e.pdf_set_headline(t,i),e.pdf_display("pdf",o,i),$("#pdf-previous").unbind(),$("#pdf-previous").click(function(){1!=i&&(i-=1,e.pdf_set_headline(t,i),e.pdf_display("pdf",o,i))}),$("#pdf-next").unbind(),$("#pdf-next").click(function(){i+=1,e.pdf_set_headline(t,i),e.pdf_display("pdf",o,i)})})},pdf_display:function(e,t,o){var i=new PDFObject({url:t+"?page="+o,id:"myPDF",pdfOpenParams:{navpanes:0,toolbar:0,statusbar:0,view:"FitB"}});i.embed(e)},pdf_set_headline:function(e,t){var o=e+" Page "+t;$(".modal-header #ops-pdf-modal-label").empty().append(o)}}),HighlightingController=Marionette.Controller.extend({initialize:function(){console.log("HighlightingController.initialize")},apply:function(e){var t=e;t||(t=".keyword");var o,i={yellow:{backgroundColor:"hsla( 60, 100%, 82%, 1)"},green:{backgroundColor:"hsla(118, 100%, 82%, 1)"},orange:{backgroundColor:"hsla( 16, 100%, 82%, 1)"},turquoise:{backgroundColor:"hsla(174, 100%, 82%, 1)"},blue:{backgroundColor:"hsla(195, 100%, 82%, 1)"},violet:{backgroundColor:"hsla(247, 100%, 82%, 1)"},magenta:{backgroundColor:"hsla(315, 100%, 82%, 1)"}},n=["yellow","green","orange","turquoise","blue","violet","magenta"];_.each(opsChooserApp.metadata.get("keywords"),function(e){if(log("keyword:",e),e){_.isEmpty(o)&&(o=n.slice(0));var r=o.shift(),a=i[r],s="highlight-"+r;$(t).highlight(e,{className:"highlight-base "+s,wholeWords:!0,minLength:3}),$("."+s).css(a)}})}}),opsChooserApp.addInitializer(function(){this.document_base=new DocumentBaseController,this.document_details=new DocumentDetailsController,this.document_carousel=new DocumentCarouselController,this.document_highlighting=new HighlightingController,this.listenTo(this,"results:ready",function(){this.document_base.setup_ui(),this.document_details.setup_ui(),this.document_carousel.setup_ui(),this.document_highlighting.apply()})}),HotkeysPlugin=Marionette.Controller.extend({initialize:function(e){console.log("HotkeysPlugin.initialize"),this.app=e.app},setup_hotkeys:function(){var e=this;$("#query").on("keydown",null,"meta+return",function(){e.app.perform_search({reviewmode:!1})}),$("#query").on("keydown",null,"ctrl+return",function(){e.app.perform_search({reviewmode:!1})}),$("#numberlist").on("keydown",null,"meta+return",function(){e.app.perform_numberlistsearch()}),$("#query").on("keydown",null,"alt+ctrl+f",function(e){e.preventDefault(),$("#cql-field-chooser").select2("open"),$("#cql-field-chooser").unbind("select2-close"),$("#cql-field-chooser").on("select2-close",function(){window.setTimeout(function(){$("#query").focus()},100)})}),$("input").on("keydown",null,"shift+return",function(e){e.preventDefault(),$(this).parent().find(".add-on.add-on-zoom").click()}),_([document,"#query","#numberlist","input"]).each(function(t){e.querybuilder_hotkeys(t)}),$(document).on("keydown",null,"+",function(){e.app.viewport.document_add_basket()}),$(document).on("keydown",null,"insert",function(){e.app.viewport.document_rate(1)}),$(document).on("keydown",null,"-",function(){e.app.viewport.document_remove_basket()}),$(document).on("keydown",null,"r",function(){e.app.viewport.document_remove_basket()}),$(document).on("keydown",null,"del",function(){e.app.viewport.document_remove_basket()}),$(document).on("keydown",null,"ctrl+d",function(){e.app.viewport.document_remove_basket()}),$(document).on("keydown",null,"0",function(){e.app.viewport.document_rate(null,!0)}),$(document).on("keydown",null,"d",function(){e.app.viewport.document_rate(null,!0)}),$(document).on("keydown",null,"1",function(){e.app.viewport.document_rate(1)}),$(document).on("keydown",null,"2",function(){e.app.viewport.document_rate(2)}),$(document).on("keydown",null,"3",function(){e.app.viewport.document_rate(3)});var t=e.app.ui.scroll_smooth;$(document).on("keydown",null,null,function(o){32!=o.keyCode||_(["input","textarea"]).contains(o.target.localName)||(o.preventDefault(),0==o.shiftKey?t(e.app.viewport.next_item()):1==o.shiftKey&&t(e.app.viewport.previous_item()))}),$(document).on("keydown",null,"pagedown",function(o){o.preventDefault(),t(e.app.viewport.next_item())}),$(document).on("keydown",null,"pageup",function(o){o.preventDefault(),t(e.app.viewport.previous_item())}),$(document).on("keydown",null,"right",function(e){e.preventDefault();var t=$(".ops-collection-entry:in-viewport").find(".document-actions .document-details-chooser").first(),o=t.find("button.active"),i=o.next("button");i.length||(i=o.siblings("button").first()),i.tab("show")}),$(document).on("keydown",null,"left",function(e){e.preventDefault();var t=$(".ops-collection-entry:in-viewport").find(".document-actions .document-details-chooser").first(),o=t.find("button.active"),i=o.prev("button");i.length||(i=o.siblings("button").last()),i.tab("show")}),$(document).on("keydown",null,"shift+right",function(e){e.preventDefault();var t=$(".ops-collection-entry:in-viewport").find(".drawings-carousel").first(),o=t.find(".carousel-control.right");o.trigger("click")}),$(document).on("keydown",null,"shift+left",function(e){e.preventDefault();var t=$(".ops-collection-entry:in-viewport").find(".drawings-carousel").first(),o=t.find(".carousel-control.left");o.trigger("click")}),$(document).on("keydown",null,"shift+p",function(e){e.preventDefault();var t=$(".ops-collection-entry:in-viewport").find("a.anchor-pdf");t[0].click()}),$(document).on("keydown",null,"shift+e",function(e){e.preventDefault();var t=$(".ops-collection-entry:in-viewport").find("a.anchor-biblio-espacenet");t[0].click()}),$(document).on("keydown",null,"shift+d",function(e){e.preventDefault();var t=$(".ops-collection-entry:in-viewport").find("a.anchor-biblio-depatisnet");t[0].click()}),$(document).on("keydown",null,"alt+shift+e",function(e){e.preventDefault(),$(".ops-collection-entry:in-viewport").find("a.anchor-register-epo")[0].click()}),$(document).on("keydown",null,"alt+shift+d",function(e){e.preventDefault(),$(".ops-collection-entry:in-viewport").find("a.anchor-register-dpma")[0].click()}),$(document).on("keydown",null,"shift+c",function(e){e.preventDefault(),$(".ops-collection-entry:in-viewport").find("a.anchor-ccd")[0].click()}),$(document).on("keydown",null,"h",function(t){t.preventDefault();var o=e.app.config.get("baseurl"),i=o+"/help";window.open(i)})},querybuilder_hotkeys:function(e){var t=this;$(e).on("keydown",null,"ctrl+shift+c",function(){$('#querybuilder-flavor-chooser button[data-value="comfort"]').tab("show")}),$(e).on("keydown",null,"ctrl+shift+x",function(){$('#querybuilder-flavor-chooser button[data-value="cql"]').tab("show")}),$(e).on("keydown",null,"ctrl+shift+n",function(){$('#querybuilder-flavor-chooser button[data-value="numberlist"]').tab("show")}),$(e).on("keydown",null,"ctrl+shift+e",function(){$('#datasource button[data-value="ops"]').button("toggle"),t.app.set_datasource("ops")}),$(e).on("keydown",null,"ctrl+shift+d",function(){$('#datasource button[data-value="depatisnet"]').button("toggle"),t.app.set_datasource("depatisnet")}),opsChooserApp.config.get("google_allowed")&&$(e).on("keydown",null,"ctrl+shift+g",function(){var e=$('#datasource button[data-value="google"]');e.show(),e.button("toggle"),t.app.set_datasource("google")}),opsChooserApp.config.get("ftpro_enabled")&&$(e).on("keydown",null,"ctrl+shift+f",function(){$('#datasource button[data-value="ftpro"]').button("toggle"),t.app.set_datasource("ftpro")}),$(e).on("keydown",null,"ctrl+shift+r",function(){t.app.basketModel.review()})},querybuilder_zoomed_hotkeys:function(e,t){$(e).unbind("keydown"),$(e).on("keydown",null,"meta+return",function(){$("#querybuilder-comfort-form").submit()}),$(e).on("keydown",null,"ctrl+return",function(){$("#querybuilder-comfort-form").submit()}),$(e).on("keydown",null,"shift+return",function(e){e.preventDefault(),opsChooserApp.queryBuilderView.comfort_form_zoomed_to_regular_data(),opsChooserApp.queryBuilderView.comfort_form_zoomed_to_regular_ui(t)})}}),opsChooserApp.addInitializer(function(){this.hotkeys=new HotkeysPlugin({app:this}),this.listenTo(this,"application:ready",function(){this.hotkeys.setup_hotkeys()})}),PermalinkPlugin=Marionette.Controller.extend({initialize:function(){console.log("PermalinkPlugin.initialize")},dataurl:function(){var e=$.Deferred();return opsChooserApp.storage.dump().then(function(t){var o=JSON.stringify(t),i=dataurl.format({data:o,mimetype:"application/json+lz-string",charset:"utf-8"});return e.resolve(i)}),e.promise()},query_parameters:function(e,t){e=e||{},t=t||window.location.href;var o={},i=$.url(t);return _(o).extend(i.param()),_(o).extend(e),o=_.objRejectEmpty(o)},query_parameters_viewstate:function(e){var t=opsChooserApp.config,o={mode:t.get("mode"),context:t.get("context"),project:t.get("project"),datasource:t.get("datasource")};_.each(o,function(e,i){t._originalAttributes[i]==e&&delete o[i]},this);var i=this.query_parameters(o,e);return i},make_uri:function(e){var t=opsChooserApp.config.get("baseurl"),o=t+"?"+jQuery.param(this.query_parameters(e));return o},make_uri_opaque:function(e){var t=$.Deferred(),o=opsChooserApp.config.get("baseurl"),i=opsChooserApp.config.get("request.host");_.string.contains(i,"patentsearch")&&(o=o.replace("patentsearch","patentview"));var n=this.query_parameters(e);return opaque_param(n).then(function(e){var i=o+"?"+e;t.resolve(i)}),t.promise()},popover_switch:function(e,t,o){o=o||{};var i=$(e).popover();if(!i.data("amended")){i.data("amended",!0);var n=o.title||i.data("content");$(e).popover("destroy"),$(e).popover({title:n,content:t,html:!0,placement:"bottom",trigger:"manual"})}},popover_toggle:function(e,t,o){o=o||{},$(e).popover("toggle");var i=$(e).popover().data("popover").$tip,n=i.hasClass("in");if(n){if(t){if(o.intro){var r=o.intro;$(i).find("#permalink-popover-intro").html(r)}$(i).find("#permalink-uri-textinput").val(t),$(i).find("#permalink-open").unbind("click"),$(i).find("#permalink-open").click(function(e){e.preventDefault(),window.open(t)}),$(i).find("#permalink-copy").unbind("click"),$(i).find("#permalink-copy").click(function(e){e.preventDefault()});var a=$(i).find("#permalink-copy")[0];_ui.copy_to_clipboard("text/plain",t,{element:a}),_ui.setup_text_tools()}$(i).find("#permalink-uri-textinput").select(),o.ttl&&$(i).find("#ttl-24").show()}},popover_get_content:function(){var e=_.template($("#permalink-popover-template").html());return e},popover_show:function(e,t,o){this.popover_switch(e,this.popover_get_content,o),this.popover_toggle(e,t,o)},liveview_with_database_params:function(){var e=$.Deferred(),t=opsChooserApp.project.get("name"),o={mode:"liveview",context:"viewer",project:t,query:void 0,datasource:"review"};return this.dataurl().then(function(t){_(o).extend({database:t}),e.resolve(o)}),e.promise()},setup_ui:function(){}}),opsChooserApp.addInitializer(function(){this.permalink=new PermalinkPlugin,this.listenTo(this,"application:ready",function(){this.permalink.setup_ui()}),this.listenTo(this,"results:ready",function(){this.permalink.setup_ui()})}),QueryModel=Backbone.Model.extend({}),ProjectModel=Backbone.RelationalModel.extend({sync:Backbone.localforage.sync("Project"),relations:[{type:Backbone.HasOne,key:"basket",relatedModel:"BasketModel",includeInJSON:Backbone.Model.prototype.idAttribute,reverseRelation:{type:Backbone.HasOne,key:"project",includeInJSON:Backbone.Model.prototype.idAttribute}}],defaults:{name:null,created:null,modified:null,queries:[]},initialize:function(){console.log("ProjectModel.initialize"),this.fetchRelated||(this.fetchRelated=this.getAsync)},record_query:function(e){var t=e.query+" ["+e.datasource+"]";console.log("ProjectModel.record_query:",t);var o=!1,i=this.get("queries");_(i).last()!=t&&(i.push(t),o=!0),o&&(this.set("queries",i),this.save())},save:function(e,t,o){return this.set("modified",now_iso()),Backbone.Model.prototype.save.call(this,e,t,o)},destroy:function(e){var t=this.get("basket");return t&&(t.get("entries").each(function(e){e&&e.destroy()}),t.destroy()),Backbone.Model.prototype.destroy.call(this,e)}}),ProjectCollection=Backbone.Collection.extend({sync:Backbone.localforage.sync("Project"),find:Backbone.localforage.find,model:ProjectModel,initialize:function(){console.log("ProjectCollection.initialize")},sortByField:function(e,t){var o=this,i=function(e,t){return e=e.get(o.sort_key),t=t.get(o.sort_key),e>t?1:t>e?-1:0},n=function(e,t){return i(t,e)};return this.comparator=i,_.str.startsWith(t,"d")&&(this.comparator=n),this.sort_key=e,this.sort(),this},get_or_create:function(e,t){var o=this,i=this.where({name:e});if(i){var n=i[0],r=$.Deferred(),a=function(){t&&t.success&&t.success(n),r.resolve(n)};if(n)console.log("ProjectModel.load"),n.fetch({success:function(){$.when(n.fetchRelated("basket")).then(a)}});else{console.log("ProjectModel.create");var s=new BasketModel;s.save(null,{success:function(){n=new ProjectModel({name:e,created:now_iso(),basket:s}),o.create(n,{success:function(){o.add(n),$.when(n.fetchRelated("basket")).then(function(){var e=n.get("basket");e.save({project:n},{success:function(){n.fetch({success:function(){$.when(n.fetchRelated("basket")).then(a)}})}})})}})}})}return r}}}),ProjectChooserView=Backbone.Marionette.ItemView.extend({template:"#project-chooser-template",initialize:function(){console.log("ProjectChooserView.initialize"),this.data_list_selector="#project-chooser-list ul",this.listenTo(this.model,"change",this.render),this.listenTo(this,"item:rendered",this.setup_ui)},onDomRefresh:function(){console.log("ProjectChooserView.onDomRefresh")},projectname_validate:function(e){if(!e)return"Project name must not be empty";var t=this.collection.where({name:e});return _.isEmpty(t)?void 0:"Project name already exists"},setup_ui:function(){console.log("ProjectChooserView.setup_ui");var e=this;$("#project-chooser-name").editable({mode:"inline",placeholder:"Enter project name",success:function(t,o){e.model.set("name",o),e.model.save()},validate:function(t){return e.projectname_validate(t)}}),this.set_name(this.model.get("name"));var t=$(this.data_list_selector),o=this.collection;t.empty(),o.sortByField("modified","desc").each(function(e){var o=e.get("name"),i=e.get("modified"),n=_.template('<li><a class="incognito" href="javascript: void(0);" data-value="<%= name %>"><%= name %> <span class="pull-right"><%= modified %></span></a></li>')({name:o,modified:moment(i).fromNow()});t.append(n)}),t.find("a").click(function(){var e=$(this).data("value");opsChooserApp.trigger("project:load",e)}),$(this.el).find("#project-delete-button").click(function(){var t=opsChooserApp.config.get("project");_ui.confirm('This will delete the current project "'+t+'". Are you sure?').then(function(){e.model.destroy({success:function(){_ui.notify('Project "'+e.model.get("name")+'" deleted.',{type:"success",icon:"icon-trash"});var t=e.collection.sortByField("modified","desc").first();if(t){var o=t.get("name");opsChooserApp.trigger("project:load",o)}else{opsChooserApp.basketModel.destroy(),delete opsChooserApp.basketModel;var o=opsChooserApp.config._originalAttributes.project;opsChooserApp.config.set("project",o),opsChooserApp.trigger("projects:initialize"),_ui.notify('Project "'+e.model.get("name")+'" deleted.<br/>Recreated default project.',{type:"success",icon:"icon-trash"})}}})})}),$(this.el).find("#project-create-button").unbind(),$(this.el).find("#project-create-button").click(function(t){t.stopPropagation(),t.preventDefault(),$(this).popover("hide");var o=$("#project-chooser-name");o.unbind();o.editable("getValue",!0);o.editable("destroy"),o.editable({mode:"inline",toggle:"manual",placeholder:"Enter project name",success:function(e,t){opsChooserApp.trigger("project:load",t),_ui.notify('Project "'+t+'" created.',{type:"success",icon:"icon-plus"})},validate:function(t){return e.projectname_validate(t)}}),o.editable("show"),o.editable("setValue",""),o.on("hidden",function(t,i){"save"!=i&&(o.editable("destroy"),e.setup_ui())
})})},set_name:function(e){e?$("#project-chooser-name").editable("setValue",e):$("#project-chooser-name").hide()},clear:function(){this.set_name(),$(this.data_list_selector).empty()}}),opsChooserApp.addInitializer(function(){this.listenTo(this,"project:load",function(e){var t;this.project&&(t=this.project.get("name"));var o=this;$.when(this.projects.get_or_create(e)).done(function(i){o.trigger("project:ready",i),e!=t&&o.trigger("project:changed",i)})}),this.listenTo(this,"projects:initialize",function(e){console.log("projects:initialize"),e||(e=this.config.get("project")),this.projects=new ProjectCollection;var t=this;this.projects.fetch({success:function(){t.trigger("project:load",e)}})}),this.LOAD_IN_PROGRESS||this.trigger("projects:initialize")}),QueryBuilderView=Backbone.Marionette.ItemView.extend({template:"#querybuilder-template",initialize:function(){console.log("QueryBuilderView.initialize"),this.config=this.templateHelpers.config=opsChooserApp.config},templateHelpers:{},onDomRefresh:function(){console.log("QueryBuilderView.onDomRefresh"),this.setup_ui_base(),this.setup_ui_actions()},setup_ui_base:function(){console.log("QueryBuilderView.setup_ui");var e=this;opsChooserApp.config.get("ftpro_enabled")&&$("#datasource > button[data-value='ftpro']").show(),$("#datasource").on("click",".btn",function(){opsChooserApp.set_datasource($(this).data("value"))}),$('#querybuilder-flavor-chooser button[data-toggle="tab"]').on("shown",function(t){var o=$(t.target).data("value");o&&(e.comfort_form_zoomed_to_regular_data(),e.cql_field_chooser_setup("cql"!=o),$(".btn-query-perform").unbind("click"),"comfort"==o?(e.comfort_form_zoomed_to_regular_ui(),$("#patentnumber").focus(),$("#querybuilder-cql-actions").hide(),$("#cql-history-chooser").hide(),$(".btn-query-perform").click(function(){$("#querybuilder-comfort-form").submit()})):"cql"==o?($("#query").focus(),$("#querybuilder-cql-actions").show(),$("#cql-history-chooser").show(),$("#cql-history-chooser").css("display","inline"),e.compute_comfort_query(),$(".btn-query-perform").click(function(){opsChooserApp.disable_reviewmode(),opsChooserApp.perform_search({reviewmode:!1,clear:!0})})):"numberlist"==o&&($("#numberlist").focus(),$("#querybuilder-cql-actions").hide(),$("#cql-history-chooser").hide(),opsChooserApp.set_datasource("ops"),$(".btn-query-perform").click(function(){opsChooserApp.disable_reviewmode(),opsChooserApp.perform_numberlistsearch({reviewmode:!1,clear:!0})})))}),$("#querybuilder-comfort-form").submit(function(t){t.preventDefault(),e.comfort_form_zoomed_to_regular_data(),e.compute_comfort_query(),opsChooserApp.disable_reviewmode(),opsChooserApp.perform_search({reviewmode:!1,clear:!0})}),$(".btn-query-perform").unbind("click"),$(".btn-query-perform").click(function(){$("#querybuilder-comfort-form").submit()}),$(".btn-full-cycle").on("click",function(){event.stopPropagation(),"button"!=$(this).attr("data-toggle")&&$(this).toggleClass("active"),opsChooserApp.config.set("mode.full-cycle",$(this).hasClass("active"))})},query_empty:function(){return _.isEmpty($("#query").val().trim())},check_query_empty:function(e){return this.query_empty()?(opsChooserApp.ui.notify("Query expression is empty",{type:"warning",icon:e.icon}),!0):!1},setup_ui_actions:function(){var e=this;$("#btn-query-clear").unbind("click"),$("#btn-query-clear").click(function(){$("#query").val("").focus()}),$("#btn-query-transform").unbind("click"),$("#btn-query-transform").click(function(){e.check_query_empty({icon:"icon-exchange"})||$("#clipboard-modifier-chooser").modal("show")}),$("#btn-query-history").unbind("click"),$("#btn-query-history").click(function(t){e.cql_history_chooser_setup();var o=$("#cql-history-chooser").hasClass("open"),i=$("#cql-history-chooser-select2");o?(t.preventDefault(),t.stopPropagation(),i.select2("open")):setTimeout(function(){i.select2("open")})}),$("#btn-query-permalink").unbind("click"),$("#btn-query-permalink").click(function(t){if(t.preventDefault(),!e.check_query_empty({icon:"icon-external-link"})){var o=this,i={mode:"liveview",context:"viewer",project:"query-permalink",query:opsChooserApp.get_query(),datasource:opsChooserApp.get_datasource()};opsChooserApp.permalink.make_uri_opaque(i).then(function(e){t.stopPropagation(),opsChooserApp.permalink.popover_show(o,e,{title:"External query review",intro:"<small>This offers a link for external/anonymous users to review the current query. </small>",ttl:!0})})}}),$(".btn-clipboard-modifier").click(function(){var e=$(this).data("modifier"),t=$("#clipboard-modifier-operator").find(".btn.active").data("value")||"OR";$("#clipboard-modifier-chooser").modal("hide");var o=$("#query").val().trim();if(!_.str.contains(o,"=")){var i=o.split("\n"),n=_(i).map(function(t){return e+'="'+t+'"'}).join(" "+t+" ");$("#query").val(n),$("#query").focus()}})},setup_quick_cql_builder:function(){$(".btn-cql-boolean").button(),$("#cql-quick-operator").find(".btn-cql-boolean").click(function(){$("#query").focus()}),$(".btn-cql-field").click(function(){var e,t=$("#query").val(),o=$("#cql-quick-operator").find(".btn-cql-boolean.active").data("value"),i=$(this).data("value"),n=$("#query").caret(),r=!1,a=!0;if(0!=n){r=!0,e=t.substring(n-1,n),"="==e&&(r=!1,a=!1);var s=t.substring(n-5,n).toLowerCase();(_.string.contains(s,"and")||_.string.contains(s,"or"))&&(r=!1)}var c=e&&" "!=e?" ":"";r&&$("#query").caret(c+o),a&&$("#query").caret((r?" ":c)+i),$("#query").focus()})},cql_field_chooser_get_data:function(e){return"ops"==e?OPS_CQL_FIELDS:"depatisnet"==e?DEPATISNET_CQL_FIELDS:[]},cql_field_chooser_setup:function(e){var t=opsChooserApp.get_datasource(),o=opsChooserApp.queryBuilderView.get_flavor();if(e||!t||_(["review","google","ftpro"]).contains(t)||"cql"!=o){var i=$("#cql-field-chooser")[0].previousSibling;return void $(i).hide()}var n=this.cql_field_chooser_get_data(t);$("#cql-field-chooser").select2({placeholder:"CQL field symbols ("+t+")",data:{results:n},dropdownCssClass:"bigdrop",escapeMarkup:function(e){return e}}),$("#cql-field-chooser").on("change",function(){var e=$(this).val();if(e){var t=$("#query").val(),o=$("#query").caret(),i=t.substring(o-1,o);"="!=i&&(" "!=i&&0!=o&&(e=" "+e),$("#query").caret(e+"="),$(this).data("select2").clear())}})},cql_history_chooser_get_data:function(){var e=opsChooserApp.project.get("queries"),t=_(e).unique().map(function(e){return{id:e,text:e}});return t},cql_history_chooser_setup:function(){var e=opsChooserApp.project.get("name"),t=this.cql_history_chooser_get_data(),o=$("#cql-history-chooser-select2");o.select2({placeholder:"CQL history ("+e+")",data:{results:t},dropdownCssClass:"bigdrop",escapeMarkup:function(e){return e}}),o.unbind("change"),o.on("change",function(){$(this).unbind("change");var e=$(this).val();if(e){var t=["ops","depatisnet","google","ftpro"];_(t).each(function(t){(_.string.endsWith(e,"["+t+"]")||_.string.endsWith(e,"("+t+")"))&&opsChooserApp.set_datasource(t),e=e.replace(" ["+t+"]","").replace(" ("+t+")","")}),$("#query").val(e)}$(this).data("select2").destroy(),$(this).dropdown().toggle()})},setup_comfort_form:function(){var e=$("#querybuilder-comfort-form"),t=opsChooserApp.get_datasource(),o=this;e.handle_enter_keypress();var i=e.find("input[name='pubdate']").closest("div[class='control-group']");_(["ops","depatisnet","ftpro"]).contains(t)?i.show():_(["google"]).contains(t)&&i.hide();var n=e.find("input[name='citation']").closest("div[class='control-group']");_(["ops","depatisnet"]).contains(t)?n.show():_(["google","ftpro"]).contains(t)&&n.hide();var r=e.find("input[name='patentnumber']");_(["google","ftpro"]).contains(t)?r.attr("placeholder",r.data("placeholder-single")):r.attr("placeholder",r.data("placeholder-multi")),_.each(e.find(".input-prepend"),function(e){$(e).find(".add-on.add-on-label").on("click",function(){var t=$(e).find("input");if(!t.val()){var o=t.attr("placeholder");t.data("demo")&&(o=t.data("demo")),t.val(o)}}),$(e).find(".add-on.add-on-zoom").on("click",function(){var t=$(e).find("input");o.comfort_form_regular_to_zoomed(t)})})},comfort_form_regular_to_zoomed:function(e){var t=e.attr("name"),o=e.val(),i=$("#querybuilder-comfort-form > fieldset");i.children(".field-regular").hide();var n=i.children("#"+t+"-zoomed");n.fadeIn();var r=n.find("textarea");r.val(o),r.focus(),opsChooserApp.hotkeys.querybuilder_zoomed_hotkeys(r,e),opsChooserApp.hotkeys.querybuilder_hotkeys(r)},comfort_form_zoomed_to_regular_data:function(){var e=$("#querybuilder-comfort-form > fieldset"),t=e.children(".field-zoomed").is(":visible");if(t){var o=e.children(".field-zoomed:visible").find("textarea"),i=o.data("name"),n=o.val();e.find('input[name="'+i+'"]').val(n)}},comfort_form_zoomed_to_regular_ui:function(e){var t=$("#querybuilder-comfort-form > fieldset");t.children(".field-zoomed").hide(),t.children(".field-regular").fadeIn(),e&&e.focus()},read_comfort_form:function(e){var t=$(e).find($("input")),o={};return _.each(t,function(e){e.value&&(o[e.name]=e.value)}),o},compute_comfort_query:function(){var e=this.read_comfort_form($("#querybuilder-comfort-form")),t=opsChooserApp.get_datasource(),o={format:"comfort",criteria:e,datasource:t};$("#keywords").val("[]"),this.compute_query_expression(o).then(function(e,t){e&&$("#query").val(e),t&&$("#keywords").val(t)})},compute_query_expression:function(e){var t=$.Deferred();return $.ajax({method:"post",url:"/api/util/query-expression",async:!1,sync:!0,data:JSON.stringify(e),contentType:"application/json; charset=utf-8"}).success(function(e,o,i){if(e){var n=i.getResponseHeader("X-Elmyra-Query-Keywords");t.resolve(e,n)}else t.resolve("","[]")}).error(function(e){opsChooserApp.ui.propagate_alerts(e.responseText),t.reject()}),t.promise()},get_flavor:function(){var e=$("#querybuilder-flavor-chooser > .btn.active").data("value");return e},set_flavor:function(e){$("#querybuilder-flavor-chooser .btn[data-value='"+e+"']").tab("show")},set_numberlist:function(e){_.isEmpty(e)||(this.set_flavor("numberlist"),$("#numberlist").html(e),opsChooserApp.perform_numberlistsearch())}}),opsChooserApp.addInitializer(function(){this.queryBuilderView=new QueryBuilderView({}),this.queryBuilderRegion.show(this.queryBuilderView),this.listenTo(this,"application:ready",function(){var e=this.config.get("numberlist");if(e){var t=decodeURIComponent(e);this.queryBuilderView.set_numberlist(t)}})}),StoragePlugin=Marionette.Controller.extend({initialize:function(){console.log("StoragePlugin.initialize"),this.database_version="0.0.1"},dump:function(){var e=this,t=$.Deferred();return localforage.keys().then(function(o){var i={},n=[];_.each(o,function(e){var t=$.Deferred();n.push(t),localforage.getItem(e).then(function(o){i[e]=o,t.resolve()})}),$.when(deferreds_bundle(n)).then(function(){var o={database:i,metadata:{type:"elmyra.ipsuite.navigator.database",description:"Database dump of Elmyra IP suite navigator",software_version:opsChooserApp.config.get("setting.app.software.version"),database_version:e.database_version,database_name:localforage.config("name"),created:timestamp(),useragent:navigator.userAgent}};t.resolve(o)})}),t.promise()},dbexport:function(){this.dump().then(function(e){var t=JSON.stringify(e,void 0,4),o="ipsuite-database_"+now_iso_filename()+".json";if(!t)return void _ui.notify("Database export failed",{type:"error",icon:"icon-save"});var i=new Blob([t],{type:"application/json"});saveAs(i,o);var n=Math.round(i.size/1e3);_ui.notify("Database exported successfully, size is "+n+"kB.",{type:"success",icon:"icon-save"})})},dbimport:function(e){log("StoragePlugin.dbimport");var t=e;if("string"==typeof e){if(_.string.startsWith(e,"data:")){var o=dataurl.parse(e);if(o&&(e=o.data),!o||!e){var i="ERROR: data URL format is invalid";return console.error(i+"; payload="+e),void _ui.notify(i,{type:"error"})}}try{t=jQuery.parseJSON(e)}catch(n){var r=n.message,i="ERROR: JSON format is invalid, "+r;return console.error(i+"; payload="+e),void _ui.notify(i,{type:"error"})}}var a=dotresolve(t,"metadata.type"),s=dotresolve(t,"database");if("elmyra.ipsuite.navigator.database"!=a||!s){var i="ERROR: Database dump format is invalid";return console.error(i),void _ui.notify(i,{type:"error"})}var c=[];_.each(_.keys(s),function(e){var t=$.Deferred();c.push(t.promise());var o=s[e];"Project"==e?localforage.getItem(e).then(function(i){i&&o&&(o=_.union(i,o)),localforage.setItem(e,o).then(function(){t.resolve()})}):localforage.setItem(e,o).then(function(){t.resolve()})}),$.when(deferreds_bundle(c)).then(function(){Backbone.Relational.store.reset(),opsChooserApp.trigger("projects:initialize"),_ui.notify("Database imported successfully",{type:"success",icon:"icon-folder-open-alt"})})},dbreset:function(e){e=e||{},e.shutdown_gui&&opsChooserApp.shutdown_gui(),Backbone.Relational.store.reset(),localforage.clear()},setup_ui:function(){console.log("StoragePlugin.setup_ui");var e=this;$("#data-export-button").unbind("click"),$("#data-export-button").on("click",function(){e.dbexport($(this).parent())}),$("#data-import-file").unbind("change"),$("#data-import-file").on("change",function(t){t.stopPropagation(),t.preventDefault(),opsChooserApp.project_deactivate();var o=this.files[0];if(o){$(this).val(void 0);var i=o.type,n=_.string.contains(navigator.userAgent,"Windows");if(n&&""==o.type&&_.string.endsWith(o.name,".json")&&(i="application/json"),"application/json"!=i){var r="ERROR: File type is "+(i?i:"unknown")+", but should be application/json";return void _ui.notify(r,{type:"error"})}var a=new FileReader;a.onload=function(t){var o=t.target.result;e.dbimport(o)},a.onerror=function(e){var t="ERROR: Could not read file "+o.name+", message="+e.getMessage();_ui.notify(t,{type:"error"})},a.readAsText(o)}}),$("#data-import-button").unbind("click"),$("#data-import-button").on("click",function(){opsChooserApp.project_deactivate(),$("#data-import-file").click()}),$("#database-wipe-button").unbind(),$("#database-wipe-button").click(function(){_ui.confirm("This will wipe the whole local database. Are you sure?").then(function(){e.dbreset({shutdown_gui:!0}),_ui.notify("Database wiped successfully. You should create a new project before starting over.",{type:"success",icon:"icon-trash"})})})}}),ViewportPlugin=Marionette.Controller.extend({initialize:function(e){console.log("ViewportPlugin.initialize"),this.app=e.app},get_document_number_in_focus:function(){var e=_.first($(".document-actions:in-viewport").closest(".ops-collection-entry")),t=$(e).data("document-number");return t},get_rating_widget:function(e){return $("#rate-patent-number-"+e)},document_add_basket:function(){var e=this.get_document_number_in_focus();e&&this.app.basketModel.add(e)},document_remove_basket:function(){var e=this.get_document_number_in_focus();e&&this.app.basketModel.remove(e)},document_rate:function(e,t){t=t||!1;var o=this.get_document_number_in_focus();return this.app.document_rate(o,e,t)},next_item:function(){var e,t=$(".ops-collection-entry:in-viewport");if(t.length){var o=$(window).scrollTop(),i=Math.floor(t.offset().top);if(i>o)e=t;else{var e=t.closest(".ops-collection-entry").last();e[0]===t[0]&&(e=$(".ops-collection-entry:below-the-fold").first())}}else e=$(".ops-collection-entry:below-the-fold").first();return e},previous_item:function(){var e,t=$(".ops-collection-entry:in-viewport");return t.length&&($(window).scrollTop()>t.offset().top?e=t:(e=t.closest(".ops-collection-entry").first(),e[0]===t[0]&&(e=$(".ops-collection-entry:above-the-top").last()),e.length||(e=$("body")))),e}}),opsChooserApp.addInitializer(function(){this.viewport=new ViewportPlugin({app:this})}),ResultCollection=Backbone.Collection.extend({initialize:function(){this.document_numbers=[]},set_reference_document_numbers:function(e){this.reference_document_numbers=e},model:function(e,t){return"ftpro"==e.upstream_provider?new FulltextProResultEntry(e,t):void console.error('Could not create result model instance for upstream provider "'+e.upstream_provider+'"')}}),DatasourceSearch=Backbone.Model.extend({keywords:[],perform:function(e,t){var o={query:e};_.extend(o,t),log("search: query_parameters:",o),opsChooserApp.ui.indicate_activity(!0);var i=this,n=t;return this.fetch({data:$.param(o),success:function(e,t,o){opsChooserApp.ui.indicate_activity(!1),opsChooserApp.ui.reset_content();var r=o.xhr.getResponseHeader("X-Elmyra-Query-Keywords");if(r&&(r=r.replace(/(.+), \[.+\]/,"$1"),i.keywords=jQuery.parseJSON(r)),_.isEmpty(i.keywords)){var a=n.keywords;a&&(a=a.replace(/(.+), \[.+\]/,"$1"),log("keywords fallback json:",a),i.keywords=jQuery.parseJSON(a),log("keywords fallback:",i.keywords))}},error:function(e,t){opsChooserApp.ui.indicate_activity(!1),opsChooserApp.ui.reset_content(),opsChooserApp.documents.reset(),opsChooserApp.ui.propagate_alerts(t.responseText)}})}}),DepatisnetSearch=DatasourceSearch.extend({url:"/api/depatisnet/published-data/search"}),DepatisConnectFulltext=Marionette.Controller.extend({initialize:function(e){log("DepatisConnectFulltext.initialize"),this.document_number=e},get_claims:function(){var e=this,t=$.Deferred(),o=_.template("/api/depatisconnect/<%= document_number %>/claims")({document_number:this.document_number});return $.ajax({url:o,async:!0}).success(function(e){if(e){var o={html:e.xml,lang:e.lang};t.resolve(o)}}).error(function(o){console.warn("Error while fetching claims from DEPATISconnect for",e.document_number,o),t.resolve({html:"No data available"})}),t.promise()},get_description:function(){var e=this,t=$.Deferred(),o=_.template("/api/depatisconnect/<%= document_number %>/description")({document_number:this.document_number});return $.ajax({url:o,async:!0}).success(function(e){if(e){var o={html:e.xml,lang:e.lang};t.resolve(o)}}).error(function(o){console.warn("Error while fetching description from DEPATISconnect for",e.document_number,o),t.resolve({html:"No data available"})}),t.promise()},get_abstract:function(e){var t=this,o=$.Deferred(),i="/api/depatisconnect/<%= document_number %>/abstract";e&&(i+="?language=<%= language %>");var n=_.template(i)({document_number:this.document_number,language:e});return $.ajax({url:n,async:!0}).success(function(e){if(e){var t={html:e.xml,lang:e.lang};o.resolve(t)}}).error(function(e){console.warn("Error while fetching description from DEPATISconnect for",t.document_number,e),o.resolve({html:"No data available"})}),o.promise()}}),FulltextProSearch=DatasourceSearch.extend({url:"/api/sip/published-data/search"}),FulltextProResultEntry=Backbone.Model.extend({defaults:{}}),GooglePatentSearch=DatasourceSearch.extend({url:"/api/google/published-data/search"}),OpsPublishedDataSearch=Backbone.Model.extend({url:"/api/ops/published-data/search",keywords:[],perform:function(e,t,o,i){log("OpsPublishedDataSearch.perform"),opsChooserApp.ui.indicate_activity(!0),$(opsChooserApp.paginationViewBottom.el).hide();var n=this;return this.fetch({data:$.param({query:o,range:i}),success:function(o,i,r){var a=r.xhr.getResponseHeader("X-Elmyra-Query-Keywords");if(a&&(a=a.replace(/(.+), \[.+\]/,"$1"),n.keywords=jQuery.parseJSON(a)),opsChooserApp.ui.indicate_activity(!1),opsChooserApp.ui.reset_content(),console.log("response data:"),console.log(i),_.isEmpty(i))return void e.reset();$(".pager-area").show();var s=i["ops:world-patent-data"]["ops:biblio-search"]["ops:search-result"],c=[];if(!_.isEmpty(s)){var l=[],u=to_list(s["exchange-documents"]);_(u).each(function(e){var t=to_list(e["exchange-document"]),o=[];if(_(t).each(function(e){o.push(new OpsExchangeDocument(e))}),_(t).each(function(e){e["bibliographic-data"]["full-cycle"]=o}),opsChooserApp.config.get("mode.full-cycle"))l=$.merge(l,t);else{var i=t[0];l.push(i)}}),c=n.make_models(l)}e.reset(c);var p=i["ops:world-patent-data"]["ops:biblio-search"],d=p["@total-result-count"],m=p["ops:range"],h=m["@begin"]+"-"+m["@end"],f=p["ops:query"].$,g=f;t.set({result_count:d,result_range:h,result_count_received:c?c.length:0,query_origin:f,query_real:g}),t.set("keywords",_.union(n.keywords,t.get("keywords")))},error:function(e,t){opsChooserApp.ui.indicate_activity(!1),opsChooserApp.ui.reset_content({documents:!0});var t=jQuery.parseJSON(t.responseText);"error"==t.status&&(_.each(t.errors,function(e){var t=_.template($("#backend-error-template").html());e.description=e.description||{},_.isString(e.description)&&(e.description={content:e.description}),_(e.description).defaults({headers:{}});var o=t(e);$("#alert-area").append(o)}),$(".very-short").shorten({showChars:0,moreText:"more",lessText:"less"}))}})},make_models:function(e){var t=[];return _(e).each(function(e){if("invalid result"==e["@status"])console.error("OPS INVALID RESULT:",e);else{var o=new OpsExchangeDocument(e);t.push(o)}}),t}}),OpsExchangeMetadata=Backbone.Model.extend({defaults:{reviewmode:!1,datasource:"ops",searchmode:null,page_size:25,result_count:null,result_range:null,result_count_received:null,query_origin:null,query_real:null,pagination_entry_count:12,pagination_pagesize_choices:[25,50,75,100],pagination_current_page:1,keywords:[],maximum_results:{ops:2e3,depatisnet:1e3,google:1e3},get_url:function(){var e=window.location.pathname+"?query="+encodeURIComponent($("#query").val())+"&pagesize="+this.page_size;return e},get_url_print:function(){return this.get_url()+"&mode=print"},get_url_pdf:function(){var e=this.get_url()+"&pdf=true";return e}},initialize:function(){var e=$.url(window.location.href),t=e.param("pagesize");t&&this.set("page_size",parseInt(t))},resetToDefaults:function(){this.set(this.defaults)},resetSomeDefaults:function(e){this.set(_(this.defaults).pick("searchmode","result_count","result_range","result_count_received","query_origin","query_real","keywords")),e&&e.clear&&this.set(_(this.defaults).pick("pagination_current_page"))}}),OpsBaseModel=Backbone.Model.extend({defaults:{get_document_id:function(e,t,o){e=e||this;var i;if(t){var n=t+"-reference";i=to_list(e[n]["document-id"])}else i=to_list(e["document-id"]);var r=_(i).find(function(e){return e["@document-id-type"]==o}),a=this.flatten_document_id(r);return a.fullnumber="epodoc"==o?a.docnumber:(a.country||"")+(a.docnumber||"")+(a.kind||""),a.isodate=this.format_date(a.date),a},get_publication_reference:function(e,t){return this.get_document_id(e,"publication",t)},get_application_reference:function(e,t){return this.get_document_id(e,"application",t)},flatten_document_id:function(e){var t={};return _(e).each(function(e,o){if("@document-id-type"==o?o="format":"doc-number"==o&&(o="docnumber"),"object"==typeof e){var i=e.$;i&&(e=i)}t[o]=e}),t},format_date:function(e){return e?moment(e,"YYYYMMDD").format("YYYY-MM-DD"):void 0}}}),OpsExchangeDocument=Backbone.Model.extend({defaults:$.extend(!1,OpsBaseModel.prototype.defaults,{selected:!1,get_patent_number:function(){return this["@country"]+this["@doc-number"]+this["@kind"]},get_document_number:function(){return this.get_patent_number()},get_publication_number:function(e){var t=this.get_publication_reference(e);return t.fullnumber},get_application_number:function(e){var t=this.get_application_reference(e);return t.fullnumber},get_full_cycle:function(){var e=[],t=this["bibliographic-data"]["full-cycle"];return _(t).each(function(t){e.push(t)}),e},get_publication_reference:function(e){return OpsBaseModel.prototype.defaults.get_publication_reference(this["bibliographic-data"],e)},get_application_reference:function(e){return OpsBaseModel.prototype.defaults.get_application_reference(this["bibliographic-data"],e)},get_title_list:function(){var e=[],t=this["bibliographic-data"]["invention-title"];return t&&(e=_.map(to_list(t),function(e){var t=e["@lang"]&&"["+e["@lang"].toUpperCase()+"] "||"";return t+e.$})),e},get_abstract_list:function(){var e=[],t=[];if(this["abstract"])var o=to_list(this["abstract"]),e=o.map(function(e){var o=to_list(e.p),i=o.map(function(e){return e.$}).join(" "),n=e["@lang"]?e["@lang"].toUpperCase():"",r=n?"["+n+"] ":"";return n&&t.push(n),r+i});var i=this["@country"];return"DE"!=i||_(t).contains("DE")||e.push('[DE] <a href="#" class="abstract-acquire" data-lang="de">OPS lacks german abstract, try to acquire from different data source.</a>'),e},get_applicants:function(e){try{var t=this["bibliographic-data"].parties.applicants}catch(o){return[]}t=t||[];var i=t.applicant,n=this.parties_to_list(i,"applicant-name");return e&&(n=this.enrich_links(n,"applicant")),n},get_inventors:function(e){try{var t=this["bibliographic-data"].parties.inventors}catch(o){return[]}t=t||[];var i=t.inventor,n=this.parties_to_list(i,"inventor-name");return e&&(n=this.enrich_links(n,"inventor")),n},parties_to_list:function(e,t){var o="0",i={};_.each(e,function(e){var n=e["@data-format"],r=e["@sequence"],a=_.string.trim(e[t].name.$,", ");i[n]=i[n]||{},i[n][r]=a,r>o&&(o=r)});var n=[];return _.each(_.range(1,parseInt(o)+1),function(e){e=e.toString();var t=i.epodoc[e],o=i.original[e],r=o;t&&(r=t.replace(/\[.+?\]/,"").trim()),n.push(r)}),n},has_ipc:function(){return Boolean(this["bibliographic-data"]["classification-ipc"])},get_ipc_list:function(e){var t=[],o=this["bibliographic-data"]["classification-ipc"];if(o){var i=to_list(o.text);t=_.map(i,function(e){return e.$})}return e&&(t=this.enrich_links(t,"ipc",quotate)),t},has_ipcr:function(){return Boolean(this["bibliographic-data"]["classifications-ipcr"])},get_ipcr_list:function(e){var t=[],o=this["bibliographic-data"]["classifications-ipcr"];if(o){var i=to_list(o["classification-ipcr"]);t=_.map(i,function(e){return e.text.$})}return t=_(t).map(function(e){return e.substring(0,15).replace(/ /g,"")}),e&&(t=this.enrich_links(t,"ipc",quotate)),t},has_cpc:function(){return Boolean(this["bibliographic-data"]["patent-classifications"])},get_cpc_list:function(e){var t=[],o=this["bibliographic-data"]["patent-classifications"],i=["section","class","subclass","main-group","/","subgroup"],n=this;if(o){var r=to_list(o["patent-classification"]);_(r).each(function(e){var o=e["classification-scheme"]["@scheme"];if("CPC"==o){var r=[];_(i).each(function(t){if("/"==t)return void r.push("/");if(e[t]){var o=e[t].$;r.push(o)}else console.error('Unknown cpc classification field "'+t+'" for document "'+n.get_document_number()+'":',e)});var a=r.join("");t.push(a)}else"FI"==o||"FTERM"==o||console.error('Unknown classification scheme "'+o+'" for document "'+n.get_document_number()+'":',e)})}return e&&(t=this.enrich_links(t,"cpc",quotate)),t},get_priority_claims:function(){var e=this,t=[],o=this["bibliographic-data"]["priority-claims"];if(o){var i=to_list(o["priority-claim"]);_(i).each(function(o){var i=e.get_document_id(o,null,"epodoc");if(!_.isEmpty(i)){var n=e.enrich_link(i.docnumber,"spr")+", "+i.isodate;t.push(n)}})}return t},has_citations:function(){return Boolean(this["bibliographic-data"]["references-cited"])},get_patent_citation_list:function(e,t){t=t||"docdb";var o=this,i=[],n=this["bibliographic-data"]["references-cited"];if(n){var r=to_list(n.citation);i=r.filter(function(e){return e.patcit}).map(function(e){var i=o.get_document_id(e.patcit,null,t),n=o.flatten_document_id(i).fullnumber;return n})}return e&&(i=this.enrich_links(i,"pn")),i},get_citing_query:function(){var e="ct="+this.get_publication_number("epodoc");return e},get_same_citations_query:function(){var e=this.get_patent_citation_list(!1,"epodoc");return this.get_items_query(e,"ct","OR")},get_all_citations_query:function(){var e=this.get_patent_citation_list(!1,"epodoc");return this.get_items_query(e,"pn","OR")},get_items_query:function(e,t,o){e=e.slice(0,10),e=e.map(function(e){return t+"="+e});var i=e.join(" "+o+" ");return i},_expand_links:function(e){var t=/(http|ftp|https):\/\/[\w-]+(\.[\w-]+)+([\w.,@?^=%&amp;:\/~+#-]*[\w@?^=%&amp;\/~+#-])?/g;return _(e.match(t)).each(function(t){e=e.replace(t,'<a href="'+t+'" target="_blank">'+t+"</a>")}),e},get_npl_citation_list:function(){var e=this,t=[],o=this["bibliographic-data"]["references-cited"];if(o){var i=to_list(o.citation);t=i.filter(function(e){return e.nplcit}).map(function(e){return e.nplcit.text.$}).map(e._expand_links)}return t},has_fulltext:function(){var e=["EP","WO","AT","CA","CH"];return e.push("DE"),e.push("US"),_(e).contains(this["@country"])},search_date:function(e){var t=null;return _.each(e,function(e){!t&&e.date&&e.date.$&&(t=e.date.$)}),t},get_publication_date:function(){return this.format_date(this.search_date(this["bibliographic-data"]["publication-reference"]["document-id"]))},get_application_date:function(){return this.format_date(this.search_date(this["bibliographic-data"]["application-reference"]["document-id"]))}}),initialize:function(){this.printmode="print"==opsChooserApp.config.get("mode")},get_document_number:function(){return this.attributes.get_patent_number()},select:function(){this.set("selected",!0)},unselect:function(){this.set("selected",!1)}}),OpsExchangeDocumentCollection=Backbone.Collection.extend({model:OpsExchangeDocument,initialize:function(){},get_document_numbers:function(){var e=[];return _.each(this.models,function(t){e.push(t.get_document_number()),_.each(t.attributes.get_full_cycle(),function(t){e.push(t.get_document_number())})}),e}}),OpsFulltext=Marionette.Controller.extend({initialize:function(e){log("OpsFulltext.initialize"),this.document_number=e},get_claims:function(){var e=this,t=$.Deferred(),o=_.template("/api/ops/<%= document_number %>/claims")({document_number:this.document_number});return $.ajax({url:o,async:!0}).success(function(e){if(e){var o=e["ops:world-patent-data"]["ftxt:fulltext-documents"]["ftxt:fulltext-document"].claims,i=_(to_list(o.claim["claim-text"])).map(function(e){return"<p>"+_(e.$).escape().replace(/\n/g,"<br/>")+"</p>"}),n=i.join("\n"),r={html:n,lang:o["@lang"]};t.resolve(r)}}).error(function(o){console.warn("Error while fetching claims from OPS for",e.document_number,o),t.resolve({html:"No data available"})}),t.promise()},get_description:function(){var e=this,t=$.Deferred(),o=_.template("/api/ops/<%= document_number %>/description")({document_number:this.document_number});return $.ajax({url:o,async:!0}).success(function(e){if(e){var o=e["ops:world-patent-data"]["ftxt:fulltext-documents"]["ftxt:fulltext-document"].description,i=_(to_list(o.p)).map(function(e){return"<p>"+_(e.$).escape().replace(/\n/g,"<br/><br/>")+"</p>"}),n=i.join("\n"),r={html:n,lang:o["@lang"]};t.resolve(r)}}).error(function(o){console.warn("Error while fetching description from OPS for",e.document_number,o),t.resolve({html:"No data available"})}),t.promise()}}),OpsFamilyMember=OpsBaseModel.extend({defaults:$.extend(!1,OpsBaseModel.prototype.defaults,{}),parse:function(e){return e["priority-claim"]=to_list(e["priority-claim"]),e}}),OpsFamilyCollection=Backbone.Collection.extend({model:OpsFamilyMember,initialize:function(e,t){this.document_number=t.document_number},url:function(){var e=_.template("/api/ops/publication/<%= document_number %>/family/inpadoc")({document_number:this.document_number});return e},parse:function(e){return to_list(e["ops:world-patent-data"]["ops:patent-family"]["ops:family-member"])}}),ResultItemView=Backbone.Marionette.ItemView.extend({tagName:"div",className:"row-fluid",serializeData:function(){var e=Backbone.Marionette.ItemView.prototype.serializeData.apply(this,arguments);return e.is_document_missing=!_(this.model.collection.reference_document_numbers).contains(this.model.get("publication_number")),e}}),ResultCollectionView=Backbone.Marionette.CompositeView.extend({tagName:"div",id:"resultcollection",className:"container",template:"#generic-collection-template",getItemView:function(e){return"ftpro"==e.get("upstream_provider")?FulltextProResultView:void console.error('Could not create result view instance for upstream provider "'+model.get("upstream_provider")+'"')},initialize:function(){console.log("ResultCollectionView.initialize")},onRender:function(){console.log("ResultCollectionView.onRender")}}),FulltextProResultView=ResultItemView.extend({template:_.template($("#ftpro-entry-template").html(),this.model,{variable:"data"}),initialize:function(){},templateHelpers:{enrich_link:function(){return opsChooserApp.document_base.enrich_link.apply(this,arguments)},is_application_number_invalid:function(){return"JP"==this.cc&&(7==this.ApplicationNumber.length||8==this.ApplicationNumber.length)
},get_linkable_application_number:function(){var e=this.cc+this.ApplicationNumber;return"JP"==this.cc&&"U"==this.kd&&this.ApplicationNumber.length<11&&(e=this.cc+this.ApplicationNumber.substring(0,4)+_.string.rjust(this.ApplicationNumber.substring(4),7,"0")+this.kd),e}}}),OpsExchangeDocumentView=Backbone.Marionette.Layout.extend({template:_.template($("#ops-entry-template").html(),this.model,{variable:"data"}),tagName:"div",className:"row-fluid",regions:{region_comment_button:"#region-comment-button",region_comment_text:"#region-comment-text"},initialize:function(){console.log("OpsExchangeDocumentView.initialize"),this.templateHelpers.config=opsChooserApp.config},templateHelpers:{get_linkmaker:function(){return new Ipsuite.LinkMaker(this)},enrich_links:function(){return opsChooserApp.document_base.enrich_links.apply(this,arguments)},enrich_link:function(){return opsChooserApp.document_base.enrich_link.apply(this,arguments)}},onDomRefresh:function(){console.log("OpsExchangeDocumentView.onDomRefresh");var e=$(this.el).find(".ops-collection-entry");$(e).prop("ops-document",this.model.attributes)},events:{"click .rank_up img":"rankUp","click .rank_down img":"rankDown","click a.disqualify":"disqualify"}}),OpsExchangeDocumentCollectionView=Backbone.Marionette.CompositeView.extend({tagName:"div",id:"opsexchangedocumentcollection",className:"container",template:"#ops-collection-template",itemView:OpsExchangeDocumentView,initialize:function(){console.log("OpsExchangeDocumentCollectionView.initialize")},_initialEvents:function(){this.collection&&this.listenTo(this.collection,"remove",this.removeItemView,this)},onRender:function(){console.log("OpsExchangeDocumentCollectionView.onRender")},onDomRefresh:function(){console.log("OpsExchangeDocumentCollectionView.onDomRefresh")}}),MetadataView=Backbone.Marionette.ItemView.extend({tagName:"div",template:_.template($("#ops-metadata-template").html(),this.model,{variable:"data"}),initialize:function(){this.templateHelpers.config=opsChooserApp.config,this.listenTo(this.model,"change",this.render),this.listenTo(this,"render",this.setup_ui)},templateHelpers:{},setup_ui:function(){log("MetadataView.setup_ui"),$('.content-chooser > button[data-toggle="tab"]').on("show",function(){var e=$(this).data("list-type");"ops"==e?opsChooserApp.listRegion.show(opsChooserApp.collectionView):"upstream"==e&&opsChooserApp.listRegion.show(opsChooserApp.resultView)})}}),OpsFamilyMemberVerboseView=Backbone.Marionette.ItemView.extend({template:_.template($("#ops-family-verbose-member-template").html(),this.model,{variable:"data"}),tagName:"tr",templateHelpers:{enrich_link:function(){return opsChooserApp.document_base.enrich_link.apply(this,arguments)}}}),OpsFamilyVerboseCollectionView=Backbone.Marionette.CompositeView.extend({template:"#ops-family-verbose-collection-template",itemView:OpsFamilyMemberVerboseView,id:"ops-family-verbose-verbose-collection",appendHtml:function(e,t){e.$("tbody").append(t.el)}}),OpsFamilyMemberCompactView=Backbone.Marionette.ItemView.extend({template:_.template($("#ops-family-compact-member-template").html(),this.model,{variable:"data"}),tagName:"tr",templateHelpers:{enrich_link:function(){return opsChooserApp.document_base.enrich_link.apply(this,arguments)}}}),OpsFamilyCompactCollectionView=Backbone.Marionette.CompositeView.extend({template:"#ops-family-compact-collection-template",itemView:OpsFamilyMemberCompactView,id:"ops-family-compact-collection",appendHtml:function(e,t){e.$("tbody").append(t.el)}}),PaginationView=Backbone.Marionette.ItemView.extend({tagName:"div",template:_.template($("#ops-pagination-template").html(),this.model),initialize:function(){console.log("PaginationView.initialize"),this.listenTo(this.model,"commit",this.render),this.listenTo(this,"item:rendered",this.setup_ui),this.templateHelpers.config=opsChooserApp.config},templateHelpers:{},getTemplate:function(){return"liveview"==opsChooserApp.config.get("mode")?"#ops-pagination-template-liveview":"subsearch"==this.model.get("searchmode")?"#ops-pagination-template":"#ops-pagination-template"},setup_ui:function(){console.log("PaginationView.setup_ui");var e=this,t=this.model.get("datasource"),o=this.model.get("pagination_pagesize_choices"),i=this.model.get("page_size"),n=this.model.get("result_count"),r=this.get_maximum_results(),a=this.model.get("result_range"),s=this.model.get("pagination_current_page");"google"==t&&null==n&&(n=1e3);var c=0;if(n>0&&i>0){var l=n/i;l>=1&&(c=Math.ceil(l)),c=_.min([c,Math.ceil(r/i)])}return 1>c?void $(".page-size-chooser").parent().remove():($(this.el).find(".jqpagination").each(function(){$(this).jqPagination(),$(this).jqPagination("destroy"),$(this).jqPagination({max_page:c,current_page:s,paged:function(t){e.model.set("pagination_current_page",t);var o=e.get_range(t);"numberlist"==opsChooserApp.queryBuilderView.get_flavor()&&1!=opsChooserApp.metadata.get("reviewmode")?opsChooserApp.perform_numberlistsearch(o):opsChooserApp.perform_search(o)}})}),$(this.el).find(".page-size-chooser ul").each(function(){$(this).empty();var e=this;_(o).map(function(t){var o="";o=t==i?'<i class="icon-check"></i>':'<i class="icon-check-empty"></i>';var n=_.template('<li><a href="" data-value="<%= entry %>"><%= icon %> <%= entry %></a></li>')({entry:t,icon:o});$(e).append(n)})}),$(this.el).find(".page-size-chooser a").click(function(t){t.preventDefault();var o=$(this).data("value");return e.model.set("page_size",o),opsChooserApp.perform_search({clear:!0}),!1}),"subsearch"==this.model.get("searchmode")&&$(this.el).find(".page-size-chooser > .dropdown-toggle").prop("disabled",!0),$(this.el).find(".pagination ul").each(function(){$(this).empty();var t=this;_.range(1,c+1).map(function(o){var i=e.get_range(o).range,n=_.template('<li><a href="" range="<%= range %>"><%= range %></a></li>')({range:i});$(t).append(n)})}),$(this.el).find(".pagination a").click(function(){var e=$(this).attr("range");return opsChooserApp.perform_search({range:e}),!1}),void $(this.el).find(".pagination").find("a").each(function(e,t){var o=$(t).attr("range");if(o==a){var i=$(t).parent();i.addClass("active")}}))},onDomRefresh:function(){console.log("PaginationView.onDomRefresh")},get_maximum_results:function(){var e=this.model.get("datasource"),t=this.model.get("maximum_results")[e]||1/0;return t},get_range:function(e){var t=this.model.get("page_size"),o=(e-1)*t+1,i=o+t-1;i=_.min([i,this.get_maximum_results()]);var n=o+"-"+i;return{range:n,range_begin:o,range_end:i,page:e}}}),function(){var e,t=this;e="undefined"!=typeof exports?exports:t.Ipsuite={};var o=e.LinkMaker=function(e){e&&(this.document=e,this.country=e["@country"],this.docnumber=e["@doc-number"],this.kind=e["@kind"]),Object.defineProperty(this,"document_number",{get:function(){return this.document.get_document_number()}})};_.extend(o.prototype,{drawing_url:function(){var e=_.template("/api/drawing/<%= document_number %>"),t=e({document_number:this.document_number});return t},fullimage_url:function(){var e=_.template("/api/ops/<%= patent_number %>/image/full"),t=e({patent_number:this.get_patent_number()});return t},universal_pdf_url:function(e){if(e)var t=_.template("/api/pdf/<%= document_id %>"),o=t({document_id:e});else var t=_.template("/api/pdf/<%= country %><%= docnumber %><%= kind %>"),o=t(this);return o},ops_pdf_url:function(){var e=_.template("/api/ops/<%= country %><%= docnumber %><%= kind %>/pdf/all"),t=e(this);return t},espacenet_pdf_url:function(){var e=_.template("http://worldwide.espacenet.com/espacenetDocument.pdf?flavour=trueFull&FT=D&CC=<%= country %>&NR=<%= docnumber %><%= kind %>&KC=<%= kind %>"),t=e(this);return t},depatisnet_pdf_url:function(){var e=_.template("https://depatisnet.dpma.de/DepatisNet/depatisnet?action=pdf&docid=<%= country %><%= docnumber %><%= kind %>"),t=e(this);return t},epo_register_url:function(){var e=this.document.get_application_reference("docdb"),t=_.template("https://register.epo.org/application?number=<%= country %><%= docnumber %>"),o=t(e);return o},inpadoc_legal_url:function(){var e=_.template("http://worldwide.espacenet.com/publicationDetails/inpadoc?FT=D&CC=<%= country %>&NR=<%= docnumber %><%= kind %>&KC=<%= kind %>"),t=e(this);return t},dpma_register_url:function(){var e=this.document.get_application_reference("docdb"),t=_.template("/office/dpma/register/application/<%= country %><%= docnumber %>?redirect=true"),o=t(e);return o},uspto_pair_url:function(){var e=_.template("http://portal.uspto.gov/pair/PublicPair"),t=e(this);return t},inpadoc_family_url:function(){var e=_.template("http://worldwide.espacenet.com/publicationDetails/inpadocPatentFamily?FT=D&CC=<%= country %>&NR=<%= docnumber %><%= kind %>&KC=<%= kind %>"),t=e(this);return t},ops_family_url:function(){var e=_.template("http://ops.epo.org/3.1/rest-services/family/publication/docdb/<%= country %>.<%= docnumber %>.<%= kind %>/biblio,legal"),t=e(this);return t},ccd_viewer_url:function(){var e=this.document.get_application_reference("epodoc"),t=_.template("http://ccd.fiveipoffices.org/CCD-2.0.4/html/viewCcd.html?num=<%= docnumber %>&type=application&format=epodoc"),o=t(e);return o},depatisnet_url:function(){var e=this.document.get_publication_reference("docdb"),t=_.template("https://depatisnet.dpma.de/DepatisNet/depatisnet?action=bibdat&docid=<%= country %><%= docnumber %><%= kind %>"),o=t(e);return o},espacenet_worldwide_url:function(){var e=this.document.get_publication_reference("docdb"),t=_.template("http://worldwide.espacenet.com/publicationDetails/biblio?DB=worldwide.espacenet.com&FT=D&CC=<%= country %>&NR=<%= docnumber %><%= kind %>&KC=<%= kind %>"),o=t(e);return o},google_url:function(){var e=this.document.get_publication_reference("docdb"),t=_.template("https://www.google.com/patents/<%= country %><%= docnumber %><%= kind %>"),o=t(e);return o},google_prior_art_url:function(){var e=this.document.get_publication_reference("docdb"),t=_.template("https://www.google.com/patents/related/<%= country %><%= docnumber %><%= kind %>"),o=t(e);return o}})}.call(this);
//# sourceMappingURL=/static/js/app.min.map