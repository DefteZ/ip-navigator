## -*- coding: utf-8 -*-
## (c) 2013,2014 Andreas Motl, Elmyra UG

## ------------------------------------------
##   ops document collection template
## ------------------------------------------
<script id="ops-collection-template" type="text/x-underscore-template">
    <!--
    <div id="ops-collection-entry" class="row"/>
    -->
</script>



## ------------------------------------------
##   ops document item template
## ------------------------------------------
<script id="ops-entry-template" type="text/x-underscore-template">

    <%text>
    <%

    // 1. log model item to assist in data exploration
    console.log(data);


    // 2.2 prepare some template variables

    var patent_number = data.get_patent_number();
    var linkmaker = data.get_linkmaker();
    var publication_date = data.get_publication_date();
    var application_date = data.get_application_date();

    var title_list = data.get_title_list();
    var abstract_list = data.get_abstract_list();

    %>
    </%text>


    <%text>
    <div class="container-fluid ops-collection-entry" data-document-number="<%= patent_number %>" style="page-break-after: always;">

        <div class="ops-collection-entry-heading row-fluid">

            <!-- patent number -->
            <div class="span3 container-fluid">
                <div class="header-compact">
                    <%= data.enrich_link(patent_number, 'pn') %>
                </div>
            </div>

            <!-- dates -->
            <div class="span3 container-fluid">
                <div class="header-biblio">
                    <span class="inid inid-tooltip" data-toggle="tooltip" title="publication date">(45)</span>&nbsp;<span><%= data.enrich_link(publication_date, 'publicationdate') %></span>
                    &nbsp;&nbsp;
                    <span class="inid inid-tooltip" data-toggle="tooltip" title="application date">(22)</span>&nbsp;&nbsp;<span class="keyword"><%= application_date %></span>
                </div>
            </div>

            <!-- actions -->
            <div class="span6 container-fluid document-actions do-not-print">

                <!-- details / fulltext -->
                <div class="span8">

                    <% if (data.has_fulltext()) { %>
                    <div class="btn-group btn-popover tabs document-details-chooser"
                         data-toggle="popover" data-trigger="hover" data-placement="top"
                         data-content="Toggle detail view"
                         >
                        <button class="btn active" data-toggle="tab"
                                href="#document-details-biblio-container-<%= patent_number %>">
                            Biblio
                        </button>
                        <button class="btn" data-toggle="tab"
                                href="#document-details-claims-container-<%= patent_number %>"
                                data-details-type="claims"
                                >
                            Claims
                        </button>
                        <button class="btn" data-toggle="tab"
                                href="#document-details-description-container-<%= patent_number %>"
                                data-details-type="description"
                                >
                            Desc
                        </button>
                    </div>
                    <% } %>

                    <span id="region-comment-button"/>

                    <!-- pdf document -->
                    <a href="<%= linkmaker.universal_pdf_url() %>" target="ipsuite-pdf"
                        class="btn btn-popover anchor-pdf" role="button"
                        data-toggle="popover" data-trigger="hover" data-placement="top"
                        data-content="PDF document"
                        >
                        <img src="/static/img/icons/pdf.svg" class="pdf-svg"/>
                    </a>

                    <!-- external links -->
                    <div class="btn-group btn-popover pull-right"
                         data-toggle="popover" data-trigger="hover" data-placement="top"
                         data-content="Show more information from various patent offices"
                         >
                        <a class="btn dropdown-toggle" data-toggle="dropdown">
                            <i class="icon-globe icon-large"></i>
                        </a>
                        <ul class="dropdown-menu">

                            <!-- bibliographic data -->
                            <li><div style="padding-left: 10px">
                                <h5><i class="icon-list"></i> &nbsp; Bibliographic data</h5>
                            </div>
                            </li>
                            <li>
                                <a href="<%= linkmaker.espacenet_worldwide_url() %>" target="_blank" class="anchor-biblio-espacenet">
                                    [BIBLIO] <%= patent_number %> @ Espacenet
                                </a>
                            </li>
                            <li>
                                <a href="<%= linkmaker.depatisnet_url() %>" target="_blank" class="anchor-biblio-depatisnet">
                                    [BIBLIO] <%= patent_number %> @ DEPATISnet
                                </a>
                            </li>
                            <li>
                                <a href="<%= linkmaker.google_url() %>" target="_blank" class="anchor-biblio-google">
                                    [BIBLIO] <%= patent_number %> @ Google Patents
                                </a>
                            </li>

                            <li class="divider"/>


                            <!-- legal status -->
                            <li><div style="padding-left: 10px">
                                <h5>ยง &nbsp; Legal information</h5>
                            </div>
                            </li>
                            <li>
                                <a href="<%= linkmaker.inpadoc_legal_url() %>" target="_blank">
                                    [LEGAL] <%= patent_number %> @ INPADOC legal status
                                </a>
                            </li>
                            <li>
                                <a href="<%= linkmaker.epo_register_url() %>" target="_blank" class="anchor-register-epo">
                                    [LEGAL] <%= patent_number %> @ European Patent Register
                                </a>
                            </li>
                            <li>
                                <a href="<%= linkmaker.dpma_register_url() %>" target="_blank" class="anchor-register-dpma">
                                    [LEGAL] <%= patent_number %> @ DPMAregister
                                </a>
                            </li>
                            <li>
                                <a href="<%= linkmaker.uspto_pair_url() %>" target="_blank">
                                    [LEGAL] USPTO PAIR
                                </a>
                            </li>
                            <li class="divider"/>


                            <!-- patent family -->
                            <li><div style="padding-left: 10px">
                                <h5><i class="icon-group"></i> &nbsp; Patent family information</h5>
                            </div>
                            </li>
                            <li>
                                <a href="<%= linkmaker.ccd_viewer_url() %>" target="_blank" class="anchor-ccd">
                                    [FAMILY] <%= patent_number %> @ CCD Viewer
                                </a>
                            </li>
                            <li>
                                <a href="<%= linkmaker.inpadoc_family_url() %>" target="_blank">
                                    [FAMILY] <%= patent_number %> @ INPADOC patent family
                                </a>
                            </li>
                            <li>
                                <a href="<%= linkmaker.ops_family_url() %>" target="_blank">
                                    [FAMILY] <%= patent_number %> @ OPS biblio,legal
                                </a>
                            </li>
                            <li class="divider"/>


                            <!-- PDF -->
                            <li><div style="padding-left: 10px">
                                <h5><img src="/static/img/icons/pdf.svg" class="pdf-svg"/> &nbsp; PDF</h5>
                            </div>
                            </li>
                            <li>
                                <a href="<%= linkmaker.ops_pdf_url() %>" target="ipsuite-pdf" class="anchor-pdf-ops">
                                    [PDF] <%= patent_number %> @ OPS
                                </a>
                            </li>
                            <li>
                                <a href="<%= linkmaker.espacenet_pdf_url() %>" target="ipsuite-pdf">
                                    [PDF] <%= patent_number %> @ Espacenet
                                </a>
                            </li>
                            <li>
                                <a href="<%= linkmaker.depatisnet_pdf_url() %>" target="ipsuite-pdf">
                                    [PDF] <%= patent_number %> @ DEPATISnet
                                </a>
                            </li>
                            <li class="divider"/>


                            <!-- Research -->
                            <li><div style="padding-left: 10px">
                                <h5><i class="icon-fullscreen"></i> &nbsp; Research</h5>
                            </div>
                            </li>
                            <li>
                                <a href="<%= linkmaker.google_prior_art_url() %>" target="_blank">
                                    [PRIOR ART] <%= patent_number %> @ Google Prior Art Finder
                                </a>
                            </li>

                        </ul>
                    </div>

                    </%text>


                </div>

                <!-- add/remove -->
                <div class="span4" style="line-height: 200%">

                    <%
                    # FIXME: use javascript-only variables, get rid of the pyramid request object
                    ship_mode = request.params.get('ship-mode', 'multi-numberlist')
                    %>

                    % if ship_mode == 'multi-numberlist':
                    <%text>
                    <span class="pull-right">
                    <a id="remove-patent-number-<%= patent_number %>" role="button" class="btn-popover incognito remove-patent-number pointer"
                       data-patent-number="<%= patent_number %>"
                       data-toggle="popover" data-trigger="hover" data-placement="top" data-content="Remove document number from collection"
                            ><i class="icon-trash icon-large"></i></a>
                    &nbsp;
                    <span
                            class="rating-widget"
                            id="rate-patent-number-<%= patent_number %>"
                            data-document-number="<%= patent_number %>"
                            style="display: inline-block;"
                            ></span>
                    </span>
                    <input type="checkbox" id="chk-patent-number-<%= patent_number %>" class="chk-patent-number hide" value="<%= patent_number %>"/>
                    <!--
                    <a id="add-patent-number-<%= patent_number %>" role="button" class="btn btn-popover add-patent-number"
                       data-patent-number="<%= patent_number %>"
                       data-toggle="popover" data-trigger="hover" data-placement="top" data-content="Add document number to collection"
                       >
                        <i class="icon-white icon-plus"></i>
                    </a>
                    -->

                    </%text>
                    % endif

                    % if ship_mode == 'single-bibdata':
                    <%text>
                    <form name="single-bibdata-<%= patent_number %>" method="post" action="<%= data.config.get('ship-url') %>" target="<%= data.config.get('ship-frame') %>" class="form-single-bibdata">
                        <input name="query" type="hidden" value="<%= $('#query').val().replace(/"/g, '&quot;') %>"/>
                        <input name="patent_number" type="hidden" value="<%= patent_number %>"/>
                        <input name="title" type="hidden" value="<%= title_list.join('\n') %>"/>
                        <input name="applicants" type="hidden" value="<%= data.get_applicants().join('\n') %>"/>
                        <input name="inventors" type="hidden" value="<%= data.get_inventors().join('\n') %>"/>
                        <input name="application_date" type="hidden" value="<%= application_date %>"/>
                        <input name="publication_date" type="hidden" value="<%= publication_date %>"/>
                        <input name="ipcs" type="hidden" value="<%= data.get_ipcr_list().join('\n') %>"/>
                        <input name="abstract" type="hidden" value="<%= abstract_list.join('\n') %>"/>
                        <!--
                        <input name="ship_action" type="submit" value="rate" class="btn"/>
                        -->
                        <button type="submit" role="button" class="btn btn-popover"
                                data-toggle="popover" data-trigger="hover" data-placement="bottom"
                                data-content="Submit details of document to origin or 3rd-party system"
                                >
                            <i class="icon-share"/>
                            Submit
                        </button>

                    </form>
                    </%text>
                    % endif

                    <%text>

                </div>

            </div>

        </div>

        <span id="region-comment-text"/>

        <div class="ops-collection-entry-inner container-fluid">

            <div class="row-fluid">
                <div class="span12 keyword">
                    <strong><%= title_list.join('<br/>') %></strong>
                </div>
            </div>

            <div class="row-fluid">
                <div class="span5">

                    <!-- first drawing only -->
                    <!--
                    <img src="<% //linkmaker.drawing_url() %>" alt="No drawing available."/>
                    -->

                    <!-- carousel for all drawings -->
                    <div id="drawings-carousel-<%= patent_number %>" class="carousel slide drawings-carousel">
                        <!--
                        <ol class="carousel-indicators">
                            <li data-target="#drawings-carousel" data-slide-to="0" class="active"></li>
                            <li data-target="#drawings-carousel" data-slide-to="1"></li>
                            <li data-target="#drawings-carousel" data-slide-to="2"></li>
                        </ol>
                        -->
                        <!-- carousel items -->
                        <div class="carousel-inner">
                            <div class="active item">
                                <img src="<%= linkmaker.drawing_url() %>" alt="No drawing available."/>
                            </div>
                        </div>
                        <!-- carousel navigation -->
                        <a class="carousel-control left do-not-print" href="#drawings-carousel-<%= patent_number %>" data-slide="prev">&lsaquo;</a>
                        <a class="carousel-control right do-not-print" href="#drawings-carousel-<%= patent_number %>" data-slide="next">&rsaquo;</a>
                    </div>

                    <div class="drawing-info span12 text-center">
                        Drawing #<span class="drawing-number">1</span><span class="drawing-totalcount"/>
                    </div>

                </div>
                <div class="span7 tab-content document-details">

                    <div id="document-details-biblio-container-<%= patent_number %>" class="tab-pane fade in active">
                    <dl class="dl-horizontal dl-horizontal-biblio">

                        <dt class="inid-tooltip" data-toggle="tooltip" title="applicants">
                            (71)
                        </dt>
                        <dd class="keyword">
                            <%= data.get_applicants(true).map(function(item) { return '<strong>' + item + '</strong>'; }).join('<br/>') || '&nbsp;' %>
                        </dd>

                        <dt class="inid-tooltip" data-toggle="tooltip" title="inventors">
                            (72)
                        </dt>
                        <dd class="keyword">
                            <%= data.get_inventors(true).map(function(item) { return '' + item + ''; }).join('<br/>') || '&nbsp;' %>
                        </dd>

                        <br/>

                        <dt class="inid-tooltip" data-toggle="tooltip" title="classifications">
                            (51)
                        </dt>
                        <dd class="dl-horizontal-inline-container">
                            <span class="clearfix"></span>
                            <dl class="dl-horizontal dl-horizontal-inline">

                                <% if (data.has_ipc()) { %>
                                <dt>
                                    IPC
                                </dt>
                                <dd class="keyword">
                                    <%= data.get_ipc_list(true).join(', ') || '&nbsp;' %>
                                </dd>
                                <% } %>

                                <% if (data.has_ipcr()) { %>
                                <dt>
                                    IPC-R
                                </dt>
                                <dd class="keyword">
                                    <%= data.get_ipcr_list(true).join(', ') || '&nbsp;' %>
                                </dd>
                                <% } %>

                                <% if (data.has_cpc()) { %>
                                <dt>
                                    CPC
                                </dt>
                                <dd class="keyword">
                                    <%= data.get_cpc_list(true).join(', ') || '&nbsp;' %>
                                </dd>
                                <% } %>

                            </dl>
                        </dd>

                        <dt class="inid-tooltip" data-toggle="tooltip" title="priority claims">
                            (31)
                        </dt>
                        <dd class="keyword">
                            <%= data.get_priority_claims(true).join('<br/>') || '&nbsp;' %>
                        </dd>

                        <br/>

                        <dt class="inid-tooltip" data-toggle="tooltip" title="abstract">
                            (57)
                        </dt>
                        <dd class="keyword">
                            <div class="abstract">
                                <%= abstract_list.join('<br/><br/>') || '&nbsp;' %>
                            </div>
                        </dd>

                        <br/>

                        <dt class="inid-tooltip" data-toggle="tooltip" title="full cycle">
                            (F)
                        </dt>
                        <dd class="keyword">
                            Full cycle:
                            <br/>
                            <% _(data.get_full_cycle()).each(function(entry) { %>

                                <%= entry.attributes.get_patent_number() %>,
                                <%= entry.attributes.get_publication_date() %>
                                <span class="inid inid-tooltip" data-toggle="tooltip" title="publication date">(45)</span>

                                &nbsp;&nbsp;

                                <!-- pdf document -->
                                <a href="<%= linkmaker.universal_pdf_url(entry.attributes.get_patent_number()) %>" target="ipsuite-pdf"
                                   class="btn btn-small btn-popover anchor-pdf do-not-print" role="button"
                                   data-toggle="popover" data-trigger="hover" data-placement="top"
                                   data-content="PDF document"
                                        >
                                    <img src="/static/img/icons/pdf.svg" class="pdf-svg"/>
                                </a>

                                <br/>

                            <% }); %>

                        </dd>

                        <br/>

                        <dt class="inid-tooltip" data-toggle="tooltip" title="references cited">
                            (56)
                        </dt>
                        <dd class="keyword">
                            <!-- citation queries -->
                            <div class="btn-group btn-popover do-not-print"
                                 data-toggle="popover" data-trigger="hover" data-placement="top"
                                 data-content="Explore citation environment"
                                 >
                                <button class="btn btn-small dropdown-toggle" data-toggle="dropdown">
                                    <i class="icon-search"></i>
                                </button>
                                <button class="btn btn-small dropdown-toggle" data-toggle="dropdown">
                                    <span class="caret"></span>
                                </button>
                                <ul class="dropdown-menu">
                                    <li>
                                        <a href="?query=<%= encodeURIComponent(data.get_citing_query()) %>" class="query-link" target="_blank">
                                            Documents which cite ct=<%= data.get_publication_number('epodoc') %>
                                        </a>
                                    </li>
                                    <% if (data.has_citations()) { %>
                                    <li>
                                        <a href="?query=<%= encodeURIComponent(data.get_same_citations_query()) %>" class="query-link" target="_blank">
                                            Documents with same citations: ct in (56)
                                        </a>
                                    </li>
                                    <li>
                                        <a href="?query=<%= encodeURIComponent(data.get_all_citations_query()) %>" class="query-link" target="_blank">
                                            All cited documents: pn in (56)
                                        </a>
                                    </li>
                                    <% } %>
                                </ul>
                            </div>
                            &nbsp;
                            <%= data.get_patent_citation_list(true).join(', ') || '&nbsp;' %>

                            <br/><br/>
                            <table class="table table-striped table-condensed">
                                <%= data.get_npl_citation_list().map(function(item) { return '<tr><td>' + item + '</td></tr>'; }).join('') %>
                            </table>
                        </dd>

                    </dl>
                    </div>

                    <div id="document-details-claims-container-<%= patent_number %>" class="tab-pane fade" style="margin-top: 1em">
                        <strong>Claims</strong> <span class="document-details-language"></span>
                        &nbsp;&nbsp;&nbsp;<i class="document-details-spinner icon-refresh icon-spin hide"></i>
                        <br/><br/>
                        <span class="document-details-content keyword"></span>
                    </div>

                    <div id="document-details-description-container-<%= patent_number %>" class="tab-pane fade" style="margin-top: 1em">
                        <strong>Description</strong> <span class="document-details-language"></span>
                        &nbsp;&nbsp;&nbsp;<i class="document-details-spinner icon-refresh icon-spin hide"></i>
                        <br/><br/>
                        <span class="document-details-content keyword"></span>
                    </div>

                    <!-- embed 3rd-party component -->
                    <div class="embed-item" data-embed-url="<%= data.config.get('embed-item-url') %>" data-document-number="<%= patent_number %>">
                    </div>

                </div>
            </div>

        </div>

    </div>
    </%text>

</script>


## ------------------------------------------
##   metadata template
## ------------------------------------------
<%text>
<script type="text/x-underscore-template" id="ops-metadata-template">
    <!--
    <div class="row-fluid" id="pagination-info">
        <div class="span12 pagination-centered">

            &nbsp;&nbsp;
            current = <span class="badge badge-info"><%= data.result_range %></span>
        </div>
    </div>
    -->

    <div class="container-fluid ops-collection-meta" id="pagination-info">

        <div class="row-fluid">

            <div class="span8">

                <!-- total result count -->
                <div class="span3">
                    Total:
                    <br/>
                    <span style="font-size: x-large" id="result-count-total"><%= data.result_count != null ? data.result_count : '--' %></span>

                    <% if (asbool(data.config.get('debug')) && data.searchmode == 'subsearch') { %>
                    <br/>
                    View:
                    <br/>
                    <span style="font-size: x-large"><%= data.result_count_received %></span>
                    <% } %>
                </div>

                <!-- current display range -->
                <div class="span3">
                    Range:
                    <br/>
                    <span style="font-size: x-large"><%= data.result_range != null ? data.result_range : '--' %></span>
                </div>

                <!-- current cql query string -->
                <div class="span6">
                    Query:
                    <br/>
                    <span style="font-size: small" class="cql-query">
                        <%
                        // HACK: workaround required, for whatever reason; WTF!?
                        var _query;
                        if (data.query_origin && data.query_origin.nodeName == 'TEXTAREA') {
                            _query = data.query_real;
                        } else {
                            _query = data.query_origin;
                        }
                        print(htmlentities(_query, 'ENT_NOQUOTES'));
                        %>
                    </span>

                    <% if (asbool(data.config.get('debug')) && (data.searchmode == 'subsearch') && data.query_real) { %>
                    <br/>
                    Query OPS:
                    <br/>
                    <span style="font-size: small" class="cql-query"><%= data.query_real %></span>
                    <% } %>

                </div>

            </div>

            <div class="span4 do-not-print non-liveview">

                <% if (data.searchmode == 'subsearch' && !data.reviewmode) { %>
                <div class="span4">

                    <div class="btn-group btn-popover tabs content-chooser"
                         data-toggle="popover" data-trigger="hover" data-placement="top"
                         data-content="Toggle result view"
                            >
                        <button class="btn active" data-toggle="tab" data-list-type="ops">
                            View
                        </button>
                        <button class="btn" data-toggle="tab" data-list-type="upstream">
                            Results
                        </button>
                    </div>

                </div>
                <% } %>

                <div class="span4 pull-right">
                    <a id="basket-add-all-documents" role="button" class="btn btn-popover"
                       data-toggle="popover" data-trigger="hover" data-placement="top" data-content="Add all documents of current result page to collection"
                       >
                        <i class="icon-white icon-plus"></i> Add all
                    </a>
                </div>

                <!-- result list actions -->
                <!-- PDF export and print view -->
                <!--
                <div class="btn-group btn-popover result-actions span5 pull-right"
                     data-toggle="popover" data-trigger="hover" data-placement="top"
                     data-content="Export results"
                        >
                    <button class="btn dropdown-toggle" data-toggle="dropdown">
                        <i class="icon-download-alt icon-large2"></i> &nbsp; Export
                    </button>
                    <button class="btn dropdown-toggle" data-toggle="dropdown">
                        <span class="caret"></span>
                    </button>
                    <ul class="dropdown-menu">
                        <li>
                            <a href="<%= data.get_url_pdf() %>" target="_blank">
                                <img src="/static/img/icons/pdf.svg" class="pdf-svg"/> PDF
                            </a>
                            <a href="<%= data.get_url_print() %>" target="_blank">
                                <i class="icon-print icon-large"></i> Print
                            </a>
                        </li>
                    </ul>
                </div>
                -->

            </div>

        </div>
    </div>

</script>
</%text>


## ------------------------------------------
##   modal dialog for viewing pdf
## ------------------------------------------
<div id="ops-pdf-modal" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="ops-pdf-modal-label" aria-hidden="true">
    <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">ร</button>
        <h3 id="ops-pdf-modal-label"></h3>
    </div>
    <div class="modal-body" id="pdf">
    </div>
    <div class="modal-footer">
        <div class="btn-group pull-left">
            <button class="btn btn-primary" id="pdf-previous">Previous</button>
            <button class="btn btn-primary" id="pdf-next">Next</button>
        </div>
        <button class="btn" data-dismiss="modal" aria-hidden="true">Close</button>
    </div>
</div>
